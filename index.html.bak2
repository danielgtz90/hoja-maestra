<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoja Maestra - Smurfit Westrock (Offline)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* CSS NATIVO (Sin librer√≠as externas para modo Offline) */
        :root {
            --sw-blue: #003366;
            --sw-yellow: #ffff00;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-800: #1f2937;
            --border-color: #000;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding-bottom: 40px;
            color: #1f2937;
            font-size: 11px;
            -webkit-font-smoothing: antialiased;
        }

        .no-print {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .btn {
            background-color: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .btn:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: scale(0.98);
        }

        /* Hoja de Papel */
        .sheet {
            background: white;
            width: 215mm;
            /* Slightly wider to accommodate dense data */
            max-width: 1250px;
            margin: 30px auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            /* Softer shadow */
            padding: 8mm;
            position: relative;
            border-radius: 4px;
        }

        .page-break {
            height: 20px;
            background: transparent;
        }

        /* Inputs */
        input[type="text"],
        textarea,
        select {
            width: 100%;
            background: transparent;
            border: 1px solid transparent;
            border-bottom: 1px dashed #d1d5db;
            padding: 4px 6px;
            font-family: inherit;
            font-size: 11px;
            color: #374151;
            min-height: 16px;
            transition: all 0.2s;
            border-radius: 4px;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-bottom: 1px solid #007aff;
            background-color: rgba(0, 122, 255, 0.05);
        }

        textarea {
            resize: none;
        }

        /* Grid System */
        .grid-12 {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 2px;
        }

        .grid-custom-header {
            display: grid;
            grid-template-columns: 2fr 6fr 2fr;
            gap: 0;
        }

        .span-1 {
            grid-column: span 1;
        }

        .span-2 {
            grid-column: span 2;
        }

        .span-3 {
            grid-column: span 3;
        }

        .span-4 {
            grid-column: span 4;
        }

        .span-5 {
            grid-column: span 5;
        }

        .span-6 {
            grid-column: span 6;
        }

        .span-7 {
            grid-column: span 7;
        }

        .span-8 {
            grid-column: span 8;
        }

        .span-12 {
            grid-column: span 12;
        }

        /* Flex Utilities */
        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-1 {
            gap: 4px;
        }

        .gap-2 {
            gap: 8px;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .font-bold {
            font-weight: bold;
        }

        .text-xs {
            font-size: 10px;
        }

        .text-xxs {
            font-size: 9px;
        }

        /* Borders & Colors */
        .border-all {
            border: 1px solid #000;
        }

        .border-b {
            border-bottom: 1px solid #000;
        }

        .border-r {
            border-right: 1px solid #000;
        }

        .bg-blue {
            background-color: var(--sw-blue);
            color: white;
        }

        .bg-yellow {
            background-color: var(--sw-yellow);
            color: black;
        }

        .bg-gray-100 {
            background-color: var(--gray-100);
        }

        .bg-gray-200 {
            background-color: var(--gray-200);
        }

        .bg-gray-dark {
            background-color: var(--gray-800);
            color: white;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8px;
        }

        th,
        td {
            border: 1px solid #9ca3af;
            padding: 0px 1px;
            text-align: center;
            line-height: 1.2;
        }

        thead {
            background-color: var(--gray-200);
        }

        /* Sections */
        .section-box {
            border: 1px solid #000;
            padding: 4px;
            position: relative;
            margin-top: 8px;
        }

        .section-title {
            position: absolute;
            top: -7px;
            left: 5px;
            background: white;
            padding: 0 4px;
            font-weight: bold;
            font-size: 11px;
            color: black;
        }

        /* Labels within sections */
        .field-label {
            font-weight: bold;
            text-align: right;
            padding-right: 4px;
            font-size: 10px;
            white-space: nowrap;
        }

        /* Uploaders */
        .upload-area {
            position: relative;
            background-color: #f9fafb;
            border: 1px dashed #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            width: 100%;
        }

        .upload-area:hover {
            background-color: #eff6ff;
            border-color: #2563eb;
        }

        .upload-area img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }

        .upload-text {
            text-align: center;
            color: #6b7280;
            pointer-events: none;
            padding: 5px;
            font-size: 10px;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        @media print {
            @page {
                margin: 0;
            }

            body {
                background: white;
                margin: 0;
                padding: 0;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                zoom: 0.99;
            }

            .sheet {
                margin: 0;
                box-shadow: none;
                width: 100%;
                max-width: none;
                padding: 25px;
                /* Margen interno aumentado para imprimir */
                page-break-after: always;
                border-radius: 0;
            }

            .no-print {
                display: none;
            }

            .page-break {
                page-break-before: always;
                height: 0;
            }

            input,
            textarea,
            select {
                border: none;
                background: transparent;
                padding: 0;
            }

            .upload-area {
                border: none;
            }

            .upload-text {
                display: none;
            }

            .upload-area img {
                display: block;
            }
        }

        /* Dashboard (Start Screen) */
        /* Dashboard (Start Screen) */
        #dashboard {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .dashboard-card {
            background: rgba(255, 255, 255, 0.85);
            padding: 50px;
            text-align: center;
            max-width: 480px;
            width: 90%;
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dashboard-btn {
            display: block;
            width: 100%;
            padding: 18px;
            margin: 15px 0;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .dashboard-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .dashboard-btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #007aff, #0056b3);
            color: white;
        }

        .btn-secondary {
            background-color: white;
            border: 1px solid #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            border-color: #007aff;
            color: #007aff;
        }

        /* Sidebar Controls */
        #sidebar {
            position: fixed;
            left: 0;
            /* Moved to Left */
            top: 0;
            height: 100vh;
            width: 50px;
            /* Collapsed width */
            background-color: #f8fafc;
            border-right: 1px solid #e2e8f0;
            /* Border on right now */
            transition: width 0.3s ease;
            z-index: 1000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            /* Shadow to right */
        }

        #sidebar:hover {
            width: 300px;
            /* Expanded width */
        }

        .sidebar-item {
            padding: 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #f1f5f9;
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar-icon {
            min-width: 20px;
            margin-right: 15px;
            text-align: center;
            font-size: 18px;
        }

        .sidebar-content {
            opacity: 0;
            transition: opacity 0.2s ease;
            flex-grow: 1;
        }

        #sidebar:hover .sidebar-content {
            opacity: 1;
        }

        .sidebar-btn-action {
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            font-size: 14px;
            color: #333;
        }

        .sidebar-btn-action:hover {
            color: var(--sw-blue);
            font-weight: bold;
        }

        .relative {
            position: relative;
        }

        .zoom-control {
            position: absolute;
            top: auto;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.6);
            padding: 4px 8px;
            border-radius: 12px;
            display: none;
            z-index: 50;
            width: max-content;
            backdrop-filter: blur(2px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: background 0.2s, opacity 0.2s;
        }

        .zoom-control:hover {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .group:hover .zoom-control,
        .zoom-control:hover {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        .zoom-control input[type="range"] {
            width: 70px;
            height: 4px;
            border-radius: 2px;
            accent-color: #007aff;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .zoom-control:hover input[type="range"] {
            opacity: 1;
        }

        /* Dragging Classes */
        .img-pan {
            cursor: grab;
            transition: transform 0.05s ease-out;
            /* Faster for drag */
            touch-action: none;
        }

        .img-pan:active {
            cursor: grabbing;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            z-index: 2100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .form-input {
            width: 100%;
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.2s;
            background: #f9fafb;
        }

        .form-input:focus {
            background: white;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            outline: none;
        }

        /* Custom Scrollbar for modal */
        .modal-card::-webkit-scrollbar {
            width: 8px;
        }

        .modal-card::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .modal-card::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .modal-card::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        @media print {

            #sidebar,
            #magic-modal {
                display: none !important;
            }
        }

        .hidden {
            display: none !important;
        }

        /* === COTIZADOR STYLES === */
        body {
            font-family: 'Inter', sans-serif;
        }


        /* NOTA: Los estilos @media print del cotizador fueron removidos porque
           ocultaban TODO el contenido (body * { visibility: hidden; }) rompiendo
           la impresi√≥n de Hoja Maestra. El cotizador es ahora un modal integrado. */


        /* violet-500 */
        .selected-machine {
            background-color: #eff6ff !important;
            /* blue-100 */
            box-shadow: 0 0 0 2px #3b82f6;
            /* blue-500 */
            transform: scale(1.02);
        }

        /* Estilos para el interruptor Toggle */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #4f46e5;
        }

        /* Estilos para detalles/resumen */
        details>summary {
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        details>summary::before {
            content: '‚ñ∫';
            margin-right: 0.5rem;
            font-size: 0.8em;
            transition: transform 0.2s ease-in-out;
        }

        details[open]>summary::before {
            transform: rotate(90deg);
        }

        /* Nuevo estilo para la m√°quina recomendada */
        .recommended-machine {
            background-color: #f0fdf4 !important;
            /* green-50 */
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3) !important;
            /* Green shadow */
            border: 2px solid #10b981 !important;
            /* Green border */
            transform: scale(1.02);
        }

        /* === COTIZADOR STYLES === */
        body {
            font-family: 'Inter', sans-serif;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #resultsContainer,
            #resultsContainer * {
                visibility: visible;
            }

            #resultsContainer {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: 1px solid #ccc;
            }

            #formContainer,
            .print-hide,
            #modalOverlay,
            #settingsModalOverlay,
            #historyModalOverlay,
            #palletizeModalOverlay,
            #boxOptionsModalOverlay {
                display: none;
            }
        }

        .invalid-input {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 2px #fecaca !important;
        }

        .rank-1 {
            border-left-color: #10b981;
        }

        /* green-500 */
        .rank-2 {
            border-left-color: #3b82f6;
        }

        /* blue-500 */
        .rank-3 {
            border-left-color: #f59e0b;
        }

        /* amber-500 */
        .rank-4 {
            border-left-color: #8b5cf6;
        }

        /* violet-500 */
        .selected-machine {
            background-color: #eff6ff !important;
            /* blue-100 */
            box-shadow: 0 0 0 2px #3b82f6;
            /* blue-500 */
            transform: scale(1.02);
        }

        /* Estilos para el interruptor Toggle */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #4f46e5;
        }

        /* Estilos para detalles/resumen */
        details>summary {
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        details>summary::before {
            content: '‚ñ∫';
            margin-right: 0.5rem;
            font-size: 0.8em;
            transition: transform 0.2s ease-in-out;
        }

        details[open]>summary::before {
            transform: rotate(90deg);
        }

        /* Nuevo estilo para la m√°quina recomendada */
        .recommended-machine {
            background-color: #f0fdf4 !important;
            /* green-50 */
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3) !important;
            /* Green shadow */
            border: 2px solid #10b981 !important;
            /* Green border */
            transform: scale(1.02);
        }
    </style>
</head>

<body>
    <!-- DASHBOARD (Visible on Load) -->
    <div id="dashboard">
        <div class="dashboard-card">
            <img src="https://www.dropbox.com/scl/fi/m2ynl5dn5raprkv4tmb1e/Logo-SmurfitWestrock.png?rlkey=iaxgatfb97h0osbqhmrpna4ne&st=0um2ym1j&raw=1"
                alt="Smurfit Westrock" style="width: 180px; margin-bottom: 20px;">

            <h2 style="color: #1f2937; margin-bottom: 40px; font-weight: 600; font-size: 24px;">Hoja Maestra</h2>

            <!-- Main Menu -->
            <div id="dash-main-menu">
                <button class="dashboard-btn btn-primary" onclick="showCreateOptions()">
                    Crear Nueva Maestra
                </button>
                <button class="dashboard-btn btn-secondary" onclick="continueMaster()">
                    Modificar Maestra Existente
                </button>
                <button class="dashboard-btn"
                    style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"
                    onclick="showCotizadorModal()">
                    Cotizar
                </button>
            </div>

            <!-- Create Options Menu (Hidden by default) -->
            <div id="dash-create-menu" class="hidden">
                <p style="margin-bottom: 20px; color: #6b7280; font-size: 16px;">¬øC√≥mo deseas iniciar?</p>

                <button class="dashboard-btn btn-primary" onclick="startNewMasterExcel()">
                    Cargar desde Excel
                </button>
                <button class="dashboard-btn btn-secondary" onclick="startNewMasterManual()">
                    Llenar Manualmente
                </button>

                <button class="dashboard-btn"
                    style="background: transparent; color: #6b7280; font-size: 14px; margin-top: 10px; box-shadow: none;"
                    onclick="showMainMenu()">
                    Cancelar
                </button>
            </div>

            <div style="margin-top: 30px; font-size: 11px; color: #999;">
                Versi√≥n 1.4 (Sidebar Controls)
            </div>
        </div>
    </div>

    <!-- SIDEBAR CONTROLS -->
    <div id="sidebar" class="no-print hidden">
        <!-- Print Button -->
        <div class="sidebar-item">
            <div class="sidebar-icon">üñ®Ô∏è</div>
            <div class="sidebar-content">
                <button onclick="window.print()" class="sidebar-btn-action">Imprimir / PDF</button>
            </div>
        </div>

        <!-- Start Screen Link -->
        <div class="sidebar-item" style="background-color: #eff6ff;">
            <div class="sidebar-icon">üè†</div>
            <div class="sidebar-content">
                <button onclick="location.reload()" class="sidebar-btn-action">Volver a Inicio</button>
            </div>
        </div>

        <!-- Excel Config -->
        <div class="sidebar-item" style="flex-direction: column; align-items: flex-start;">
            <div style="display:flex; align-items:center; width:100%; margin-bottom:5px;">
                <div class="sidebar-icon">üìä</div>
                <div class="sidebar-content" style="font-weight:bold; font-size:12px;">Base de Datos (Excel)</div>
            </div>
            <div class="sidebar-content" style="width:100%;">
                <input type="file" id="excelInput" accept=".xlsx, .xls" style="font-size: 10px; width:100%;">
                <div id="excelStatus" style="font-size: 9px; color: #666; margin-top: 2px;">Sin archivo</div>
            </div>
        </div>

        <!-- Assets Config -->
        <div class="sidebar-item" style="flex-direction: column; align-items: flex-start;">
            <div style="display:flex; align-items:center; width:100%; margin-bottom:5px;">
                <div class="sidebar-icon">üìÇ</div>
                <div class="sidebar-content" style="font-weight:bold; font-size:12px;">Activos (Im√°genes)</div>
            </div>
            <div class="sidebar-content" style="width:100%;">
                <input type="file" id="folderInput" webkitdirectory directory multiple
                    style="font-size: 10px; width:100%;">
                <div id="folderStatus" style="font-size: 9px; color: #666; margin-top: 2px;">Sin carpeta</div>
            </div>
        </div>

        <div style="margin-top:auto; padding:10px; font-size:9px; text-align:center; color:#999;">
            Auto-save ON
        </div>
    </div>
    <!-- SheetJS Library for Excel reading -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- PAGE 1 -->
    <div class="sheet">
        <!-- Main Header Border -->
        <div class="border-all mb-2">
            <!-- Top Row -->
            <div class="grid-custom-header border-b">
                <div class="border-r flex items-center justify-center text-center" style="padding: 1px;">
                    <img src="https://www.dropbox.com/scl/fi/m2ynl5dn5raprkv4tmb1e/Logo-SmurfitWestrock.png?rlkey=iaxgatfb97h0osbqhmrpna4ne&st=0um2ym1j&raw=1"
                        alt="Smurfit Westrock Logo" style="max-height: 35px; width: auto;">
                </div>
                <div class="bg-blue flex items-center justify-center border-r" style="padding: 1px;">
                    <h1 style="margin:0; letter-spacing: 1px; font-size: 14px;">HOJA MAESTRA</h1>
                </div>
                <div class="text-xs" style="padding: 1px;">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold mr-1">No. SAP:</span>
                        <input type="text" data-id="sap-1" value="# 8074576"
                            class="bg-yellow font-bold text-center border-all"
                            style="width: 70px; height: 14px; font-size: 10px;">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="mr-1">Fecha ingreso:</span>
                        <input type="text" data-id="date-1" value="26-nov-25" class="text-right"
                            style="width: 70px; height: 14px; font-size: 10px;">
                    </div>
                </div>
            </div>

            <!-- Client Info -->
            <div class="grid-12 border-b text-xs">
                <div class="span-2 bg-gray-200 py-0 px-1 font-bold border-r flex items-center">Cliente:</div>
                <div class="span-4 py-0 px-1 border-r"><input type="text" data-id="client" value="" class="font-bold">
                </div>
                <div class="span-2 bg-gray-200 py-0 px-1 font-bold border-r flex items-center">Articulo:</div>
                <div class="span-4 py-0 px-1"><input type="text" data-id="article" value="" class="font-bold"></div>
            </div>

            <!-- Metrics Grid -->
            <div class="grid-12 border-b text-center text-xs">
                <div class="span-1 border-r py-0.5 px-1">
                    <div class="font-bold text-xxs">ECT</div>
                    <input type="text" data-id="ect" value="" class="text-center font-bold text-lg">
                </div>
                <div class="span-4 border-r">
                    <div class="bg-gray-200 font-bold border-b py-0.5 px-1 text-xxs">DIMENSIONES INTERNAS DE LA CAJA
                        (mm)</div>
                    <div class="grid-12 h-full">
                        <div class="span-4 border-r py-0.5 px-1">
                            <div class="text-xxs">LARGO</div>
                            <input type="text" data-id="dim-l" value="" class="text-center font-bold">
                        </div>
                        <div class="span-4 border-r py-0.5 px-1">
                            <div class="text-xxs">ANCHO</div>
                            <input type="text" data-id="dim-w" value="" class="text-center font-bold">
                        </div>
                        <div class="span-4 py-0.5 px-1">
                            <div class="text-xxs">ALTO</div>
                            <input type="text" data-id="dim-h" value="" class="text-center font-bold">
                        </div>
                    </div>
                </div>
                <div class="span-2 border-r py-0.5 px-1">
                    <div class="font-bold text-xxs">√ÅREA TOTAL</div>
                    <div class="flex justify-center items-center">
                        <input type="text" data-id="area-total" value="" class="text-center w-12 font-bold"> M2
                    </div>
                </div>
                <div class="span-2 border-r py-0.5 px-1">
                    <div class="font-bold text-xxs">AREA EFECTIVA</div>
                    <input type="text" data-id="area-eff" value="" class="text-center font-bold">
                </div>
                <div class="span-1 border-r py-0.5 px-1">
                    <div class="font-bold text-xxs">MERMA</div>
                    <input type="text" data-id="waste" value="" class="text-center font-bold">
                </div>
                <div class="span-1 border-r py-0.5 px-1 bg-gray-100">
                    <div class="font-bold text-xxs">P. BRUTO</div>
                    <div class="flex justify-center items-center">
                        <input type="text" data-id="w-gross" value="" class="text-center font-bold w-10"> <span
                            class="text-xxs ml-1">GR</span>
                    </div>
                </div>
                <div class="span-1 py-0.5 px-1 bg-gray-100">
                    <div class="font-bold text-xxs">P. NETO</div>
                    <div class="flex justify-center items-center">
                        <input type="text" data-id="w-net" value="" class="text-center font-bold w-10"> <span
                            class="text-xxs ml-1">GR</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Split -->
        <div class="grid-12 gap-2">

            <!-- LEFT COLUMN (Technical Specs) -->
            <div class="span-6 flex flex-col">

                <!-- MATERIAL -->
                <div class="section-box">
                    <div class="section-title">MATERIAL</div>
                    <div class="grid-12 text-xs items-center gap-1 mt-1">
                        <div class="span-4 field-label">Clase Material:</div>
                        <div class="span-8"><input type="text" data-id="mat-class" value=""></div>

                        <div class="span-4 field-label">Tipo de papel:</div>
                        <div class="span-8"><input type="text" data-id="mat-paper" value=""></div>

                        <div class="span-4 field-label">Area de pieza:</div>
                        <div class="span-8"><input type="text" data-id="mat-area" value=""></div>
                    </div>

                    <div class="grid-12 text-center mt-2 border-t border-gray-300 pt-1 text-xs">
                        <div class="span-4 border-r border-gray-300">
                            <div class="font-bold text-xxs">Calibre</div>
                            <input type="text" data-id="caliper" value="" class="text-center">
                        </div>
                        <div class="span-4 border-r border-gray-300">
                            <div class="font-bold text-xxs">Gramaje</div>
                            <input type="text" data-id="gsm" value="" class="text-center">
                        </div>
                        <div class="span-4">
                            <div class="font-bold text-xxs">Flauta</div>
                            <input type="text" data-id="flute" value="" class="text-center">
                        </div>
                    </div>

                    <div class="grid-12 text-xs items-center gap-1 mt-2 border-t border-gray-300 pt-1">
                        <div class="span-4 field-label">Dim. papel (mm):</div>
                        <div class="span-8"><input type="text" data-id="paper-dim" value=""></div>

                        <div class="span-4 field-label">Ancho rollo (mm):</div>
                        <div class="span-8"><input type="text" data-id="roll-width" value=""></div>

                        <div class="span-12 grid-12 gap-1 mt-1">
                            <div class="span-4 text-center">
                                <span class="text-xxs font-bold">L. Interior</span>
                                <input type="text" data-id="l-int" value="" class="text-center">
                            </div>
                            <div class="span-4 text-center">
                                <span class="text-xxs font-bold">Medium</span>
                                <input type="text" data-id="medium" value="" class="text-center">
                            </div>
                            <div class="span-4 text-center">
                                <span class="text-xxs font-bold">L. Exterior</span>
                                <input type="text" data-id="l-ext" value="" class="text-center">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- IMPRESION -->
                <div class="section-box">
                    <div class="section-title">IMPRESI√ìN</div>
                    <div class="grid-12 text-xxs items-center gap-1" style="margin-top: 2px; margin-bottom: 2px;">
                        <div class="span-3 field-label">Impresora:</div>
                        <div class="span-4"><input type="text" data-id="printer" value="" class="border-b"
                                style="font-size: 8px;"></div>
                        <div class="span-5">
                            <span class="text-xxs font-bold">Sentido Hilo:</span>
                            <input type="text" data-id="grain-print" value="" class="inline w-12 border-b"
                                style="font-size: 8px;">
                        </div>
                    </div>

                    <table style="margin-bottom: 2px;">
                        <thead>
                            <tr>
                                <th style="width:10%">Ord</th>
                                <th>Nombre</th>
                                <th style="width:15%">ŒîŒï's</th>
                                <th style="width:25%">PMS</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td><input type="text" value="CYAN" data-id="ink1"></td>
                                <td><input type="text" value="" data-id="de1"></td>
                                <td><input type="text" value="" data-id="pms1"></td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td><input type="text" value="MAGENTA" data-id="ink2"></td>
                                <td><input type="text" value="" data-id="de2"></td>
                                <td><input type="text" value="" data-id="pms2"></td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td><input type="text" value="YELLOW" data-id="ink3"></td>
                                <td><input type="text" value="" data-id="de3"></td>
                                <td><input type="text" value="" data-id="pms3"></td>
                            </tr>
                            <tr>
                                <td>4</td>
                                <td><input type="text" value="BLACK" data-id="ink4"></td>
                                <td><input type="text" value="" data-id="de4"></td>
                                <td><input type="text" value="" data-id="pms4"></td>
                            </tr>
                            <tr>
                                <td>5</td>
                                <td><input type="text" value="" data-id="ink5"></td>
                                <td><input type="text" value="" data-id="de5"></td>
                                <td><input type="text" value="" data-id="pms5"></td>
                            </tr>
                            <tr>
                                <td>6</td>
                                <td><input type="text" value="" data-id="ink6"></td>
                                <td><input type="text" value="" data-id="de6"></td>
                                <td><input type="text" value="" data-id="pms6"></td>
                            </tr>
                            <tr>
                                <td>7</td>
                                <td><input type="text" value="" data-id="ink7"></td>
                                <td><input type="text" value="" data-id="de7"></td>
                                <td><input type="text" value="" data-id="pms7"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="grid-12 text-xxs gap-1" style="margin-top: 2px;">
                        <div class="span-2 field-label">Barniz 1:</div>
                        <div class="span-4"><input type="text" data-id="varnish1" value="BARNIZ BRILLANTE"
                                style="font-size: 8px;"></div>
                        <div class="span-2 field-label">Barniz 2:</div>
                        <div class="span-4"><input type="text" data-id="varnish2" value="" style="font-size: 8px;">
                        </div>
                    </div>
                    <div class="text-xxs" style="margin-top: 2px;">
                        <span class="font-bold">Observaciones:</span>
                        <input type="text" data-id="obs-print" value="" class="border-b" style="font-size: 8px;">
                    </div>
                </div>

                <!-- TROQUELADO -->
                <div class="section-box">
                    <div class="section-title">TROQUELADO</div>
                    <div class="flex justify-between text-xs mt-1">
                        <div><strong>Troqueladora:</strong> <input type="text" data-id="die-machine" value=""
                                class="w-24 inline border-b"></div>
                        <div><strong># Artios:</strong> <input type="text" data-id="artios" value=""
                                class="w-32 inline border-b font-bold text-lg"></div>
                    </div>

                    <div class="grid-12 text-xs mt-2 gap-1 border-t border-gray-300 pt-1">
                        <div class="span-12">
                            <div class="font-bold text-center bg-gray-100">Dimensi√≥n de la hoja (mm)</div>
                            <div class="flex justify-center gap-3 mt-1 items-center">
                                <span>Hilo: <input type="text" data-id="dim-grain" value=""
                                        class="w-10 inline text-center border-b"></span>
                                <span>Contra: <input type="text" data-id="dim-cross" value=""
                                        class="w-10 inline text-center border-b"></span>
                                <span class="border-l border-gray-300 pl-3"><strong>Piezas/Hoja:</strong> <input
                                        type="text" data-id="pcs-sheet" value=""
                                        class="w-12 inline text-center border-b font-bold text-lg"></span>
                            </div>
                        </div>
                    </div>

                    <div class="grid-12 text-xxs mt-1 gap-1">
                        <div class="span-4">
                            <div class="flex mb-1"><span class="w-16">Cinta Ref:</span> <input type="text"
                                    data-id="tape" value="" class="border-b"></div>
                        </div>
                        <div class="span-4">
                            <div class="flex mb-1"><span class="w-16">Grosor:</span> <input type="text"
                                    data-id="thickness" value="" class="border-b"></div>
                        </div>
                        <div class="span-4">
                            <div class="flex"><span class="w-16">Troquelado:</span> <input type="text"
                                    data-id="die-type" value="INTERNO" class="border-b"></div>
                        </div>
                    </div>

                    <div class="grid-12 text-xxs mt-2 border-t border-gray-300 pt-1">
                        <div class="span-12 font-bold bg-gray-100 pl-1">Gap de imposici√≥n</div>
                        <div class="span-6">Horizontal: <input type="text" data-id="gap-h" value="0"
                                class="w-8 inline text-center"> mm</div>
                        <div class="span-6">Vertical: <input type="text" data-id="gap-v" value="0"
                                class="w-8 inline text-center"> mm</div>
                    </div>

                    <div class="grid-12 text-xxs mt-2 border-t border-gray-300 pt-1">
                        <div class="span-12 font-bold bg-gray-100 pl-1">Pinza Troquel</div>
                        <div class="span-4">Pinza: <input type="text" data-id="grip" value=""
                                class="w-6 inline text-center"></div>
                        <div class="span-4">Contra: <input type="text" data-id="grip-back" value=""
                                class="w-6 inline text-center"></div>
                        <div class="span-4">Escuadras: <input type="text" data-id="squares" value=""
                                class="w-6 inline text-center"></div>
                    </div>
                    <div class="text-xs mt-1">
                        <span class="font-bold">Obs:</span>
                        <input type="text" data-id="obs-die" value="" class="border-b">
                    </div>
                </div>

                <!-- PEGADO -->
                <div class="section-box">
                    <div class="section-title">PEGADO</div>
                    <div class="grid-12 text-xs gap-1 mt-1">
                        <div class="span-6 field-label">Pegadora:</div>
                        <div class="span-6"><input type="text" data-id="gluer" value=""></div>

                        <div class="span-6 field-label">Tipo de pegado:</div>
                        <div class="span-6"><input type="text" data-id="glue-type" value=""></div>

                        <div class="span-6 field-label">Adhesivo:</div>
                        <div class="span-6"><input type="text" data-id="glue-name" value=""></div>
                    </div>
                    <div class="text-xs mt-1">
                        <span class="font-bold">Obs:</span>
                        <input type="text" data-id="obs-glue" value="" class="border-b">
                    </div>
                </div>

            </div>

            <!-- RIGHT COLUMN (Visuals) -->
            <div class="span-6 flex flex-col gap-1 h-full">

                <!-- 1. Print Visual Image -->
                <div class="border-all relative group"
                    style="flex: 1; min-height: 150px; max-height: 250px; overflow: hidden; padding: 2px; display: flex; flex-direction: column;">
                    <div class="bg-blue text-white text-xxs px-1 py-0.5 absolute top-0 left-0 z-10 font-bold">1. VISUAL
                        IMPRESI√ìN</div>

                    <!-- Zoom Control -->
                    <div class="zoom-control no-print">
                        <input type="range" min="0.5" max="3" step="0.1" value="1"
                            oninput="updateImageScale(this, 'img-print')" title="Zoom">
                    </div>

                    <label class="upload-area w-full h-full"
                        style="flex: 1; display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden;">
                        <input type="file" accept="image/*" onchange="handleImage(this, 'img-print')">
                        <img id="img-print" alt="Visual Impresi√≥n"
                            style="max-height: 100%; max-width: 100%; object-fit: contain; transition: transform 0.1s;">
                        <div class="upload-text text-xxs">
                            <span class="text-xl">üñºÔ∏è</span><br>Arte / Impresi√≥n
                        </div>
                    </label>
                </div>

                <!-- 2. Barcode & Grain (Compact) -->
                <div class="border-all flex gap-2 items-center p-1 relative group" style="height: 270px;">
                    <div class="bg-blue text-white text-xxs px-1 py-0.5 absolute top-0 left-0 z-10 font-bold">2. C√ìDIGO
                    </div>

                    <!-- Barcode -->
                    <div
                        style="flex: 2; height: 100%; display: flex; flex-direction: column; padding-top: 15px; position: relative;">
                        <!-- Zoom Control -->
                        <div class="zoom-control no-print">
                            <input type="range" min="0.5" max="3" step="0.1" value="1"
                                oninput="updateImageScale(this, 'img-barcode')" title="Zoom">
                        </div>

                        <label class="upload-area"
                            style="flex: 1; display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden;">
                            <input type="file" accept="image/*" onchange="handleImage(this, 'img-barcode')">
                            <img id="img-barcode" alt="Codigo"
                                style="max-height: 100%; max-width: 100%; object-fit: contain; transition: transform 0.1s;">
                            <div class="upload-text text-xxs">
                                ||||||<br>Subir
                            </div>
                        </label>
                        <input type="text" data-id="barcode-text"
                            class="text-center font-mono text-xxs border-none w-full" placeholder="123456789">
                    </div>

                    <!-- Grain -->
                    <div
                        style="flex: 1; border-left: 1px dashed #ccc; padding-left: 5px; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <div class="text-xxs font-bold text-center">HILO</div>
                        <input type="text" data-id="grain-dir-visual" value="VERTICAL"
                            class="text-center font-bold text-xs border-b w-full"
                            oninput="updateGrainArrow(this.value)">
                        <div id="grain-arrow" style="font-size: 20px; line-height: 1;">‚Üï</div>
                    </div>
                </div>

                <!-- 3. Structure (Die-Line) -->
                <div class="border-all relative group"
                    style="flex: 1; min-height: 150px; max-height: 250px; overflow: hidden; padding: 2px; display: flex; flex-direction: column;">
                    <div class="bg-blue text-white text-xxs px-1 py-0.5 absolute top-0 left-0 z-10 font-bold">3.
                        ESTRUCTURA (Plano Mec√°nico)</div>

                    <!-- Zoom Control -->
                    <div class="zoom-control no-print">
                        <input type="range" min="0.5" max="3" step="0.1" value="1"
                            oninput="updateImageScale(this, 'img-flat')" title="Zoom">
                    </div>

                    <label class="upload-area w-full h-full"
                        style="flex: 1; display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden;">
                        <input type="file" accept="image/*" onchange="handleImage(this, 'img-flat')">
                        <img id="img-flat" alt="Estructura"
                            style="max-height: 100%; max-width: 100%; object-fit: contain; transition: transform 0.1s;">
                        <div class="upload-text text-xxs">
                            <span class="text-xl">üìê</span><br>Plano Mec√°nico
                        </div>
                    </label>
                </div>

                <!-- 4. Individual Piece (New) -->
                <div class="border-all relative group"
                    style="flex: 1; min-height: 150px; max-height: 250px; overflow: hidden; padding: 2px; display: flex; flex-direction: column;">
                    <div class="bg-blue text-white text-xxs px-1 py-0.5 absolute top-0 left-0 z-10 font-bold">4. PIEZA
                        INDIVIDUAL</div>

                    <!-- Zoom Control -->
                    <div class="zoom-control no-print">
                        <input type="range" min="0.5" max="3" step="0.1" value="1"
                            oninput="updateImageScale(this, 'img-piece')" title="Zoom">
                    </div>

                    <label class="upload-area w-full h-full"
                        style="flex: 1; display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden;">
                        <input type="file" accept="image/*" onchange="handleImage(this, 'img-piece')">
                        <img id="img-piece" alt="Pieza Individual"
                            style="max-height: 100%; max-width: 100%; object-fit: contain; transition: transform 0.1s;">
                        <div class="upload-text text-xxs">
                            <span class="text-xl">üì¶</span><br>Pieza Individual
                        </div>
                    </label>
                </div>

            </div>
        </div>
    </div>

    <div class="page-break"></div>

    <!-- PAGE 2 -->
    <div class="sheet">
        <div class="bg-blue p-2 mb-4 flex justify-between items-center text-white">
            <h2 class="text-lg font-bold" style="margin:0;">ESPECIFICACIONES DE EMPAQUE Y PALETIZADO</h2>
            <div class="text-sm">Ref: <span id="ref-sap-2"></span></div>
        </div>

        <div class="grid-12 gap-4">
            <!-- Left Column P2 -->
            <div class="span-6 flex flex-col gap-4">
                <!-- EMPAQUE COLECTIVO -->
                <div>
                    <div class="bg-gray-dark p-1 font-bold text-center text-sm">EMPAQUE COLECTIVO</div>
                    <div class="bg-gray-200 border-all p-2 text-xs" style="border-width: 2px;">
                        <div class="grid-12 gap-2 mb-2 items-center">
                            <div class="span-5 text-right font-bold">Tipo Empaque:</div>
                            <div class="span-7"><input type="text" data-id="pack-type" value="HSC"
                                    class="border-b border-gray-400"></div>
                            <div class="span-5 text-right font-bold">Flauta:</div>
                            <div class="span-7"><input type="text" data-id="pack-flute" value=""
                                    class="border-b border-gray-400"></div>
                            <div class="span-5 text-right font-bold">Resistencia:</div>
                            <div class="span-7"><input type="text" data-id="pack-ect" value=""
                                    class="border-b border-gray-400"></div>
                        </div>

                        <div class="bg-gray-200 border-all border-gray-400 font-bold text-center py-1 mt-2">Dimensiones
                            internas del empaque colectivo</div>
                        <div class="grid-12 text-center mt-1">
                            <div class="span-4 border-all border-gray-400 p-1 bg-white mx-1">
                                <span class="text-xxs text-gray-500 block">Largo</span>
                                <input type="text" data-id="pack-l" value="" class="text-center font-bold">
                            </div>
                            <div class="span-4 border-all border-gray-400 p-1 bg-white mx-1">
                                <span class="text-xxs text-gray-500 block">Ancho</span>
                                <input type="text" data-id="pack-w" value="" class="text-center font-bold">
                            </div>
                            <div class="span-4 border-all border-gray-400 p-1 bg-white mx-1">
                                <span class="text-xxs text-gray-500 block">Alto</span>
                                <input type="text" data-id="pack-h" value="" class="text-center font-bold">
                            </div>
                        </div>

                        <div class="mt-4 space-y-1">
                            <div class="flex justify-between border-b border-gray-400 pb-1"><span>Piezas por
                                    paquete:</span> <input type="text" data-id="pcs-pack" value=""
                                    class="text-right font-bold w-12"></div>
                            <div class="flex justify-between border-b border-gray-400 pb-1"><span>Paquetes por
                                    cama:</span> <input type="text" data-id="packs-layer" value=""
                                    class="text-right font-bold w-12"></div>
                            <div class="flex justify-between border-b border-gray-400 pb-1"><span>Camas por
                                    pallet:</span> <input type="text" data-id="layers-pallet" value=""
                                    class="text-right font-bold w-12"></div>
                            <div class="flex justify-between items-center bg-white border-all p-1 mt-1">
                                <span class="font-bold">Piezas por pallet:</span> <input type="text" data-id="total-pcs"
                                    value="" class="text-right font-bold w-20 text-lg text-red-600" style="color:red;">
                            </div>
                        </div>

                        <div class="mt-3 grid-12 gap-1 text-xxs">
                            <div class="span-6"><strong>Tipo Tarima:</strong> <input type="text" value="MADERA"
                                    class="border-b w-full"></div>
                            <div class="span-6"><strong>Medida:</strong> <input type="text" value="40'' X 48''"
                                    class="border-b w-full"></div>
                            <div class="span-6"><strong>Amarres:</strong> <input type="text" value="PAD"
                                    class="border-b w-full"></div>
                            <div class="span-6"><strong>Bandera:</strong> <input type="text" value="SI"
                                    class="border-b w-full"></div>
                            <div class="span-6"><strong>Esquineros:</strong> <input type="text" value="SI"
                                    class="border-b w-full"></div>
                            <div class="span-6"><strong>Vueltas:</strong> <input type="text" value="3"
                                    class="border-b w-full"></div>
                        </div>

                        <div class="mt-2 text-xs border-all p-1 bg-white">
                            <div class="font-bold underline mb-1">Instrucciones de Empaque:</div>
                            <textarea data-id="pack-instr" class="w-full" rows="6" style="height: 80px;"></textarea>
                        </div>
                    </div>
                </div>

                <!-- EMBARQUES -->
                <div>
                    <div class="bg-gray-dark p-1 font-bold text-center text-sm">EMBARQUES</div>
                    <div class="bg-gray-200 border-all p-2 text-xs" style="border-width: 2px;">
                        <div class="flex justify-between border-b border-white pb-1"><span>Piezas por Contenedor:</span>
                            <input type="text" data-id="pcs-cont" value="" class="text-right font-bold w-24">
                        </div>
                        <div class="flex justify-between border-b border-white pb-1"><span>Pallets por
                                contenedor:</span> <input type="text" data-id="pallets-cont" value=""
                                class="text-right font-bold w-24"></div>
                        <div class="flex justify-between border-b border-white pb-1"><span>Tama√±o del contenedor:</span>
                            <input type="text" data-id="size-cont" value='53"' class="text-right font-bold w-24">
                        </div>

                        <div class="mt-2">
                            <span class="font-bold">Instrucciones de Embarque:</span>
                            <div class="relative group" style="height: 100px; display: flex; flex-direction: column;">
                                <!-- Zoom Control -->
                                <div class="zoom-control no-print">
                                    <input type="range" min="0.5" max="3" step="0.1" value="1"
                                        oninput="updateImageScale(this, 'img-ship')" title="Zoom">
                                </div>
                                <label class="upload-area bg-white border-all mt-1 w-full h-full"
                                    style="flex: 1; display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden;">
                                    <input type="file" accept="image/*" onchange="handleImage(this, 'img-ship')">
                                    <img id="img-ship" alt="Diagrama Embarque"
                                        style="max-height: 100%; max-width: 100%; object-fit: contain; transition: transform 0.1s;">
                                    <div class="upload-text text-xs">
                                        <svg width="20" height="20" fill="#9ca3af" viewBox="0 0 16 16">
                                            <path
                                                d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5v-7zm1.294 7.456A1.999 1.999 0 0 1 4.732 11h5.536a2.01 2.01 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456zM12 10a2 2 0 0 1 1.732 1h.768a.5.5 0 0 0 .5-.5V8.35a.5.5 0 0 0-.11-.312l-1.48-1.85A.5.5 0 0 0 13.02 6H12v4zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm9 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z" />
                                        </svg>
                                        <br>Cargar Diagrama (Ej: DOBLE)
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column P2 -->
            <div class="span-6 flex flex-col gap-4">
                <!-- Pallet Image 1 -->
                <div class="flex-col border-all p-1 relative group" style="border-style: dashed; display: flex;">
                    <div class="bg-yellow text-center font-bold text-xs p-1 mb-1">EJEMPLO DE COLOCACI√ìN DE CAPUCHON
                        ARMADO HACIA ABAJO</div>

                    <!-- Zoom Control -->
                    <div class="zoom-control no-print">
                        <input type="range" min="0.5" max="3" step="0.1" value="1"
                            oninput="updateImageScale(this, 'img-pallet1')" title="Zoom">
                    </div>

                    <label class="upload-area"
                        style="height: 200px; display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden;">
                        <input type="file" accept="image/*" onchange="handleImage(this, 'img-pallet1')">
                        <img id="img-pallet1" alt="Pallet Capuchon"
                            style="max-height: 100%; max-width: 100%; object-fit: contain; transition: transform 0.1s;">
                        <div class="upload-text">
                            <svg width="30" height="30" fill="#9ca3af" viewBox="0 0 16 16">
                                <path
                                    d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.404.961L10.404 2l-2.218-.887zm3.564 1.426L5.596 5 8 5.961 14.154 3.5l-2.404-.961zm3.25 1.7-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z" />
                            </svg>
                            <br>Cargar imagen Capuch√≥n
                        </div>
                    </label>
                </div>

                <!-- Pallet Image 2 -->
                <div class="flex-col border-all p-1 relative group" style="border-style: dashed; display: flex;">
                    <div class="bg-yellow text-center font-bold text-xs p-1 mb-1">DETALLE DE EMPAQUE EN COLECTIVA</div>

                    <!-- Zoom Control -->
                    <div class="zoom-control no-print">
                        <input type="range" min="0.5" max="3" step="0.1" value="1"
                            oninput="updateImageScale(this, 'img-pallet2')" title="Zoom">
                    </div>

                    <label class="upload-area"
                        style="height: 200px; display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden;">
                        <input type="file" accept="image/*" onchange="handleImage(this, 'img-pallet2')">
                        <img id="img-pallet2" alt="Detalle Interno"
                            style="max-height: 100%; max-width: 100%; object-fit: contain; transition: transform 0.1s;">
                        <div class="upload-text">
                            <svg width="30" height="30" fill="#9ca3af" viewBox="0 0 16 16">
                                <path
                                    d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v1h14V4a1 1 0 0 0-1-1H2zm13 4H1v5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V7z" />
                            </svg>
                            <br>Cargar detalle interno
                        </div>
                    </label>
                </div>

                <!-- External Dims Diagram (New based on PDF) -->
                <div class="flex-col border-all p-1 bg-yellow relative group" style="display: flex;">
                    <div class="text-center font-bold text-xs p-1">MEDIDAS EXTERNAS DE COLECTIVA</div>

                    <!-- Zoom Control -->
                    <div class="zoom-control no-print">
                        <input type="range" min="0.5" max="3" step="0.1" value="1"
                            oninput="updateImageScale(this, 'img-ext-dims')" title="Zoom">
                    </div>

                    <label class="upload-area bg-white"
                        style="height: 120px; display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden;">
                        <input type="file" accept="image/*" onchange="handleImage(this, 'img-ext-dims')">
                        <img id="img-ext-dims" alt="Medidas Externas"
                            style="max-height: 100%; max-width: 100%; object-fit: contain; transition: transform 0.1s;">
                        <div class="upload-text">
                            <br>Cargar diagrama Medidas Externas
                        </div>
                    </label>
                </div>

                <div class="text-right font-bold text-xs mt-1">54 PALLETS</div>
                <div class="border-all relative group" style="height: 100px; display: flex; flex-direction: column;">
                    <!-- Zoom Control -->
                    <div class="zoom-control no-print">
                        <input type="range" min="0.5" max="3" step="0.1" value="1"
                            oninput="updateImageScale(this, 'img-pallet-layout')" title="Zoom">
                    </div>
                    <!-- Pallet Layout Diagram (Bottom Right of PDF) -->
                    <label class="upload-area h-full w-full border-none"
                        style="flex: 1; display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden;">
                        <input type="file" accept="image/*" onchange="handleImage(this, 'img-pallet-layout')">
                        <img id="img-pallet-layout" alt="Layout Pallets"
                            style="max-height: 100%; max-width: 100%; object-fit: contain; transition: transform 0.1s;">
                        <div class="upload-text">Cargar Diagrama de Estiba (Pallet Layout)</div>
                    </label>
                </div>

                <table class="border-all mt-2" style="border-width: 2px;">
                    <thead>
                        <tr>
                            <th>SAP</th>
                            <th>DESCRIPCION</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" data-id="sap-row1" value="8077153" class="text-center"></td>
                            <td><input type="text" data-id="desc-row1" value="COLECTIVA" class="text-center"></td>
                        </tr>
                        <tr>
                            <td><input type="text" data-id="sap-row2" value="8056134" class="text-center"></td>
                            <td><input type="text" data-id="desc-row2" value="CAPUCHON" class="text-center"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="text-right text-xs text-gray-500 mt-2">F-02-DDE-Y-03 Ver:01 Edici√≥n 01</div>
    </div>

    <!-- Script de l√≥gica (Offline & Persistencia) -->
    <script>
        // --- 1. Manejo de Im√°genes (Zoom & Pan) ---
        let draggedImg = null;
        let startX, startY;
        let initialX, initialY;

        function updateImageScale(input, imgId) {
            const img = document.getElementById(imgId);
            if (img) {
                const scale = parseFloat(input.value);
                img.dataset.scale = scale;
                updateTransform(img);

                // Add grabbing cursor if zoomed
                if (scale > 1) {
                    img.classList.add('img-pan');
                } else {
                    img.classList.remove('img-pan');
                    // Reset position if scaled back to 1 (optional, but cleaner)
                    if (scale === 1) {
                        img.dataset.x = 0;
                        img.dataset.y = 0;
                        updateTransform(img);
                    }
                }
            }
        }

        function updateTransform(img) {
            const scale = img.dataset.scale || 1;
            const x = img.dataset.x || 0;
            const y = img.dataset.y || 0;
            img.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
        }

        function startDrag(e) {
            if (e.target.tagName !== 'IMG') return;
            const img = e.target;
            // Allow drag even if scale is 1, user might want to adjust fit
            // if ((img.dataset.scale || 1) <= 1) return; 

            e.preventDefault(); // Prevent default drag behavior
            draggedImg = img;

            // Handle touch or mouse
            const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);

            startX = clientX;
            startY = clientY;
            initialX = parseFloat(img.dataset.x) || 0;
            initialY = parseFloat(img.dataset.y) || 0;

            img.style.cursor = 'grabbing';
        }

        function drag(e) {
            if (!draggedImg) return;
            e.preventDefault();

            const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);

            const dx = clientX - startX;
            const dy = clientY - startY;

            // Update position
            const currentScale = parseFloat(draggedImg.dataset.scale) || 1;
            // Adjust movement by scale? No, translate is pre-scale usually in Matrix, but here it's simple translate.
            // visual movement = translate. 
            draggedImg.dataset.x = initialX + dx;
            draggedImg.dataset.y = initialY + dy;

            updateTransform(draggedImg);
        }

        function endDrag() {
            if (draggedImg) {
                draggedImg.style.cursor = 'grab';
                draggedImg = null;
            }
        }

        // Global listeners
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('touchend', endDrag);

        // Prevent file upload when dragging
        document.addEventListener('click', function (e) {
            if (e.target.closest('.upload-area')) {
                // Check if we just finished a drag
                if (draggedImg || (e.target.tagName === 'IMG' && e.target.closest('.img-pan') && e.target.dataset.wasDragging === 'true')) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Reset flag
                    if (e.target.tagName === 'IMG') e.target.dataset.wasDragging = 'false';
                    return false;
                }
            }
        }, true); // Capture phase

        function startDrag(e) {
            if (e.target.tagName !== 'IMG') return;
            const img = e.target;

            // Only start drag if scale > 1
            if ((parseFloat(img.dataset.scale) || 1) <= 1) return;

            e.preventDefault();
            draggedImg = img;
            img.dataset.isDraggingNow = 'true';

            const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);

            startX = clientX;
            startY = clientY;
            initialX = parseFloat(img.dataset.x) || 0;
            initialY = parseFloat(img.dataset.y) || 0;

            img.style.cursor = 'grabbing';
        }

        function drag(e) {
            if (!draggedImg) return;
            e.preventDefault();

            const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);

            const dx = clientX - startX;
            const dy = clientY - startY;

            // Mark as actually moved
            if (Math.abs(dx) > 2 || Math.abs(dy) > 2) {
                draggedImg.dataset.wasDragging = 'true';
            }

            draggedImg.dataset.x = initialX + dx;
            draggedImg.dataset.y = initialY + dy;

            updateTransform(draggedImg);
        }

        function endDrag() {
            if (draggedImg) {
                draggedImg.style.cursor = 'grab';
                draggedImg.dataset.isDraggingNow = 'false';

                // Keep 'wasDragging' true for a moment to block the click
                const tmpImg = draggedImg;
                draggedImg = null;
                setTimeout(() => {
                    if (tmpImg) tmpImg.dataset.wasDragging = 'false';
                }, 100);
            }
        }

        function handleImage(input, imgId) {
            const preview = document.getElementById(imgId);
            const container = input.parentElement;

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';

                    // Reset State
                    preview.dataset.scale = 1;
                    preview.dataset.x = 0;
                    preview.dataset.y = 0;
                    updateTransform(preview);

                    if (container.parentElement.querySelector('input[type="range"]')) {
                        container.parentElement.querySelector('input[type="range"]').value = 1;
                    }

                    // Attach Drag Events
                    preview.onmousedown = startDrag;
                    preview.ontouchstart = startDrag;
                    preview.classList.add('img-pan'); // Always draggable

                    // Hide text
                    const text = container.querySelector('.upload-text');
                    if (text) text.style.display = 'none';

                    try {
                        localStorage.setItem('sw-img-' + imgId, e.target.result);
                    } catch (e) {
                        console.log("Imagen muy grande para localStorage.");
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- 1.5 Auto-Carga de Im√°genes desde Carpeta Local ---
        let assetFilesIndex = {}; // Mapa: nombre_archivo_lower -> File Object

        document.getElementById('folderInput').addEventListener('change', function (e) {
            const files = e.target.files;
            assetFilesIndex = {};
            let count = 0;

            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    // Guardamos el nombre en min√∫sculas para b√∫squeda insensible a may√∫sculas
                    assetFilesIndex[file.name.toLowerCase()] = file;
                    count++;
                }
                document.getElementById('folderStatus').innerText = `‚úÖ ${count} archivos indexados. Listo para buscar.`;
                document.getElementById('folderStatus').style.color = 'green';

                // Intentar buscar inmediatamente si ya hay un SAP puesto
                const currentSap = document.querySelector('input[data-id="sap-1"]').value;
                if (currentSap) searchAndLoadAssets(currentSap);
            } else {
                document.getElementById('folderStatus').innerText = "Ninguna carpeta seleccionada";
                document.getElementById('folderStatus').style.color = '#666';
            }
        });

        // --- 1.6 Carga de Datos desde Excel ---
        let excelDataIndex = {}; // Mapa: SAP (string) -> Row Object

        document.getElementById('excelInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Usamos la primera hoja
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // Convertir a JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // Array de Arrays

                if (jsonData.length < 2) {
                    alert("El archivo Excel parece vac√≠o o sin encabezados.");
                    return;
                }

                // Procesar encabezados (fila 0)
                const headers = jsonData[0].map(h => h ? h.toString().trim().toLowerCase() : '');

                // Buscar √≠ndice de columna SAP
                // Posibles nombres: 'sap', 'no. sap', 'numero sap', 'codigo sap', 'material'
                let sapColIndex = headers.findIndex(h => h.includes('sap') || h.includes('material') || h === 'codigo');

                if (sapColIndex === -1) {
                    alert("No se encontr√≥ una columna 'SAP' o 'Material' en el Excel via encabezados. Se usar√° la primera columna por defecto.");
                    sapColIndex = 0;
                }

                // Constuir √çndice
                excelDataIndex = {};
                let count = 0;

                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    const sapVal = row[sapColIndex];

                    if (sapVal) {
                        // Normalizar clave SAP (string, sin espacios)
                        const key = sapVal.toString().trim();
                        // Guardar objeto fila con claves = headers
                        const rowObj = {};
                        headers.forEach((h, idx) => {
                            if (h) rowObj[h] = row[idx];
                        });
                        excelDataIndex[key] = rowObj;
                        count++;
                    }
                }

                document.getElementById('excelStatus').innerText = `‚úÖ ${count} registros cargados.`;
                document.getElementById('excelStatus').style.color = 'green';

                // Intentar cargar datos si ya hay SAP
                const currentSap = document.querySelector('input[data-id="sap-1"]').value;
                if (currentSap) searchAndFillData(currentSap);

                // Si estamos en el dashboard (pantalla de inicio), ir a la hoja
                if (!document.getElementById('dashboard').classList.contains('hidden')) {
                    showSheet();
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // Configuraci√≥n de Mapeo: "Header Excel (lowercase)" -> "data-id del Input"
        // Esto permite que si el Excel tiene "Cliente", llene 'client'. 
        // Si tiene "Largo", llene 'dim-l', etc.
        const excelMapping = {
            'cliente': 'client',
            'articulo': 'article',
            'descripcion': 'article',
            'fecha': 'date-doc',
            'version': 'version',
            'ect': 'ect',
            'largo': 'dim-l',
            'ancho': 'dim-w',
            'alto': 'dim-h',
            'profundidad': 'dim-h',
            'area total': 'area-total',
            'area_total': 'area-total',
            'area efectiva': 'area-eff',
            'merma': 'waste',
            'peso bruto': 'w-gross',
            'peso ok': 'w-net',
            'peso': 'w-net',
            'papel': 'mat-paper',
            'gramaje': 'gsm',
            'flauta': 'flute',
            'calibre': 'caliper',
            'clase': 'mat-class',
            'impresora': 'printer',
            'troqueladora': 'die-machine',
            'artios': 'artios',
            'pegadora': 'gluer',
            'piezas paq': 'pcs-pack',
            'piezas pallet': 'total-pcs',
            'pallets contenedor': 'pallets-cont'
        };

        function searchAndFillData(sapValue) {
            const cleanSap = sapValue.replace('#', '').trim();
            if (!cleanSap || Object.keys(excelDataIndex).length === 0) return;

            const rowData = excelDataIndex[cleanSap];
            if (rowData) {
                console.log("Datos encontrados en Excel para:", cleanSap, rowData);

                // Recorrer todos los inputs y ver si podemos llenarlos
                const inputs = document.querySelectorAll('input[data-id], textarea[data-id]');

                inputs.forEach(input => {
                    const id = input.getAttribute('data-id');
                    // 1. Buscar coincidencia exacta por ID en el Excel (poco probable pero posible)
                    // 2. Buscar por mapeo definido

                    let val = null;

                    // Estrategia inversa: Ver qu√© header del Excel mapea a este ID
                    for (const [header, targetId] of Object.entries(excelMapping)) {
                        if (targetId === id && rowData[header] !== undefined) {
                            val = rowData[header];
                            break;
                        }
                    }

                    // Si no encontramos por mapeo, intentamos coincidencia directa de ID (si el excel tiene col 'client')
                    if (val === null && rowData[id] !== undefined) {
                        val = rowData[id];
                    }

                    if (val !== null && val !== undefined) {
                        input.value = val;
                        // Disparar evento input para guardar en localStorage
                        input.dispatchEvent(new Event('input'));
                        // Efecto visual de actualizaci√≥n
                        input.style.backgroundColor = '#e6fffa';
                        setTimeout(() => input.style.backgroundColor = '', 1000);
                    }
                });
            }
        }

        function searchAndLoadAssets(sapValue) {
            // Limpiar SAP input (quitar # y espacios extranos)
            const cleanSap = sapValue.replace('#', '').trim();
            if (!cleanSap) return; // Permitimos ejecutar searchAndFillData aunque no haya assets

            // L√≥gica de Datos Excel
            searchAndFillData(cleanSap);

            if (Object.keys(assetFilesIndex).length === 0) return;

            console.log("Buscando activos para SAP:", cleanSap);

            // Mapeo de sufijos a IDs de imagen
            // Convenci√≥n: [SAP]_[Sufijo]
            const mappings = [
                { suffix: '_plano', targetId: 'img-flat' },
                { suffix: '_codigo', targetId: 'img-barcode' },
                { suffix: '_paletizado', targetId: 'img-pallet-layout' },
                { suffix: '_dibujo', targetId: 'img-ext-dims' }
            ];

            mappings.forEach(map => {
                const targetImg = document.getElementById(map.targetId);
                if (!targetImg) return;

                // Buscar archivo que empiece con SAP y contenga el sufijo
                // Buscamos coincidencia flexible: que incluya el SAP y el sufijo
                const searchKey = map.suffix.toLowerCase();

                // Buscar en el √≠ndice
                let foundFile = null;
                for (const fileName in assetFilesIndex) {
                    if (fileName.includes(cleanSap) && fileName.includes(searchKey)) {
                        foundFile = assetFilesIndex[fileName];
                        break; // Tomamos el primero que coincida
                    }
                }

                if (foundFile) {
                    console.log(`Encontrado p/${map.targetId}: ${foundFile.name}`);
                    const objectUrl = URL.createObjectURL(foundFile);

                    // Actualizar UI
                    targetImg.src = objectUrl;
                    targetImg.style.display = 'block';

                    // Ocultar texto de 'subir'
                    const container = targetImg.parentElement;
                    const text = container.querySelector('.upload-text');
                    if (text) text.style.display = 'none';

                    // Opcional: Persistir en localStorage como DataURL (cuidado con el tama√±o)
                    // Para rendimiento en esta sesi√≥n basta con el blob,
                    // pero si recarga la p√°gina necesitar√° re-seleccionar la carpeta.
                    // Para persistencia real, convertimos a Base64:
                    /*
                    const reader = new FileReader();
                    reader.onload = (e) => localStorage.setItem('sw-img-' + map.targetId, e.target.result);
                    reader.readAsDataURL(foundFile);
                    */
                }
            });
        }

        // --- 3. Dashboard Logic ---
        function showCreateOptions() {
            document.getElementById('dash-main-menu').classList.add('hidden');
            document.getElementById('dash-create-menu').classList.remove('hidden');
        }

        function showMainMenu() {
            document.getElementById('dash-create-menu').classList.add('hidden');
            document.getElementById('dash-main-menu').classList.remove('hidden');
        }

        // --- UI HELPERS ---
        function updateGrainArrow(val) {
            const arrowEl = document.getElementById('grain-arrow');
            if (arrowEl) {
                const isHoriz = val && val.toUpperCase().includes('HORIZ');
                arrowEl.textContent = isHoriz ? '‚Üî' : '‚Üï';
                arrowEl.style.fontSize = isHoriz ? '30px' : '24px';
            }
        }

        function clearFormData() {
            // Borrar datos de formulario
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('sw-data-')) {
                    localStorage.removeItem(key);
                }
            });

            // Limpiar inputs
            document.querySelectorAll('input[data-id], textarea[data-id]').forEach(input => {
                input.value = '';
            });

            // --- VALORES POR DEFECTO ---
            const setDef = (id, val) => {
                const el = document.querySelector(`[data-id="${id}"]`);
                if (el) el.value = val;
            };

            setDef('die-type', 'EXTERIOR');
            setDef('varnish1', 'BARNIZ BRILLANTE');
            setDef('ink1', 'CYAN');
            setDef('ink2', 'MAGENTA');
            setDef('ink3', 'YELLOW');
            setDef('ink4', 'BLACK');

            const today = new Date().toLocaleDateString('es-MX');
            setDef('date-doc', today);

            // Limpiar im√°genes
            ['img-print', 'img-flat', 'img-barcode', 'img-piece', 'img-ship', 'img-pallet1', 'img-pallet2', 'img-ext-dims', 'img-pallet-layout'].forEach(imgId => {
                const img = document.getElementById(imgId);
                if (img) {
                    img.src = '';
                    img.style.display = 'none';
                    const text = img.parentElement.querySelector('.upload-text');
                    if (text) text.style.display = 'block';
                    localStorage.removeItem('sw-img-' + imgId);
                }
            });
        }

        // --- WEIGHT DATABASE & FORMULAS ---
        const WEIGHT_DB = {
            FLUTE_FACTORS: { 'E': 1.32, 'B': 1.35, 'C': 1.48 },
            ADHESIVES: { STARCH: 18, PVA: 26 }, // g/m2
            FOLDING_GRAMMAGE: { // g/m2 by points
                'EPL_PONDEROSA': { '8': 0, '10': 0, '11': 220, '12': 240, '14': 280, '16': 320, '18': 360, '20': 395, '22': 430, '24': 465, '26': 500, '28': 515 },
                'CNK_WRK': { '12': 264, '14': 293, '15': 317, '16': 332, '17': 347, '18': 361, '20': 391, '22': 420, '24': 454, '26': 488, '28': 522, '30': 557 }
            }
        };

        function startNewMasterManual() {
            if (confirm("¬øIniciar una hoja vac√≠a?")) {
                clearFormData();
                // Abrir Modal M√°gico
                const modal = document.getElementById('magic-modal');
                modal.classList.remove('hidden');
                modal.style.display = 'flex';

                // Toggle logic for material fields
                const matClassSelect = document.getElementById('magic-class');
                const microFields = document.getElementById('magic-micro-fields');

                const toggleFields = () => {
                    if (matClassSelect.value === 'MICROCORRUGADO') {
                        microFields.style.display = 'block';
                    } else {
                        microFields.style.display = 'none';
                    }
                };
                matClassSelect.addEventListener('change', toggleFields);
                toggleFields(); // Initial check
            }
        }

        function closeMagicModal() {
            document.getElementById('magic-modal').classList.add('hidden');
            document.getElementById('magic-modal').style.display = 'none';
            showSheet();
        }

        function applyMagicCalculations() {
            // Helper to set value safely
            const setVal = (id, val) => {
                const el = document.querySelector(`input[data-id="${id}"], textarea[data-id="${id}"], select[data-id="${id}"]`);
                if (el) {
                    el.value = val;
                    el.dispatchEvent(new Event('input'));
                }
            };

            const getVal = (id) => {
                const el = document.getElementById(id);
                return el ? el.value : '';
            };

            const getNum = (id) => {
                const val = parseFloat(getVal(id));
                return isNaN(val) ? 0 : val;
            };

            // 1. Datos Generales
            setVal('client', getVal('magic-client'));
            setVal('article', getVal('magic-article'));
            const sap = getVal('magic-sap');
            if (sap) {
                setVal('sap-1', sap);
                setVal('ref-sap-2', sap);
                // Si existe la funci√≥n searchAndLoadAssets
                if (typeof searchAndLoadAssets === 'function') searchAndLoadAssets(sap);
            }

            // 2. Material & Peso
            const matClass = getVal('magic-class');
            const matPaper = getVal('magic-paper');
            const caliper = getVal('magic-caliper');
            const flute = getVal('magic-flute').toUpperCase().trim();

            setVal('mat-class', matClass);
            setVal('mat-paper', matPaper);
            setVal('caliper', caliper);
            setVal('flute', flute);
            setVal('ect', getVal('magic-ect'));

            // Microcorrugado specs
            const linerExt = getNum('magic-liner-ext');
            const medium = getNum('magic-medium');
            const linerInt = getNum('magic-liner-int');

            if (matClass === 'MICROCORRUGADO') {
                setVal('l-ext', linerExt);
                setVal('medium', medium);
                setVal('l-int', linerInt);
            } else {
                setVal('l-ext', '');
                setVal('medium', '');
                setVal('l-int', '');
            }

            // 3. Dimensiones Caja
            setVal('dim-l', getVal('magic-dim-l'));
            setVal('dim-w', getVal('magic-dim-w'));
            setVal('dim-h', getVal('magic-dim-h'));

            // 4. Configuraci√≥n Troquelado (Nuevos Mapeos)
            const grainDir = getVal('magic-grain-dir'); // VERTICAL / HORIZONTAL
            setVal('grain-dir-visual', grainDir); // Visual del hilo

            // Update Arrow
            const arrowEl = document.getElementById('grain-arrow');
            if (arrowEl) {
                arrowEl.textContent = (grainDir === 'HORIZONTAL') ? '‚Üî' : '‚Üï';
                // Hacer la flecha m√°s grande si es horizontal para que se note
                arrowEl.style.transform = (grainDir === 'HORIZONTAL') ? 'scaleX(1.5)' : 'scale(1)';
            }

            setVal('die-type', getVal('magic-die-type'));
            setVal('grip', getVal('magic-grip'));
            setVal('gap-h', getVal('magic-gap-h'));
            setVal('gap-v', getVal('magic-gap-v'));

            // 5. C√°lculos Hoja (√Årea y Peso)
            const lSheet = getNum('magic-l');
            const wSheet = getNum('magic-w');
            const pieceArea = getNum('magic-area');
            const pcs = getNum('magic-pcs');

            // L√≥gica Hilo / Contra
            if (grainDir === 'VERTICAL') {
                setVal('dim-grain', lSheet);
                setVal('dim-cross', wSheet);
            } else {
                setVal('dim-grain', wSheet);
                setVal('dim-cross', lSheet);
            }

            if (lSheet > 0 && wSheet > 0) {
                setVal('paper-dim', `${lSheet} X ${wSheet}`);
                setVal('roll-width', Math.min(lSheet, wSheet)); // Estimaci√≥n default
                const areaTotal = (lSheet * wSheet) / 1000000;
                setVal('area-total', areaTotal.toFixed(3));

                if (pieceArea > 0 && pcs > 0) {
                    setVal('pcs-sheet', pcs);
                    setVal('mat-area', pieceArea);

                    const effArea = (pieceArea * pcs) / areaTotal;
                    const effPercent = effArea * 100;
                    const wastePercent = 100 - effPercent;

                    setVal('area-eff', effPercent.toFixed(2) + '%');
                    setVal('waste', wastePercent.toFixed(2) + '%');
                }

                // C√ÅLCULO DE PESOS
                let totalGrammage = 0;
                if (matClass === 'MICROCORRUGADO') {
                    const fluteFactor = WEIGHT_DB.FLUTE_FACTORS[flute] || 1.35;
                    const adhesives = 25; // 25g avg
                    if (linerExt > 0 && medium > 0 && linerInt > 0) {
                        totalGrammage = linerExt + (medium * fluteFactor) + linerInt + adhesives;
                    }
                } else if (matClass === 'PLEGADIZO') {
                    // Try to find in DB
                    let dbKey = null;
                    if (matPaper.toUpperCase().includes('PONDEROSA')) dbKey = 'EPL_PONDEROSA';
                    if (matPaper.toUpperCase().includes('WRK') || matPaper.toUpperCase().includes('CNK')) dbKey = 'CNK_WRK';

                    if (dbKey && WEIGHT_DB.FOLDING_GRAMMAGE[dbKey]) {
                        const cleanCaliper = caliper.replace(/\D/g, '');
                        totalGrammage = WEIGHT_DB.FOLDING_GRAMMAGE[dbKey][cleanCaliper] || 0;
                    }
                }

                if (totalGrammage > 0) {
                    setVal('gsm', Math.round(totalGrammage));
                    if (pieceArea > 0) {
                        const netWeight = totalGrammage * pieceArea;
                        setVal('w-net', Math.round(netWeight));

                        const sheetTotalWeight = totalGrammage * areaTotal;
                        const grossWeight = sheetTotalWeight / pcs;
                        setVal('w-gross', Math.round(grossWeight));
                    }
                }
            }
            closeMagicModal();
        }

        function startNewMasterExcel() {
            if (confirm("¬øCargar nueva hoja desde Excel? (Esto borrar√° los datos actuales)")) {
                clearFormData();
                // Trigger click en el input de Excel
                document.getElementById('excelInput').click();
                // La transici√≥n a showSheet() se har√° en el evento 'change' del input
            }
        }

        function continueMaster() {
            showSheet();
        }

        function showSheet() {
            document.getElementById('dashboard').classList.add('hidden');
            // Mostrar Sidebar
            document.getElementById('sidebar').classList.remove('hidden');

            document.querySelectorAll('.sheet').forEach(el => el.classList.remove('hidden'));
            document.querySelector('.page-break').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        // --- 2. Persistencia de Datos (Auto-Save) ---
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializaci√≥n de vista
            // Ocultar Sidebar inicialmente
            document.getElementById('sidebar').classList.add('hidden');

            document.querySelectorAll('.sheet').forEach(el => el.classList.add('hidden'));
            document.querySelector('.page-break').classList.add('hidden');

            const inputs = document.querySelectorAll('input, textarea');

            inputs.forEach(input => {
                const id = input.getAttribute('data-id');
                if (id) {
                    const savedVal = localStorage.getItem('sw-data-' + id);
                    if (savedVal) input.value = savedVal;

                    input.addEventListener('input', (e) => {
                        localStorage.setItem('sw-data-' + id, e.target.value);
                        if (id === 'sap-1') {
                            const val = e.target.value;
                            const el2 = document.getElementById('ref-sap-2');
                            if (el2) el2.innerText = val.replace('#', '').trim();

                            // Disparar b√∫squeda de activos
                            searchAndLoadAssets(val);
                        }
                    });
                }
            });

            // Restore Images
            ['img-flat', 'img-barcode', 'img-ship', 'img-pallet1', 'img-pallet2', 'img-ext-dims', 'img-pallet-layout'].forEach(imgId => {
                const savedImg = localStorage.getItem('sw-img-' + imgId);
                if (savedImg) {
                    const img = document.getElementById(imgId);
                    if (img) {
                        img.src = savedImg;
                        img.style.display = 'block';
                        const text = img.parentElement.querySelector('.upload-text');
                        if (text) text.style.display = 'none';
                    }
                }
            });
        });
    </script>
    <!-- MAGIC MODAL (Manual Setup) -->
    <div id="magic-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <h3
                style="margin-top:0; color:#1f2937; text-align:center; margin-bottom: 5px; font-size: 20px; font-weight: 600;">
                üöÄ Inicializaci√≥n R√°pida</h3>
            <p style="text-align:center; color:#6b7280; font-size:13px; margin-bottom:25px;">
                Ingresa los datos clave para pre-llenar la hoja y calcular m√©tricas.
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Column 1: General & Material -->
                <div>
                    <h4
                        style="font-size:12px; color:var(--sw-blue); border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:10px;">
                        1. Datos Generales</h4>
                    <div style="margin-bottom:10px;">
                        <label class="block text-xxs font-bold mb-1">Cliente</label>
                        <input type="text" id="magic-client" class="form-input">
                    </div>
                    <div style="margin-bottom:10px;">
                        <label class="block text-xxs font-bold mb-1">Art√≠culo / Descripci√≥n</label>
                        <input type="text" id="magic-article" class="form-input">
                    </div>
                    <div style="margin-bottom:10px;">
                        <label class="block text-xxs font-bold mb-1">No. SAP (Opcional)</label>
                        <input type="text" id="magic-sap" class="form-input" placeholder="Carga im√°genes si existen">
                    </div>

                    <h4
                        style="font-size:12px; color:var(--sw-blue); border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:10px; margin-top:15px;">
                        2. Material</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                        <div>
                            <label class="block text-xxs font-bold mb-1">Clase</label>
                            <select id="magic-class" class="form-input">
                                <option value="MICROCORRUGADO">Microcorrugado</option>
                                <option value="PLEGADIZO">Plegadizo</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xxs font-bold mb-1">Tipo Papel</label>
                            <input type="text" id="magic-paper" class="form-input">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xxs font-bold mb-1">Calibre / Puntos</label>
                        <input type="text" id="magic-caliper" class="form-input" placeholder="Ej: 12 (Plegadizo)">
                    </div>
                    <div>
                        <label class="block text-xxs font-bold mb-1">Flauta</label>
                        <input type="text" id="magic-flute" class="form-input" placeholder="E, B, C">
                    </div>
                    <div>
                        <label class="block text-xxs font-bold mb-1">ECT</label>
                        <input type="text" id="magic-ect" class="w-full border p-1 rounded text-xs">
                    </div>
                </div>

                <!-- Microcorrugated Specifics (Liners) -->
                <div id="magic-micro-fields"
                    style="display:none; background:#f8fafc; padding:8px; border-radius:6px; margin-bottom:10px; border:1px solid #e2e8f0;">
                    <h5 style="font-size:11px; font-weight:bold; color:#666; margin-bottom:5px;">Composici√≥n
                        (Microcorrugado)</h5>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                        <div>
                            <label class="block text-xxs font-bold mb-1">L. Ext</label>
                            <input type="number" id="magic-liner-ext" class="form-input" placeholder="g">
                        </div>
                        <div>
                            <label class="block text-xxs font-bold mb-1">Medium</label>
                            <input type="number" id="magic-medium" class="form-input" placeholder="g">
                        </div>
                        <div>
                            <label class="block text-xxs font-bold mb-1">L. Int</label>
                            <input type="number" id="magic-liner-int" class="form-input" placeholder="g">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Column 2: Dimensions & Calcs -->
            <div>
                <h4
                    style="font-size:12px; color:var(--sw-blue); border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:10px;">
                    3. Dimensiones Caja (mm)</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
                    <div>
                        <label class="block text-xxs font-bold mb-1">Largo</label>
                        <input type="number" id="magic-dim-l" class="form-input">
                    </div>
                    <div>
                        <label class="block text-xxs font-bold mb-1">Ancho</label>
                        <input type="number" id="magic-dim-w" class="form-input">
                    </div>
                    <div>
                        <label class="block text-xxs font-bold mb-1">Alto</label>
                        <input type="number" id="magic-dim-h" class="form-input">
                    </div>
                </div>

                <h4
                    style="font-size:12px; color:var(--sw-blue); border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:10px; margin-top:15px;">
                    4. Hoja y Pieza (C√°lculos)</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                    <div>
                        <label class="block text-xxs font-bold mb-1">Largo Hoja</label>
                        <input type="number" id="magic-l" class="form-input">
                    </div>
                    <div>
                        <label class="block text-xxs font-bold mb-1">Ancho Hoja</label>
                        <input type="number" id="magic-w" class="form-input">
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                    <div>
                        <label class="block text-xxs font-bold mb-1">√Årea Pieza (m¬≤)</label>
                        <input type="number" step="0.0001" id="magic-area" class="form-input">
                    </div>
                    <div>
                        <label class="block text-xxs font-bold mb-1">Piezas/Hoja</label>
                        <input type="number" id="magic-pcs" class="form-input">
                    </div>
                </div>

                <h4
                    style="font-size:12px; color:var(--sw-blue); border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:10px; margin-top:15px;">
                    5. Troquelado & Configuraci√≥n
                </h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                    <div>
                        <label class="block text-xxs font-bold mb-1">Sentido Hilo</label>
                        <select id="magic-grain-dir" class="form-input">
                            <option value="VERTICAL">Vertical (Largo)</option>
                            <option value="HORIZONTAL">Horizontal (Ancho)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xxs font-bold mb-1">Tipo Troquel</label>
                        <select id="magic-die-type" class="form-input">
                            <option value="INTERNO">Interno</option>
                            <option value="EXTERIOR" selected>Exterior</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                    <div>
                        <label class="block text-xxs font-bold mb-1">Pinza (mm)</label>
                        <input type="number" id="magic-grip" value="20" class="form-input">
                    </div>
                    <div>
                        <label class="block text-xxs font-bold mb-1">Gap H (mm)</label>
                        <input type="number" id="magic-gap-h" value="0" class="form-input">
                    </div>
                    <div>
                        <label class="block text-xxs font-bold mb-1">Gap V (mm)</label>
                        <input type="number" id="magic-gap-v" value="0" class="form-input">
                    </div>
                </div>
            </div>
            <div style="margin-top: 30px; display: flex; gap: 10px; flex-direction: column;">
                <button onclick="applyMagicCalculations()" class="dashboard-btn btn-primary"
                    style="margin:0; padding: 15px; font-size: 16px;">
                    ‚ú® Generar Hoja Maestra
                </button>
                <button onclick="closeMagicModal()"
                    style="background:transparent; color:#6b7280; border:none; cursor:pointer; font-size:14px; padding: 10px;">
                    Omitir y llenar manualmente
                </button>
            </div>
        </div>
    </div>
    </div>
    <script>
        // Initialize Drag for restored images on load
        window.addEventListener('load', function () {
            ['img-print', 'img-barcode', 'img-flat', 'img-piece'].forEach(function (id) {
                const img = document.getElementById(id);
                if (img && img.src && img.style.display !== 'none') {
                    img.onmousedown = startDrag;
                    img.ontouchstart = startDrag;
                    img.classList.add('img-pan');

                    // Ensure container text is hidden if image is present
                    const container = img.parentElement.parentElement;
                    const text = container.querySelector('.upload-text');
                    if (text) text.style.display = 'none';
                }
            });
        });
    </script>

    <!-- === COTIZADOR MODAL === -->
    <div id="cotizadorModalContainer" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-[9999] hidden overflow-y-auto">
        <button onclick="hideCotizadorModal()"
            class="fixed top-4 right-4 z-[10001] bg-white text-gray-700 hover:bg-red-500 hover:text-white rounded-full p-3 shadow-lg transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        <div class="container mx-auto p-4 lg:p-8 flex items-center justify-center min-h-screen">
            <div class="w-full">
                <div class="text-center mb-8">
                    <h1
                        class="text-4xl font-extrabold text-gray-900 bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                        Hola, ¬øQu√© vamos a optimizar hoy?</h1>
                </div>

                <div id="formContainer"
                    class="w-full max-w-md bg-white p-6 rounded-lg shadow-xl mx-auto border-t-4 border-blue-500">
                    <div class="flex justify-between items-center mb-4 pb-4 border-b">
                        <h2 class="text-lg font-bold text-gray-800">Par√°metros de Corte</h2>
                        <div class="flex items-center gap-1">
                            <button id="historyBtn"
                                class="p-2 rounded-full hover:bg-gray-100 transition-colors print-hide"
                                title="Ver Historial">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>
                            <button id="settingsBtn"
                                class="p-2 rounded-full hover:bg-gray-100 transition-colors print-hide"
                                title="Ajustes de M√°quina">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <form id="cutForm" class="space-y-4">

                        <div class="flex items-center justify-center p-2 bg-gray-50 rounded-lg">
                            <span class="text-sm font-medium text-gray-900 mr-3">Modo √ìptimo</span>
                            <div
                                class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="calculationModeToggle"
                                    class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                                <label for="calculationModeToggle"
                                    class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                            <span class="text-sm font-medium text-gray-900">Modo Manual</span>
                        </div>

                        <div id="customSheetContainer"
                            class="hidden p-4 border-l-4 border-indigo-500 bg-indigo-50 rounded-lg">
                            <label class="block font-medium text-gray-700 mb-2">Tama√±o de Pliego Manual</label>
                            <div class="flex space-x-2">
                                <input type="text" inputmode="decimal" id="customSheetWidth" placeholder="Ancho"
                                    class="w-1/2 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 transition-shadow duration-200" />
                                <input type="text" inputmode="decimal" id="customSheetHeight" placeholder="Alto"
                                    class="w-1/2 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 transition-shadow duration-200" />
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="unit"
                                    class="block font-medium text-sm text-gray-700 mb-1 tracking-wide">Unidad</label>
                                <select id="unit"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200">
                                    <option value="mm" selected>Mil√≠metros (mm)</option>
                                    <option value="cm">Cent√≠metros (cm)</option>
                                    <option value="in">Pulgadas (in)</option>
                                </select>
                            </div>
                            <div>
                                <label for="material"
                                    class="block font-medium text-sm text-gray-700 mb-1 tracking-wide">Material</label>
                                <select id="material"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200">
                                    <option value="microcorrugado">Microcorrugado</option>
                                    <option value="plegadizo">Plegadizo</option>
                                </select>
                            </div>
                        </div>

                        <div id="materialOptionsContainer" class="space-y-4">
                            <div id="fluteContainer">
                                <label for="flute"
                                    class="block font-medium text-sm text-gray-700 mb-1 tracking-wide">Flauta</label>
                                <select id="flute"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200">
                                    <option>Flauta E</option>
                                    <option>Flauta B</option>
                                    <option>Flauta C</option>
                                </select>
                            </div>
                            <div id="ectContainer">
                                <div class="relative flex items-start mt-4">
                                    <div class="flex h-5 items-center">
                                        <input id="ectCheckbox" name="ectCheckbox" type="checkbox"
                                            class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="ectCheckbox" class="font-medium text-gray-700">Aplica ECT</label>
                                    </div>
                                </div>
                                <div id="ectValueContainer" class="hidden mt-2">
                                    <label for="ectValue"
                                        class="block font-medium text-sm text-gray-700 mb-1 tracking-wide">Valor ECT
                                        (lb/in)</label>
                                    <select id="ectValue"
                                        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200">
                                        <option>26</option>
                                        <option>29</option>
                                        <option selected>32</option>
                                        <option>40</option>
                                    </select>
                                    <div id="linerInputsContainer" class="grid grid-cols-3 gap-2 mt-4">
                                        <div>
                                            <label for="linerExt"
                                                class="block font-medium text-xs text-gray-600 mb-1">L.Ext</label>
                                            <input type="text" inputmode="decimal" id="linerExt"
                                                class="w-full p-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500" />
                                        </div>
                                        <div>
                                            <label for="medium"
                                                class="block font-medium text-xs text-gray-600 mb-1">M</label>
                                            <input type="text" inputmode="decimal" id="medium"
                                                class="w-full p-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500" />
                                        </div>
                                        <div>
                                            <label for="linerInt"
                                                class="block font-medium text-xs text-gray-600 mb-1">L.I</label>
                                            <input type="text" inputmode="decimal" id="linerInt"
                                                class="w-full p-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="foldingCartonTypeContainer" class="hidden">
                                <label for="foldingCartonType"
                                    class="block font-medium text-sm text-gray-700 mb-1 tracking-wide">Tipo de
                                    Papel</label>
                                <select id="foldingCartonType"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200">
                                    <option>EPL_Ponderosa</option>
                                    <option>CNK_WRK</option>
                                </select>
                            </div>
                            <div id="foldingCartonWeightContainer" class="hidden">
                                <label for="foldingCartonWeight"
                                    class="block font-medium text-sm text-gray-700 mb-1 tracking-wide">Gramaje
                                    (Puntos)</label>
                                <select id="foldingCartonWeight"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200">
                                    <option>8</option>
                                    <option>10</option>
                                    <option>11</option>
                                    <option>12</option>
                                    <option>14</option>
                                    <option>15</option>
                                    <option>16</option>
                                    <option>17</option>
                                    <option>18</option>
                                    <option>20</option>
                                    <option>22</option>
                                    <option>24</option>
                                    <option>26</option>
                                    <option>28</option>
                                    <option>30</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label for="acomodo"
                                class="block font-medium text-sm text-gray-700 mb-1 tracking-wide">Acomodo</label>
                            <select id="acomodo"
                                class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200">
                                <option value="optimo" selected>√ìptimo</option>
                                <option value="horizontal">Horizontal</option>
                                <option value="vertical">Vertical</option>
                            </select>
                        </div>

                        <div>
                            <label class="block font-medium text-gray-700 mb-1 tracking-wide">Tama√±o del corte
                                (final)</label>
                            <div class="flex space-x-2">
                                <div class="w-1/2">
                                    <input type="text" inputmode="decimal" id="cutWidth" placeholder="Ancho"
                                        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200"
                                        required />
                                    <p class="text-xs text-gray-500 mt-1">Colocar Hilo</p>
                                </div>
                                <div class="w-1/2">
                                    <input type="text" inputmode="decimal" id="cutHeight" placeholder="Alto"
                                        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200"
                                        required />
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-gray-50 rounded-lg space-y-3">
                            <p class="text-sm font-semibold text-gray-800">Ajustes de Impresi√≥n</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="gutter"
                                        class="block font-medium text-sm text-gray-700 mb-1">Medianil</label>
                                    <input type="text" inputmode="decimal" id="gutter" value="3"
                                        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200" />
                                </div>
                                <div>
                                    <label for="sideMargins"
                                        class="block font-medium text-sm text-gray-700 mb-1">Laterales</label>
                                    <input type="text" inputmode="decimal" id="sideMargins" value="10"
                                        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200" />
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="topGripper" class="block font-medium text-sm text-gray-700 mb-1">Pinza
                                        Superior</label>
                                    <input type="text" inputmode="decimal" id="topGripper" value="15"
                                        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200" />
                                </div>
                                <div>
                                    <label for="bottomGripper"
                                        class="block font-medium text-sm text-gray-700 mb-1">Pinza Inferior</label>
                                    <input type="text" inputmode="decimal" id="bottomGripper" value="20"
                                        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200" />
                                </div>
                            </div>
                        </div>

                        <div class="relative flex items-start">
                            <div class="flex h-5 items-center">
                                <input id="gluing" aria-describedby="gluing-description" name="gluing" type="checkbox"
                                    class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="gluing" class="font-medium text-gray-700">Lleva Pegado</label>
                            </div>
                        </div>

                        <div id="plegadizoBundleContainer" class="hidden pl-8 relative flex items-start mt-2">
                            <div class="flex h-5 items-center">
                                <input id="usePlegadizoBundles" name="usePlegadizoBundles" type="checkbox"
                                    class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="usePlegadizoBundles" class="font-medium text-gray-700">Calcular Atados para
                                    Plegadizo</label>
                                <p class="text-gray-500 text-xs">Agrupa las piezas en atados por altura para paletizado.
                                </p>
                            </div>
                        </div>

                        <div id="gluingOptionsContainer"
                            class="hidden pl-8 space-y-4 border-l-4 border-indigo-200 pt-4 mt-2">
                            <!-- Nuevo checkbox para Fondo Autom√°tico -->
                            <div class="relative flex items-start">
                                <div class="flex h-5 items-center">
                                    <input id="isAutomaticBottom" name="isAutomaticBottom" type="checkbox"
                                        class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="isAutomaticBottom" class="font-medium text-gray-700">Fondo Autom√°tico (5
                                        Dobleces)</label>
                                    <p class="text-gray-500 text-xs">Aplica ajuste emp√≠rico de espesor para apilado.</p>
                                </div>
                            </div>
                            <!-- Fin de nuevo checkbox -->

                            <div class="relative flex items-start">
                                <div class="flex h-5 items-center">
                                    <input id="useCollectiveBox" name="useCollectiveBox" type="checkbox"
                                        class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                        checked>
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="useCollectiveBox" class="font-medium text-gray-700">Calcular Caja
                                        Colectiva</label>
                                    <p class="text-gray-500 text-xs">Busca una caja est√°ndar para empacar las piezas.
                                    </p>
                                </div>
                            </div>
                            <div>
                                <label for="gluingMachine" class="block font-medium text-sm text-gray-700 mb-1">M√°quina
                                    de Pegado</label>
                                <select id="gluingMachine"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200">
                                    <option>ExpertFold</option>
                                    <option>Diana</option>
                                    <option>Amazon</option>
                                </select>
                            </div>
                            <div>
                                <label for="glueFlapWidth" class="block font-medium text-sm text-gray-700 mb-1">Ancho de
                                    Pesta√±a</label>
                                <input type="text" inputmode="decimal" id="glueFlapWidth" value="15"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200" />
                            </div>
                            <div id="foldedPieceInfoContainer" class="mt-4 p-3 bg-indigo-50 rounded-lg text-sm hidden">
                                <h4 class="font-semibold text-gray-800 mb-2">Dimensiones (Pieza Doblada)</h4>
                                <div class="space-y-1">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Tama√±o Final:</span>
                                        <span id="foldedPieceSize" class="font-bold text-indigo-700">-- mm x --
                                            mm</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Grosor Final:</span>
                                        <span id="foldedPieceThickness" class="font-bold text-indigo-700">-- mm</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="pt-2 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                            <button type="submit"
                                class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-all duration-300 font-semibold shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center justify-center">Calcular</button>
                            <button type="button" id="resetBtn"
                                class="w-full bg-gray-200 text-gray-700 py-3 px-4 rounded-md hover:bg-gray-300 transition-colors font-medium">Limpiar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="modalOverlay"
            class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start justify-center p-4 z-50 hidden transition-opacity duration-300 overflow-y-auto">
            <div id="resultsContainer"
                class="w-full max-w-4xl bg-white p-6 rounded-lg shadow-xl relative my-8 transform transition-all duration-300 scale-95 opacity-0">
                <button id="closeModalBtn"
                    class="absolute -top-2 -right-2 bg-white rounded-full p-1 shadow-md hover:bg-red-500 hover:text-white transition-colors print-hide">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>

                <h2 id="resultsTitle" class="text-xl font-semibold border-b border-gray-200 pb-2 mb-4">Resultados de
                    Optimizaci√≥n</h2>

                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-1 space-y-4">
                        <div>
                            <h3 id="rankingTitle" class="font-semibold text-gray-800 mb-2">Ranking de Impresoras</h3>
                            <div id="machineRanking" class="space-y-3 bg-gray-50 p-3 rounded-lg">
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-2">Ruta de Proceso Sugerida</h3>
                            <div id="processRouteContainer" class="space-y-2">
                            </div>
                        </div>
                        <div id="analysisNotesContainer" class="mt-4 hidden">
                            <details class="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                <summary class="font-semibold text-sm text-amber-800 cursor-pointer">Notas del An√°lisis
                                    de Optimizaci√≥n</summary>
                                <div id="analysisNotesContent"
                                    class="mt-2 text-xs text-amber-700 space-y-2 border-t border-amber-200 pt-2">
                                    <!-- Content will be injected here -->
                                </div>
                            </details>
                        </div>
                        <div id="weightResultsContainer" class="mt-4 hidden">
                        </div>
                        <div id="collectiveBoxContainer" class="mt-4 hidden">
                        </div>
                        <button id="palletizeBtn"
                            class="w-full mt-4 bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors font-medium print-hide flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M3 3a1 1 0 000 2v8a1 1 0 001 1h12a1 1 0 001-1V5a1 1 0 000-2H3zm3 2a1 1 0 011-1h2a1 1 0 110 2H7a1 1 0 01-1-1zm-1 4a1 1 0 100 2h2a1 1 0 100-2H5zm5-4a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1zm-1 4a1 1 0 100 2h2a1 1 0 100-2h-2z"
                                    clip-rule="evenodd" />
                            </svg>
                            Ver Paletizado
                        </button>
                    </div>

                    <div class="w-full md:w-1/2">
                        <p id="previewTitle" class="text-sm font-medium text-center mb-2">Vista Previa</p>
                        <canvas id="cutCanvas" width="675" height="450"
                            class="w-full h-auto bg-white border border-gray-200 rounded-md"></canvas>
                        <div id="previewDetails" class="mt-4 text-sm text-center">
                        </div>
                        <div id="previewLegend" class="mt-3 text-xs">
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="folioInput" class="block text-sm font-medium text-gray-700">Folio</label>
                            <input type="text" id="folioInput" placeholder="Ej: 12345"
                                class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="clienteInput" class="block text-sm font-medium text-gray-700">Nombre de
                                Cliente</label>
                            <input type="text" id="clienteInput" placeholder="Ej: Acme Inc."
                                class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500">
                        </div>
                        <button id="saveBtn"
                            class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition-colors font-medium flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path
                                    d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM5 4a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" />
                                <path fill-rule="evenodd" d="M3 13a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                                    clip-rule="evenodd" />
                            </svg>
                            Guardar
                        </button>
                    </div>
                </div>

                <div class="flex space-x-2 mt-4 print-hide">
                    <button id="printBtn"
                        class="flex-1 bg-green-600 text-white p-2 rounded-md hover:bg-green-700 transition-colors font-medium">Imprimir</button>
                    <button id="emailBtn"
                        class="flex-1 bg-amber-500 text-white p-2 rounded-md hover:bg-amber-600 transition-colors font-medium">Enviar</button>
                    <button id="exportPngBtn"
                        class="flex-1 bg-sky-600 text-white p-2 rounded-md hover:bg-sky-700 transition-colors font-medium">Exportar
                        PNG</button>
                </div>
            </div>
        </div>

        <div id="settingsModalOverlay"
            class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start justify-center p-4 z-50 hidden transition-opacity duration-300 overflow-y-auto">
            <div
                class="w-full max-w-2xl bg-white p-6 rounded-lg shadow-xl relative my-8 transform transition-all duration-300 scale-95 opacity-0">
                <h2 class="text-xl font-semibold border-b border-gray-200 pb-2 mb-4">Ajustes de M√°quina</h2>
                <form id="settingsForm">
                    <div class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                        <details open>
                            <summary class="font-semibold text-gray-800 cursor-pointer py-2 hover:bg-gray-50 rounded">
                                Troqueladoras</summary>
                            <div id="dieCutterSettingsContainer" class="space-y-3 pl-4 pt-2"></div>
                        </details>
                        <details>
                            <summary class="font-semibold text-gray-800 cursor-pointer py-2 hover:bg-gray-50 rounded">
                                Impresoras</summary>
                            <div id="printerSettingsContainer" class="space-y-3 pl-4 pt-2"></div>
                        </details>
                        <details>
                            <summary class="font-semibold text-gray-800 cursor-pointer py-2 hover:bg-gray-50 rounded">
                                Ajustes de Paletizado</summary>
                            <div class="space-y-3 pl-4 pt-2">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <label for="standardPalletHeightInput"
                                        class="block text-sm font-medium text-gray-700">Altura de Tarima Est√°ndar
                                        (cm)</label>
                                    <input type="text" inputmode="decimal" id="standardPalletHeightInput"
                                        class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-700">A√±adir Nueva Tarima</p>
                                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-2 mt-2 items-end">
                                        <input id="newPalletName" placeholder="Nombre (ej: 40x52)"
                                            class="p-2 border border-gray-300 rounded-md sm:col-span-2">
                                        <input id="newPalletWidth" type="text" inputmode="decimal"
                                            placeholder="Ancho (in)" class="p-2 border border-gray-300 rounded-md">
                                        <input id="newPalletHeight" type="text" inputmode="decimal"
                                            placeholder="Alto (in)" class="p-2 border border-gray-300 rounded-md">
                                        <button type="button" id="addPalletBtn"
                                            class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 sm:col-span-4">A√±adir</button>
                                    </div>
                                </div>
                                <div id="palletListContainer" class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-700 mb-2">Tarimas Disponibles</p>
                                </div>
                            </div>
                        </details>
                        <details>
                            <summary class="font-semibold text-gray-800 cursor-pointer py-2 hover:bg-gray-50 rounded">
                                Factores de Producci√≥n</summary>
                            <div class="space-y-3 pl-4 pt-2">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-700 mb-2">Adhesivos (Laminado)</p>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="starchAdhesiveInput"
                                                class="block text-sm font-medium text-gray-700">Almid√≥n (gr/m¬≤)</label>
                                            <input type="text" inputmode="decimal" id="starchAdhesiveInput"
                                                class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div>
                                            <label for="pvaAdhesiveInput"
                                                class="block text-sm font-medium text-gray-700">Adhesivo PVA
                                                (gr/m¬≤)</label>
                                            <input type="text" inputmode="decimal" id="pvaAdhesiveInput"
                                                class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                        </div>
                                    </div>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-700 mb-2">Compensaci√≥n por Pliegue (Espesor)</p>
                                    <div>
                                        <label for="autoBottomCompInput"
                                            class="block text-sm font-medium text-gray-700">Compensaci√≥n Fondo
                                            Autom√°tico (mm)</label>
                                        <input type="text" inputmode="decimal" id="autoBottomCompInput"
                                            class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">Este valor fijo se agrega al espesor de 5
                                        paredes (fondo autom√°tico).</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-700 mb-2">Factores de Conversi√≥n (Medium)</p>
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                        <div>
                                            <label for="mediumFactorE"
                                                class="block text-sm font-medium text-gray-700">Flauta E</label>
                                            <input type="text" inputmode="decimal" id="mediumFactorE"
                                                class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div>
                                            <label for="mediumFactorB"
                                                class="block text-sm font-medium text-gray-700">Flauta B</label>
                                            <input type="text" inputmode="decimal" id="mediumFactorB"
                                                class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div>
                                            <label for="mediumFactorC"
                                                class="block text-sm font-medium text-gray-700">Flauta C</label>
                                            <input type="text" inputmode="decimal" id="mediumFactorC"
                                                class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                        </div>
                                    </div>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <details>
                                        <summary class="font-semibold text-gray-700 cursor-pointer">Gramajes de
                                            Plegadizo (gr/m¬≤)</summary>
                                        <div id="foldingCartonGrammageContainer" class="mt-4 space-y-4">
                                        </div>
                                    </details>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-700 mb-2">F√≥rmula de C√°lculo de Peso Bruto</p>
                                    <div
                                        class="text-xs text-gray-600 bg-white p-3 rounded-md font-mono leading-relaxed">
                                        <p class="font-bold text-indigo-700">Microcorrugado:</p>
                                        <p><span class="font-bold">G<sub>Total</sub></span> = (L<sub>Ext</sub> + (M *
                                            F<sub>Flauta</sub>) + L<sub>Int</sub>) + A<sub>Almid√≥n</sub> +
                                            A<sub>PVA</sub></p>
                                        <hr class="my-2">
                                        <p class="font-bold text-indigo-700">Plegadizo:</p>
                                        <p><span class="font-bold">G<sub>Total</sub></span> = Valor de tabla (Tipo Papel
                                            + Puntos)</p>
                                        <hr class="my-2">
                                        <p><span class="font-bold">P<sub>Pliego (Bruto)</sub></span> = G<sub>Total</sub>
                                            * (Ancho<sub>Pliego</sub> * Alto<sub>Pliego</sub>)</p>
                                        <p><span class="font-bold">P<sub>Pieza (Bruto)</sub></span> = P<sub>Pliego
                                                (Bruto)</sub> / No. Cortes (Incluye el peso de todo el trim y
                                            desperdicio)</p>
                                        <p class="text-gray-500 mt-2">
                                            Donde: <b>G</b>: Gramaje (g/m¬≤), <b>L</b>: Liner, <b>M</b>: Medium,
                                            <b>F</b>: Factor, <b>A</b>: Adhesivo, <b>P</b>: Peso.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </details>
                        <details>
                            <summary class="font-semibold text-gray-800 cursor-pointer py-2 hover:bg-gray-50 rounded">
                                Cajas Colectivas</summary>
                            <div class="space-y-3 pl-4 pt-2">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-700">A√±adir Nueva Caja Colectiva</p>
                                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-2 items-end">
                                        <input id="newBoxMaterial" type="text" inputmode="decimal"
                                            placeholder="Material"
                                            class="p-2 border border-gray-300 rounded-md text-sm">
                                        <input id="newBoxLargo" type="text" inputmode="decimal" placeholder="Largo (mm)"
                                            class="p-2 border border-gray-300 rounded-md text-sm">
                                        <input id="newBoxAncho" type="text" inputmode="decimal" placeholder="Ancho (mm)"
                                            class="p-2 border border-gray-300 rounded-md text-sm">
                                        <input id="newBoxAlto" type="text" inputmode="decimal" placeholder="Alto (mm)"
                                            class="p-2 border border-gray-300 rounded-md text-sm">
                                        <select id="newBoxFlauta" class="p-2 border border-gray-300 rounded-md text-sm">
                                            <option>C</option>
                                            <option>BC</option>
                                            <option>B</option>
                                            <option>E</option>
                                        </select>
                                        <input id="newBoxEct" type="text" inputmode="decimal" placeholder="ECT"
                                            class="p-2 border border-gray-300 rounded-md text-sm">
                                        <button type="button" id="addBoxBtn"
                                            class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 sm:col-span-4 h-10">A√±adir
                                            Caja</button>
                                    </div>
                                </div>
                                <div id="collectiveBoxListContainer" class="p-3 bg-gray-50 rounded-lg">
                                    <details>
                                        <summary class="font-semibold text-gray-700 cursor-pointer">Ver Cajas
                                            Disponibles</summary>
                                        <div id="collectiveBoxListContainer"
                                            class="mt-2 space-y-2 max-h-48 overflow-y-auto pr-2">
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </details>
                    </div>
                    <div class="flex justify-between items-center mt-6 pt-4 border-t">
                        <button type="button" id="restoreDefaultsBtn"
                            class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors font-medium">Restaurar
                            Defecto</button>
                        <div class="flex space-x-4">
                            <button type="button" id="cancelSettingsBtn"
                                class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors font-medium">Cancelar</button>
                            <button type="submit"
                                class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors font-medium">Guardar
                                Cambios</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div id="historyModalOverlay"
            class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start justify-center p-4 z-[60] hidden transition-opacity duration-300 overflow-y-auto">
            <div
                class="w-full max-w-lg bg-white p-6 rounded-lg shadow-xl relative my-8 transform transition-all duration-300 scale-95 opacity-0">
                <button id="closeHistoryModalBtn"
                    class="absolute -top-2 -right-2 bg-white rounded-full p-1 shadow-md hover:bg-red-500 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
                <h2 class="text-xl font-semibold border-b border-gray-200 pb-2 mb-4">Historial de C√°lculos</h2>
                <div id="historyListContainer" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                </div>
                <div class="flex justify-end mt-6 pt-4 border-t">
                    <button type="button" id="clearHistoryBtn"
                        class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors font-medium">Limpiar
                        Historial</button>
                </div>
            </div>
        </div>

        <div id="palletizeModalOverlay"
            class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start justify-center p-4 z-[60] hidden transition-opacity duration-300 overflow-y-auto">
            <div
                class="w-full max-w-lg bg-white p-6 rounded-lg shadow-xl relative my-8 transform transition-all duration-300 scale-95 opacity-0">
                <button id="closePalletizeModalBtn"
                    class="absolute -top-2 -right-2 bg-white rounded-full p-1 shadow-md hover:bg-red-500 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
                <h2 class="text-xl font-semibold border-b border-gray-200 pb-2 mb-4">Calculadora de Paletizado</h2>
                <p id="palletizingModeTitle" class="text-sm text-gray-600 -mt-2 mb-4 text-center"></p>

                <div class="space-y-4">
                    <div>
                        <label for="palletSize" class="block font-medium text-sm text-gray-700 mb-1">Tama√±o de
                            Tarima</label>
                        <select id="palletSize" class="w-full p-2 border border-gray-300 rounded-md">
                        </select>
                    </div>
                    <div>
                        <label for="stackingPattern" class="block font-medium text-sm text-gray-700 mb-1">Tipo de
                            Acomodo</label>
                        <select id="stackingPattern" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="recto">Recto</option>
                            <option value="columnar">Columnar / Intercalado</option>
                        </select>
                    </div>
                    <button id="calculatePalletBtn"
                        class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Calcular
                        Paletizado</button>
                </div>

                <div id="palletizeResultsContainer" class="mt-6 pt-4 border-t border-gray-200 hidden">
                    <h3 class="font-semibold text-gray-800 mb-2">Resultados del Paletizado</h3>
                    <div class="space-y-3">
                        <div class="bg-indigo-100 p-3 rounded-lg text-center">
                            <p class="text-sm font-medium text-indigo-800">Total de Piezas por Tarima</p>
                            <p id="totalPiecesResult" class="text-3xl font-extrabold text-indigo-600">-</p>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <p id="piecesPerLayerLabel" class="text-xs font-medium text-gray-600">Piezas / Cama</p>
                                <p id="piecesPerLayerResult" class="text-lg font-bold text-indigo-600">-</p>
                            </div>
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <p class="text-xs font-medium text-gray-600">Camas / Tarima</p>
                                <p id="layersPerPalletResult" class="text-lg font-bold text-indigo-600">-</p>
                            </div>
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <p class="text-xs font-medium text-gray-600">Altura Material</p>
                                <p id="materialHeightResult" class="text-lg font-bold text-indigo-600">-</p>
                            </div>
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <p class="text-xs font-medium text-gray-600">Altura Final (c/ tarima)</p>
                                <p id="finalHeightResult" class="text-lg font-bold text-indigo-600">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h3 class="font-semibold text-gray-800 mb-2 text-center">Vista Previa del Acomodo en Cama</h3>
                        <canvas id="palletCanvas" width="450" height="400"
                            class="w-full h-auto bg-gray-50 border border-gray-200 rounded-md mx-auto"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="boxOptionsModalOverlay"
            class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start justify-center p-4 z-[70] hidden transition-opacity duration-300 overflow-y-auto">
            <div
                class="w-full max-w-2xl bg-white p-6 rounded-lg shadow-xl relative my-8 transform transition-all duration-300 scale-95 opacity-0">
                <button id="closeBoxOptionsModalBtn"
                    class="absolute -top-2 -right-2 bg-white rounded-full p-1 shadow-md hover:bg-red-500 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
                <h2 class="text-xl font-semibold border-b border-gray-200 pb-2 mb-4">Opciones de Cajas Colectivas
                    Compatibles</h2>
                <div id="boxOptionsList" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                </div>
            </div>
        </div>


        <div id="toast"
            class="fixed top-5 right-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-md opacity-0 transform translate-y-2 transition-all duration-300 z-[100]">
            <p id="toastMessage"></p>
        </div>

    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONFIGURACI√ìN INICIAL Y ESTADO ---

            const DEFAULT_PROCESS_MACHINES = {
                DIE_CUTTERS: [
                    { name: 'Vision-160', maxWidth: 1620, maxHeight: 1103 },
                    { name: 'SP-104', maxWidth: 1050, maxHeight: 735 },
                    { name: 'SP-162', maxWidth: 1650, maxHeight: 1133 },
                    { name: 'SPANTHERA', maxWidth: 1460, maxHeight: 1060 },
                ],
                PRINTERS: [
                    { name: 'KBA-164', maxWidth: 1640, maxHeight: 1205, minWidth: 800, minHeight: 600 },
                    { name: 'KBA-106', maxWidth: 1060, maxHeight: 740, minWidth: 480, minHeight: 340 },
                    { name: 'Landa', maxWidth: 1050, maxHeight: 750, minWidth: 360, minHeight: 297 }, // Opci√≥n Landa Agregada
                ],
                LAMINATORS: [{ name: 'Asitrade Olivini' }]
            };

            let PROCESS_MACHINES = JSON.parse(JSON.stringify(DEFAULT_PROCESS_MACHINES));
            // Cambiado a v3 para forzar la actualizaci√≥n de las m√°quinas por defecto y mostrar Landa
            const SETTINGS_STORAGE_KEY = 'printOptimizerSettings_v3';
            const HISTORY_STORAGE_KEY = 'printOptimizerHistory_v2';
            const PALLET_SETTINGS_STORAGE_KEY = 'printOptimizerPalletSettings_v1';
            const GENERAL_SETTINGS_STORAGE_KEY = 'printOptimizerGeneralSettings_v3'; // Versi√≥n actualizada
            const COLLECTIVE_BOXES_STORAGE_KEY = 'printOptimizerCollectiveBoxes_v1';

            let PALLETIZING_SETTINGS = {
                standardPalletHeightCm: 15,
                maxTotalHeightCm: 135, // <-- MODIFICADO DE 120 A 135
                pallets: [
                    { name: '40" x 48"', widthIn: 40, heightIn: 48, id: 'p1' },
                    { name: '40" x 52"', widthIn: 40, heightIn: 52, id: 'p2' }
                ],
                MATERIAL_THICKNESS: {
                    FLUTES: { 'Flauta E': 1.5, 'Flauta B': 3.0, 'Flauta C': 4.0, 'BC': 7.0 },
                    // CORRECCI√ìN: 1 punto de calibre = 0.001 pulgadas = 0.0254 mm
                    POINTS_TO_MM: 0.0254
                }
            };

            const DEFAULT_GENERAL_SETTINGS = {
                adhesives: { starch: 18, pva: 26 },
                mediumFactors: { 'Flauta E': 1.32, 'Flauta B': 1.35, 'Flauta C': 1.48 },
                foldingCartonGrammage: {
                    'EPL_Ponderosa': { '8': 0, '10': 0, '11': 220, '12': 240, '14': 280, '16': 320, '18': 360, '20': 395, '22': 430, '24': 465, '26': 500, '28': 515 },
                    'CNK_WRK': { '12': 264, '14': 293, '15': 317, '16': 332, '17': 347, '18': 361, '20': 391, '22': 420, '24': 454, '26': 488, '28': 522, '30': 557 }
                },
                automaticBottomCompensation: 2.5 // Compensaci√≥n en mm para fondo autom√°tico (5 capas)
            };

            let GENERAL_SETTINGS = JSON.parse(JSON.stringify(DEFAULT_GENERAL_SETTINGS));

            const DEFAULT_COLLECTIVE_BOXES = [
                { material: 8053159, largo: 450, ancho: 248, alto: 279, flauta: 'C', ect: 32 },
                { material: 8053947, largo: 450, ancho: 434, alto: 279, flauta: 'C', ect: 32 },
                { material: 8054224, largo: 495, ancho: 365, alto: 250, flauta: 'C', ect: 32 },
                { material: 8054351, largo: 498, ancho: 222, alto: 292, flauta: 'C', ect: 44 },
                { material: 8054352, largo: 455, ancho: 300, alto: 178, flauta: 'C', ect: 32 },
                { material: 8054353, largo: 570, ancho: 335, alto: 190, flauta: 'C', ect: 32 },
                { material: 8054648, largo: 505, ancho: 400, alto: 303, flauta: 'C', ect: 32 },
                { material: 8054891, largo: 416, ancho: 345, alto: 265, flauta: 'C', ect: 32 },
                { material: 8055149, largo: 490, ancho: 290, alto: 200, flauta: 'C', ect: 40 },
                { material: 8055543, largo: 398, ancho: 240, alto: 405, flauta: 'BC', ect: 42 },
                { material: 8055559, largo: 400, ancho: 322, alto: 366, flauta: 'C', ect: 32 },
                { material: 8057212, largo: 592, ancho: 272, alto: 200, flauta: 'BC', ect: 42 },
                { material: 8058340, largo: 517, ancho: 347, alto: 447, flauta: 'C', ect: 40 },
                { material: 8058707, largo: 481, ancho: 320, alto: 408, flauta: 'C', ect: 32 },
                { material: 8059293, largo: 390, ancho: 290, alto: 262, flauta: 'C', ect: 40 },
                { material: 8059445, largo: 561, ancho: 396, alto: 539, flauta: 'C', ect: 32 },
                { material: 8059446, largo: 392, ancho: 333, alto: 374, flauta: 'C', ect: 32 },
                { material: 8060100, largo: 498, ancho: 396, alto: 406, flauta: 'C', ect: 32 },
                { material: 8060103, largo: 594, ancho: 338, alto: 425, flauta: 'C', ect: 32 },
                { material: 8061381, largo: 423, ancho: 352, alto: 334, flauta: 'BC', ect: 51 },
                { material: 8063254, largo: 415, ancho: 255, alto: 402, flauta: 'C', ect: 40 },
                { material: 8063837, largo: 505, ancho: 400, alto: 356, flauta: 'C', ect: 40 },
                { material: 8064494, largo: 450, ancho: 388, alto: 352, flauta: 'C', ect: 40 },
                { material: 8064495, largo: 450, ancho: 395, alto: 310, flauta: 'C', ect: 32 },
                { material: 8066556, largo: 535, ancho: 395, alto: 415, flauta: 'C', ect: 40 },
                { material: 8067555, largo: 450, ancho: 320, alto: 370, flauta: 'C', ect: 32 },
                { material: 8067995, largo: 460, ancho: 381, alto: 206, flauta: 'C', ect: 32 },
                { material: 8070983, largo: 450, ancho: 250, alto: 410, flauta: 'C', ect: 32 },
                { material: 8072982, largo: 672, ancho: 420, alto: 518, flauta: 'C', ect: 40 },
                { material: 8073215, largo: 560, ancho: 330, alto: 267, flauta: 'C', ect: 40 },
                { material: 8073350, largo: 490, ancho: 306, alto: 237, flauta: 'C', ect: 32 },
                { material: 8073381, largo: 585, ancho: 300, alto: 178, flauta: 'C', ect: 32 },
                { material: 8055535, largo: 327, ancho: 255, alto: 374, flauta: 'C', ect: 32 }
            ];

            let COLLECTIVE_BOXES = [];


            const DOM = {
                form: document.getElementById('cutForm'),
                submitBtn: document.querySelector('#cutForm button[type="submit"]'),
                inputs: {
                    unit: document.getElementById('unit'),
                    material: document.getElementById('material'),
                    flute: document.getElementById('flute'),
                    foldingCartonWeight: document.getElementById('foldingCartonWeight'),
                    acomodo: document.getElementById('acomodo'),
                    cutWidth: document.getElementById('cutWidth'),
                    cutHeight: document.getElementById('cutHeight'),
                    gutter: document.getElementById('gutter'),
                    sideMargins: document.getElementById('sideMargins'),
                    topGripper: document.getElementById('topGripper'),
                    bottomGripper: document.getElementById('bottomGripper'),
                    gluing: document.getElementById('gluing'),
                    gluingMachine: document.getElementById('gluingMachine'),
                    glueFlapWidth: document.getElementById('glueFlapWidth'),
                    calculationModeToggle: document.getElementById('calculationModeToggle'),
                    customSheetWidth: document.getElementById('customSheetWidth'),
                    customSheetHeight: document.getElementById('customSheetHeight'),
                    ectCheckbox: document.getElementById('ectCheckbox'),
                    ectValue: document.getElementById('ectValue'),
                    linerExt: document.getElementById('linerExt'),
                    medium: document.getElementById('medium'),
                    linerInt: document.getElementById('linerInt'),
                    useCollectiveBox: document.getElementById('useCollectiveBox'),
                    foldingCartonType: document.getElementById('foldingCartonType'),
                    usePlegadizoBundles: document.getElementById('usePlegadizoBundles'),
                    isAutomaticBottom: document.getElementById('isAutomaticBottom'), // <-- NUEVO
                },
                customSheetContainer: document.getElementById('customSheetContainer'),
                plegadizoBundleContainer: document.getElementById('plegadizoBundleContainer'),
                gluingOptionsContainer: document.getElementById('gluingOptionsContainer'),
                ectValueContainer: document.getElementById('ectValueContainer'),
                materialOptions: {
                    fluteContainer: document.getElementById('fluteContainer'),
                    ectContainer: document.getElementById('ectContainer'),
                    foldingCartonTypeContainer: document.getElementById('foldingCartonTypeContainer'),
                    foldingCartonWeightContainer: document.getElementById('foldingCartonWeightContainer'),
                },
                resetBtn: document.getElementById('resetBtn'),
                modal: {
                    overlay: document.getElementById('modalOverlay'),
                    container: document.getElementById('resultsContainer'),
                    resultsTitle: document.getElementById('resultsTitle'),
                    rankingTitle: document.getElementById('rankingTitle'),
                    rankingContainer: document.getElementById('machineRanking'),
                    processRouteContainer: document.getElementById('processRouteContainer'),
                    analysisNotesContainer: document.getElementById('analysisNotesContainer'),
                    analysisNotesContent: document.getElementById('analysisNotesContent'),
                    weightResultsContainer: document.getElementById('weightResultsContainer'),
                    collectiveBoxContainer: document.getElementById('collectiveBoxContainer'),
                    palletizeBtn: document.getElementById('palletizeBtn'),
                    previewTitle: document.getElementById('previewTitle'),
                    previewDetails: document.getElementById('previewDetails'),
                    previewLegend: document.getElementById('previewLegend'),
                    closeBtn: document.getElementById('closeModalBtn'),
                    printBtn: document.getElementById('printBtn'),
                    emailBtn: document.getElementById('emailBtn'),
                    exportPngBtn: document.getElementById('exportPngBtn'),
                    folioInput: document.getElementById('folioInput'),
                    clienteInput: document.getElementById('clienteInput'),
                    saveBtn: document.getElementById('saveBtn'),
                },
                settings: {
                    btn: document.getElementById('settingsBtn'),
                    overlay: document.getElementById('settingsModalOverlay'),
                    container: document.getElementById('settingsModalOverlay').querySelector('.transform'),
                    form: document.getElementById('settingsForm'),
                    dieCutterContainer: document.getElementById('dieCutterSettingsContainer'),
                    printerContainer: document.getElementById('printerSettingsContainer'),
                    cancelBtn: document.getElementById('cancelSettingsBtn'),
                    restoreDefaultsBtn: document.getElementById('restoreDefaultsBtn'),
                    standardPalletHeightInput: document.getElementById('standardPalletHeightInput'),
                    newPalletName: document.getElementById('newPalletName'),
                    newPalletWidth: document.getElementById('newPalletWidth'),
                    newPalletHeight: document.getElementById('newPalletHeight'),
                    addPalletBtn: document.getElementById('addPalletBtn'),
                    palletListContainer: document.getElementById('palletListContainer'),
                    starchAdhesiveInput: document.getElementById('starchAdhesiveInput'),
                    pvaAdhesiveInput: document.getElementById('pvaAdhesiveInput'),
                    autoBottomCompInput: document.getElementById('autoBottomCompInput'), // <-- NUEVO
                    mediumFactorE: document.getElementById('mediumFactorE'),
                    mediumFactorB: document.getElementById('mediumFactorB'),
                    mediumFactorC: document.getElementById('mediumFactorC'),
                    foldingCartonGrammageContainer: document.getElementById('foldingCartonGrammageContainer'),
                    newBoxMaterial: document.getElementById('newBoxMaterial'),
                    newBoxLargo: document.getElementById('newBoxLargo'),
                    newBoxAncho: document.getElementById('newBoxAncho'),
                    newBoxAlto: document.getElementById('newBoxAlto'),
                    newBoxFlauta: document.getElementById('newBoxFlauta'),
                    newBoxEct: document.getElementById('newBoxEct'),
                    addBoxBtn: document.getElementById('addBoxBtn'),
                    collectiveBoxListContainer: document.getElementById('collectiveBoxListContainer'),
                },
                history: {
                    btn: document.getElementById('historyBtn'),
                    overlay: document.getElementById('historyModalOverlay'),
                    container: document.getElementById('historyModalOverlay').querySelector('.transform'),
                    listContainer: document.getElementById('historyListContainer'),
                    closeBtn: document.getElementById('closeHistoryModalBtn'),
                    clearBtn: document.getElementById('clearHistoryBtn'),
                },
                palletize: {
                    overlay: document.getElementById('palletizeModalOverlay'),
                    container: document.getElementById('palletizeModalOverlay').querySelector('.transform'),
                    closeBtn: document.getElementById('closePalletizeModalBtn'),
                    calculateBtn: document.getElementById('calculatePalletBtn'),
                    palletSize: document.getElementById('palletSize'),
                    stackingPattern: document.getElementById('stackingPattern'),
                    resultsContainer: document.getElementById('palletizeResultsContainer'),
                    piecesPerLayerResult: document.getElementById('piecesPerLayerResult'),
                    layersPerPalletResult: document.getElementById('layersPerPalletResult'),
                    totalPiecesResult: document.getElementById('totalPiecesResult'),
                    materialHeightResult: document.getElementById('materialHeightResult'),
                    finalHeightResult: document.getElementById('finalHeightResult'),
                    palletCanvas: document.getElementById('palletCanvas'),
                    palletCtx: document.getElementById('palletCanvas').getContext('2d'),
                    palletizingModeTitle: document.getElementById('palletizingModeTitle'),
                    piecesPerLayerLabel: document.getElementById('piecesPerLayerLabel'),
                },
                boxOptions: {
                    overlay: document.getElementById('boxOptionsModalOverlay'),
                    container: document.getElementById('boxOptionsModalOverlay').querySelector('.transform'),
                    list: document.getElementById('boxOptionsList'),
                    closeBtn: document.getElementById('closeBoxOptionsModalBtn'),
                },
                foldedPieceInfo: {
                    container: document.getElementById('foldedPieceInfoContainer'),
                    size: document.getElementById('foldedPieceSize'),
                    thickness: document.getElementById('foldedPieceThickness'),
                },
                canvas: {
                    el: document.getElementById('cutCanvas'),
                    ctx: document.getElementById('cutCanvas').getContext('2d'),
                },
                toast: {
                    el: document.getElementById('toast'),
                    message: document.getElementById('toastMessage'),
                }
            };

            let state = {
                lastValidResults: null,
                history: [],
            };

            /**
             * Eval√∫a de forma segura una expresi√≥n matem√°tica b√°sica de una cadena.
             * @param {string} expression La expresi√≥n matem√°tica a evaluar.
             * @returns {number|null} El resultado del c√°lculo o null si no es v√°lido.
             */
            function safeCalculate(expression) {
                // Solo permite n√∫meros, puntos decimales, operadores b√°sicos, par√©ntesis y espacios.
                const sanitizedExpression = expression.trim();
                const validCharsRegex = /^[0-9\.\+\-\*\/\(\)\s]+$/;

                if (!validCharsRegex.test(sanitizedExpression)) {
                    console.error("La expresi√≥n contiene caracteres no v√°lidos.");
                    return null; // Contiene caracteres no v√°lidos
                }

                try {
                    // Usamos el constructor de Function para una evaluaci√≥n m√°s segura que eval().
                    const result = new Function('return ' + sanitizedExpression)();
                    if (typeof result === 'number' && isFinite(result)) {
                        return result;
                    }
                    return null;
                } catch (error) {
                    console.error("Error al evaluar la expresi√≥n:", error);
                    return null; // Error de sintaxis en la expresi√≥n
                }
            }

            /**
             * Manejador de eventos para verificar y realizar c√°lculos en los campos de entrada.
             * @param {Event} event El evento blur o keydown.
             */
            function handleMagicCalculation(event) {
                const input = event.target;
                let value = input.value.trim();

                if (value.startsWith('=')) {
                    const expression = value.substring(1);
                    const result = safeCalculate(expression);

                    if (result !== null) {
                        // Actualiza el campo con el valor calculado, formateado a 4 decimales
                        // para ser consistente con el atributo step="0.0001" de varios campos.
                        input.value = parseFloat(result.toFixed(4));

                        // Disparamos manualmente un evento 'input' para que otros listeners 
                        // de la app (como el de la info de pieza doblada) puedan reaccionar al cambio.
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
            }

            // --- L√ìGICA DE PERSISTENCIA (LocalStorage) ---
            function saveSettingsToLocalStorage() {
                try {
                    localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(PROCESS_MACHINES));
                    localStorage.setItem(PALLET_SETTINGS_STORAGE_KEY, JSON.stringify(PALLETIZING_SETTINGS));
                    localStorage.setItem(GENERAL_SETTINGS_STORAGE_KEY, JSON.stringify(GENERAL_SETTINGS));
                    localStorage.setItem(COLLECTIVE_BOXES_STORAGE_KEY, JSON.stringify(COLLECTIVE_BOXES));
                } catch (e) {
                    console.error("Error al guardar ajustes en localStorage:", e);
                }
            }

            function loadSettingsFromLocalStorage() {
                try {
                    const savedMachineSettings = localStorage.getItem(SETTINGS_STORAGE_KEY);
                    if (savedMachineSettings) {
                        const parsedSettings = JSON.parse(savedMachineSettings);
                        if (parsedSettings.DIE_CUTTERS && parsedSettings.PRINTERS) {
                            PROCESS_MACHINES = parsedSettings;
                        }
                    }
                    const savedPalletSettings = localStorage.getItem(PALLET_SETTINGS_STORAGE_KEY);
                    if (savedPalletSettings) {
                        PALLETIZING_SETTINGS = JSON.parse(savedPalletSettings);
                    }
                    const savedGeneralSettings = localStorage.getItem(GENERAL_SETTINGS_STORAGE_KEY);
                    if (savedGeneralSettings) {
                        const parsed = JSON.parse(savedGeneralSettings);
                        if (parsed.adhesives) GENERAL_SETTINGS.adhesives = { ...GENERAL_SETTINGS.adhesives, ...parsed.adhesives };
                        if (parsed.mediumFactors) GENERAL_SETTINGS.mediumFactors = { ...GENERAL_SETTINGS.mediumFactors, ...parsed.mediumFactors };
                        if (parsed.automaticBottomCompensation !== undefined) GENERAL_SETTINGS.automaticBottomCompensation = parsed.automaticBottomCompensation; // <-- NUEVO
                        if (parsed.foldingCartonGrammage) {
                            for (const paperType in parsed.foldingCartonGrammage) {
                                if (GENERAL_SETTINGS.foldingCartonGrammage[paperType]) {
                                    GENERAL_SETTINGS.foldingCartonGrammage[paperType] = { ...GENERAL_SETTINGS.foldingCartonGrammage[paperType], ...parsed.foldingCartonGrammage[paperType] }
                                } else {
                                    GENERAL_SETTINGS.foldingCartonGrammage[paperType] = parsed.foldingCartonGrammage[paperType];
                                }
                            }
                        }
                    }
                    const savedBoxes = localStorage.getItem(COLLECTIVE_BOXES_STORAGE_KEY);
                    if (savedBoxes) {
                        const parsedBoxes = JSON.parse(savedBoxes);
                        if (Array.isArray(parsedBoxes)) {
                            COLLECTIVE_BOXES = parsedBoxes;
                        } else {
                            COLLECTIVE_BOXES = JSON.parse(JSON.stringify(DEFAULT_COLLECTIVE_BOXES));
                        }
                    } else {
                        COLLECTIVE_BOXES = JSON.parse(JSON.stringify(DEFAULT_COLLECTIVE_BOXES));
                    }
                } catch (e) {
                    console.error("Error al cargar o parsear ajustes de localStorage:", e);
                    PROCESS_MACHINES = JSON.parse(JSON.stringify(DEFAULT_PROCESS_MACHINES));
                    COLLECTIVE_BOXES = JSON.parse(JSON.stringify(DEFAULT_COLLECTIVE_BOXES));
                }
            }

            function saveHistoryToLocalStorage() {
                try {
                    localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(state.history));
                } catch (e) {
                    console.error("Error al guardar historial:", e);
                }
            }

            function loadHistoryFromLocalStorage() {
                try {
                    const savedHistory = localStorage.getItem(HISTORY_STORAGE_KEY);
                    if (savedHistory) {
                        state.history = JSON.parse(savedHistory);
                    }
                } catch (e) {
                    state.history = [];
                    console.error("Error al cargar historial:", e);
                }
            }

            // Funci√≥n auxiliar para obtener el gramaje de la caja colectiva
            function getCollectiveBoxGrammage(box) {
                // Asume un gramaje est√°ndar para liner y medium basado en ECT y Flauta.
                // Esto es una simplificaci√≥n, ya que el peso real de la caja deber√≠a ser un dato de dise√±o (SKU).
                // Usaremos ECT y Flauta para estimar el peso total de la composici√≥n (suministrado por el usuario en los ajustes).
                const FLUTE_FACTOR = GENERAL_SETTINGS.mediumFactors[box.flauta] || 1;

                // Dado que solo se tiene ECT y Flauta en el objeto box, se necesita una estimaci√≥n.
                // Simplificaci√≥n: usaremos ECT * 15 como un factor de conversi√≥n muy burdo (s√≥lo para fines de este ejercicio)
                if (box.flauta) {
                    return (box.ect * 15) * FLUTE_FACTOR;
                }

                return 500; // Gramaje de fallback (g/m¬≤)
            }


            // --- M√ìDULO DE C√ÅLCULO ---
            const Calculator = {
                getOptimizedResults() {
                    const inputs = this.getValidatedInputs();
                    if (!inputs) return null;

                    let results;
                    if (inputs.calculationModeToggle) {
                        results = this.calculateForCustomSheet(inputs);
                    } else {
                        results = this.calculateForOptimalSheet(inputs);
                    }

                    if (results) {
                        if (inputs.gluing && inputs.useCollectiveBox) {
                            const collectiveBoxData = this.findBestCollectiveBox(results, inputs);
                            if (results.rankedMachines) {
                                results.rankedMachines.forEach(machine => machine.collectiveBoxData = collectiveBoxData);
                            } else {
                                results.collectiveBoxData = collectiveBoxData;
                            }
                        }
                        results.palletizingResult = this.getPalletizeResults(results);
                    }

                    return results;
                },

                // **********************************************
                // FUNCI√ìN PARA CALCULAR EL PESO DE LA CAJA COLECTIVA
                // **********************************************
                calculateCollectiveBoxWeight(box, pieceGrossWeightKg, pieceCapacity) {
                    const largo = box.largo / 1000; // m
                    const ancho = box.ancho / 1000; // m
                    const alto = box.alto / 1000;   // m

                    // Estimaci√≥n del √°rea de cart√≥n de la caja (f√≥rmula RSC simplificada A=2(LW+LH+WH))
                    // Se asume un pliego plano para la caja colectiva (incluye desperdicio de fabricaci√≥n)
                    const boxAreaM2 = (2 * (largo * ancho + largo * alto + ancho * alto)) * 1.05; // +5% por pesta√±as y desperdicio

                    // Obtener el gramaje estimado de la caja (g/m¬≤)
                    const boxGrammageG_M2 = getCollectiveBoxGrammage(box);

                    // Peso de la caja vac√≠a (kg)
                    const emptyBoxWeightKg = (boxAreaM2 * boxGrammageG_M2) / 1000;

                    // Peso Neto de las piezas (kg)
                    const piecesNetWeightKg = pieceGrossWeightKg * pieceCapacity;

                    // Peso Bruto Total (kg)
                    const totalGrossWeightKg = emptyBoxWeightKg + piecesNetWeightKg;

                    return {
                        emptyBoxWeightKg: emptyBoxWeightKg,
                        piecesNetWeightKg: piecesNetWeightKg,
                        totalGrossWeightKg: totalGrossWeightKg
                    };
                },


                findBestCollectiveBox(result, inputs) {
                    const toMM = (value, unit) => (unit === 'cm' ? value * 10 : unit === 'in' ? value * 25.4 : value);

                    const flatDim1 = toMM(inputs.cutWidth, inputs.unit);
                    const flatDim2 = toMM(inputs.cutHeight, inputs.unit);
                    const flap = toMM(inputs.glueFlapWidth, inputs.unit);

                    const flatLong = Math.max(flatDim1, flatDim2);
                    const flatShort = Math.min(flatDim1, flatDim2);

                    const pieceH = (flatLong - flap) / 2;
                    const pieceL = flatShort;

                    let pieceThickness = 0;
                    const isAutomaticBottom = inputs.isAutomaticBottom;
                    let nominalThickness = 0;

                    if (inputs.material === 'microcorrugado') {
                        nominalThickness = PALLETIZING_SETTINGS.MATERIAL_THICKNESS.FLUTES[inputs.flute] || 0;
                    } else {
                        nominalThickness = (PALLETIZING_SETTINGS.MATERIAL_THICKNESS.POINTS_TO_MM * inputs.foldingCartonWeight);
                    }

                    if (nominalThickness > 0) {
                        if (isAutomaticBottom) {
                            // Fondo Autom√°tico: 5 capas nominales + Compensaci√≥n Fija
                            const layers = 5;
                            const compensation = GENERAL_SETTINGS.automaticBottomCompensation || 0;
                            pieceThickness = (nominalThickness * layers) + compensation;
                        } else {
                            // Pegado Lineal: 2 capas nominales + 50% de holgura
                            const layers = 2;
                            const holgura = nominalThickness * 0.5;
                            pieceThickness = (nominalThickness * layers) + holgura;
                        }
                    }

                    if (pieceL <= 0 || pieceH <= 0 || pieceThickness <= 0) return { best: null, all: [] };


                    let compatibleBoxes = COLLECTIVE_BOXES.map(box => {
                        // pieceH es el alto doblado (Largo de la pieza - Pesta√±a) / 2
                        // box.alto es la altura de la caja colectiva
                        if (pieceH > box.alto) {
                            return null;
                        }

                        let capacity = 0;
                        let waste = Infinity;
                        let finalFitDim;

                        // Acomodo 1: Ancho de la caja / Espesor
                        if (pieceL <= box.largo) {
                            capacity = Math.floor(box.ancho / pieceThickness);
                            waste = (box.largo * box.alto) - (pieceL * pieceH);
                            finalFitDim = 'ancho';
                        }

                        // Acomodo 2 (Rotado): Largo de la caja / Espesor
                        if (pieceL <= box.ancho) {
                            const capacityRotated = Math.floor(box.largo / pieceThickness);
                            const wasteRotated = (box.ancho * box.alto) - (pieceL * pieceH);

                            if (wasteRotated < waste) {
                                capacity = capacityRotated;
                                waste = wasteRotated;
                                finalFitDim = 'largo';
                            }
                        }

                        if (capacity > 0) {
                            const weightData = this.calculateCollectiveBoxWeight(box, result.pieceGrossWeightKg || 0, capacity);

                            return { ...box, capacity, waste, finalFitDim, weightData };
                        }
                        return null;
                    }).filter(Boolean);

                    compatibleBoxes.sort((a, b) => a.waste - b.waste);

                    return {
                        best: compatibleBoxes.length > 0 ? compatibleBoxes[0] : null,
                        all: compatibleBoxes,
                        foldedPiece: { foldedL: pieceL, foldedH: pieceH, pieceThickness }
                    };
                },

                calculateWeightAndArea(result, inputs) {
                    if (!result || !result.drawing || result.cuts === 0) {
                        return result;
                    }

                    // √Årea total del pliego sugerido (incluye m√°rgenes, pinzas y trim)
                    const sheetW_m = result.drawing.suggestedSheetW / 1000;
                    const sheetH_m = result.drawing.suggestedSheetH / 1000;
                    const sheetArea_m2 = sheetW_m * sheetH_m;
                    let totalGrammage_g_m2 = 0;

                    if (inputs.material === 'microcorrugado' && inputs.ectCheckbox) {
                        const linerExt_g = parseFloat(inputs.linerExt) || 0;
                        const medium_g = parseFloat(inputs.medium) || 0;
                        const linerInt_g = parseFloat(inputs.linerInt) || 0;

                        if (linerExt_g <= 0 || medium_g <= 0 || linerInt_g <= 0) {
                            return result; // Not enough data
                        }

                        const fluteFactor = GENERAL_SETTINGS.mediumFactors[inputs.flute] || 1;
                        const effectiveMedium_g = medium_g * fluteFactor;
                        const paperGrammage_g_m2 = linerExt_g + effectiveMedium_g + linerInt_g;
                        const adhesiveGrammage_g_m2 = GENERAL_SETTINGS.adhesives.starch + GENERAL_SETTINGS.adhesives.pva;
                        totalGrammage_g_m2 = paperGrammage_g_m2 + adhesiveGrammage_g_m2;

                    } else if (inputs.material === 'plegadizo') {
                        const paperType = inputs.foldingCartonType;
                        const points = inputs.foldingCartonWeight;
                        if (GENERAL_SETTINGS.foldingCartonGrammage[paperType] && GENERAL_SETTINGS.foldingCartonGrammage[paperType][points]) {
                            totalGrammage_g_m2 = GENERAL_SETTINGS.foldingCartonGrammage[paperType][points];
                        }
                    }

                    if (totalGrammage_g_m2 > 0 && sheetArea_m2 > 0) {
                        const sheetGrossWeight_g = totalGrammage_g_m2 * sheetArea_m2;
                        // El peso bruto de la pieza incluye el peso del trim por imposici√≥n:
                        // Peso_Total_Pliego / N√∫mero_de_Cortes
                        const pieceGrossWeight_g = sheetGrossWeight_g / result.cuts;

                        result.pieceGrossWeightKg = pieceGrossWeight_g / 1000;
                        result.sheetGrossWeightKg = sheetGrossWeight_g / 1000;
                        result.sheetAreaM2 = sheetArea_m2;
                    } else {
                        delete result.pieceGrossWeightKg;
                        delete result.sheetGrossWeightKg;
                        delete result.sheetAreaM2;
                    }

                    return result;
                },

                calculateForCustomSheet(inputs) {
                    const toMM = (value, unit) => (unit === 'cm' ? value * 10 : unit === 'in' ? value * 25.4 : value);

                    const pieceW_hilo = toMM(inputs.cutWidth, inputs.unit);
                    const pieceH_contrahilo = toMM(inputs.cutHeight, inputs.unit);
                    const gutter = toMM(inputs.gutter, inputs.unit);
                    const sideMargins = toMM(inputs.sideMargins, inputs.unit);
                    const topGripper = toMM(inputs.topGripper, inputs.unit);
                    const bottomGripper = toMM(inputs.bottomGripper, inputs.unit);

                    const sheetW = toMM(inputs.customSheetWidth, inputs.unit);
                    const sheetH = toMM(inputs.customSheetHeight, inputs.unit);

                    const usableSheetW = Math.max(0, sheetW - (sideMargins * 2));
                    const usableSheetH = Math.max(0, sheetH - topGripper - bottomGripper);

                    // Correctly assign piece dimensions for visual layout based on acomodo
                    const grainHorizontalLayoutCalc = this.calculateLayout(usableSheetW, usableSheetH, pieceW_hilo, pieceH_contrahilo, gutter);
                    const grainVerticalLayoutCalc = this.calculateLayout(usableSheetW, usableSheetH, pieceH_contrahilo, pieceW_hilo, gutter);

                    let bestLayout;
                    let finalOrientation;
                    switch (inputs.acomodo) {
                        case 'horizontal':
                            bestLayout = { ...grainHorizontalLayoutCalc, pieceW: pieceW_hilo, pieceH: pieceH_contrahilo };
                            finalOrientation = 'Hilo Horizontal';
                            break;
                        case 'vertical':
                            bestLayout = { ...grainVerticalLayoutCalc, pieceW: pieceH_contrahilo, pieceH: pieceW_hilo };
                            finalOrientation = 'Hilo Vertical';
                            break;
                        case 'optimo':
                        default:
                            if (grainHorizontalLayoutCalc.cuts >= grainVerticalLayoutCalc.cuts) {
                                bestLayout = { ...grainHorizontalLayoutCalc, pieceW: pieceW_hilo, pieceH: pieceH_contrahilo };
                                finalOrientation = 'Hilo Horizontal';
                            } else {
                                // FIX: Corregido el typo 'pieceW_ilo' a 'pieceW_hilo' (Error de ejecuci√≥n en versi√≥n anterior)
                                bestLayout = { ...grainVerticalLayoutCalc, pieceW: pieceH_contrahilo, pieceH: pieceW_hilo };
                                finalOrientation = 'Hilo Vertical';
                            }
                            break;
                    }


                    if (bestLayout.cuts === 0) {
                        return { isCustom: true, cuts: 0, compatiblePrinters: [], compatibleDieCutters: [], userInputs: inputs };
                    }

                    const compatiblePrinters = PROCESS_MACHINES.PRINTERS.filter(p => (p.maxWidth >= sheetW && p.maxHeight >= sheetH && p.minWidth <= sheetW && p.minHeight <= sheetH));

                    let availableDieCutters = [];
                    if (inputs.material === 'microcorrugado') {
                        availableDieCutters = PROCESS_MACHINES.DIE_CUTTERS.filter(m => m.name === 'Vision-160');
                    } else {
                        availableDieCutters = PROCESS_MACHINES.DIE_CUTTERS.filter(m => m.name !== 'Vision-160');
                    }
                    const compatibleDieCutters = availableDieCutters.filter(dc => (dc.maxWidth >= sheetW && dc.maxHeight >= sheetH));

                    const usedAreaW = (bestLayout.cols * bestLayout.pieceW) + (Math.max(0, bestLayout.cols - 1) * gutter);
                    const usedAreaH = (bestLayout.rows * bestLayout.pieceH) + (Math.max(0, bestLayout.rows - 1) * gutter);

                    let finalResult = {
                        isCustom: true,
                        cuts: bestLayout.cuts,
                        orientation: finalOrientation,
                        compatiblePrinters: compatiblePrinters.map(p => p.name),
                        compatibleDieCutters: compatibleDieCutters.map(dc => dc.name),
                        userInputs: inputs,
                        drawing: {
                            sheetW, sheetH, sideMargins, topGripper, bottomGripper,
                            cols: bestLayout.cols, rows: bestLayout.rows, gutter,
                            pieceW: bestLayout.pieceW, pieceH: bestLayout.pieceH,
                            usedAreaW, usedAreaH, suggestedSheetW: sheetW, suggestedSheetH: sheetH,
                            unit: inputs.unit,
                        }
                    };

                    finalResult = this.calculateWeightAndArea(finalResult, inputs);
                    return finalResult;
                },

                calculateForOptimalSheet(inputs) {
                    const toMM = (value, unit) => (unit === 'cm' ? value * 10 : unit === 'in' ? value * 25.4 : value);
                    const pieceW_hilo = toMM(inputs.cutWidth, inputs.unit);
                    const pieceH_contrahilo = toMM(inputs.cutHeight, inputs.unit);
                    const gutter = toMM(inputs.gutter, inputs.unit);
                    const sideMargins = toMM(inputs.sideMargins, inputs.unit);
                    const topGripper = toMM(inputs.topGripper, inputs.unit);
                    const bottomGripper = toMM(inputs.bottomGripper, inputs.unit);

                    let analysisNotes = [];

                    const allPrinterResults = PROCESS_MACHINES.PRINTERS.map(printer => {
                        const usableSheetW = Math.max(0, printer.maxWidth - (sideMargins * 2));
                        const usableSheetH = Math.max(0, printer.maxHeight - topGripper - bottomGripper);

                        const grainHorizontalLayoutCalc = this.calculateLayout(usableSheetW, usableSheetH, pieceW_hilo, pieceH_contrahilo, gutter);
                        const grainVerticalLayoutCalc = this.calculateLayout(usableSheetW, usableSheetH, pieceH_contrahilo, pieceW_hilo, gutter);

                        const grainHorizontalLayout = { ...grainHorizontalLayoutCalc, pieceW: pieceW_hilo, pieceH: pieceH_contrahilo, orientation: 'Hilo Horizontal' };
                        const grainVerticalLayout = { ...grainVerticalLayoutCalc, pieceW: pieceH_contrahilo, pieceH: pieceW_hilo, orientation: 'Hilo Vertical' };

                        let layoutsToTry = [];
                        switch (inputs.acomodo) {
                            case 'horizontal':
                                layoutsToTry.push(grainHorizontalLayout);
                                break;
                            case 'vertical':
                                layoutsToTry.push(grainVerticalLayout);
                                break;
                            case 'optimo':
                            default:
                                if (grainHorizontalLayout.cuts >= grainVerticalLayout.cuts) {
                                    layoutsToTry.push(grainHorizontalLayout);
                                    if (grainVerticalLayout.cuts === grainHorizontalLayout.cuts && grainVerticalLayout.cuts > 0) {
                                        layoutsToTry.push(grainVerticalLayout);
                                    }
                                } else {
                                    layoutsToTry.push(grainVerticalLayout);
                                }
                                break;
                        }

                        const bestInitialLayout = layoutsToTry[0];
                        if (!bestInitialLayout || bestInitialLayout.cuts === 0) return null;

                        let availableDieCutters = [];
                        if (inputs.material === 'microcorrugado') {
                            availableDieCutters = PROCESS_MACHINES.DIE_CUTTERS.filter(m => m.name === 'Vision-160');
                        } else {
                            availableDieCutters = PROCESS_MACHINES.DIE_CUTTERS.filter(m => m.name !== 'Vision-160');
                        }

                        let finalValidResult = null;
                        const isSheetValidForPrinter = (w, h, p) => (w >= (p.minWidth || 0) && w <= p.maxWidth && h >= (p.minHeight || 0) && h <= p.maxHeight);

                        outerLoop:
                        for (let cuts = bestInitialLayout.cuts; cuts > 0; cuts--) {
                            const factors = [];
                            for (let i = 1; i <= Math.sqrt(cuts); i++) {
                                if (cuts % i === 0) {
                                    factors.push([i, cuts / i]);
                                    if (i * i !== cuts) {
                                        factors.push([cuts / i, i]);
                                    }
                                }
                            }

                            for (const [cols, rows] of factors) {
                                for (const layoutTemplate of layoutsToTry) {
                                    const currentLayout = { ...layoutTemplate, cols, rows, cuts };
                                    const check = this.findCompatibleDieCutter(currentLayout, availableDieCutters, gutter, sideMargins, topGripper, bottomGripper);

                                    if (check.compatibleDieCutter && isSheetValidForPrinter(check.suggestedSheetW, check.suggestedSheetH, printer)) {
                                        const aprovechamiento = (check.suggestedSheetW * check.suggestedSheetH > 0) ? ((check.usedAreaW * check.usedAreaH) / (check.suggestedSheetW * check.suggestedSheetH)) * 100 : 0;

                                        let result = {
                                            name: printer.name,
                                            cuts: currentLayout.cuts,
                                            aprovechamiento,
                                            orientation: currentLayout.orientation,
                                            associatedDieCutter: check.compatibleDieCutter.name,
                                            drawing: {
                                                sheetW: printer.maxWidth, sheetH: printer.maxHeight, sideMargins, topGripper, bottomGripper,
                                                cols: currentLayout.cols, rows: currentLayout.rows, gutter,
                                                pieceW: currentLayout.pieceW, pieceH: currentLayout.pieceH,
                                                usedAreaW: check.usedAreaW, usedAreaH: check.usedAreaH,
                                                suggestedSheetW: check.suggestedSheetW, suggestedSheetH: check.suggestedSheetH,
                                                unit: inputs.unit
                                            }
                                        };
                                        finalValidResult = this.calculateWeightAndArea(result, inputs);

                                        if (finalValidResult.cuts < bestInitialLayout.cuts) {
                                            analysisNotes.push(`Para ${printer.name}, el acomodo ideal de ${bestInitialLayout.cuts} piezas era incompatible con las m√°quinas. El m√°ximo acomodo compatible es de ${finalValidResult.cuts} piezas.`);
                                        }

                                        break outerLoop;
                                    }
                                }
                            }
                        }
                        return finalValidResult;
                    }).filter(Boolean);

                    // Remove duplicate notes
                    const uniqueNotes = [...new Set(analysisNotes)];

                    allPrinterResults.sort((a, b) => b.cuts - a.cuts || a.drawing.suggestedSheetW * a.drawing.suggestedSheetH - b.drawing.suggestedSheetW * b.drawing.suggestedSheetH);
                    const bestOption = allPrinterResults.length > 0 ? allPrinterResults[0] : null;
                    const processRoute = this.generateProcessRoute(bestOption, inputs);
                    return { isCustom: false, rankedMachines: allPrinterResults, processRoute, userInputs: inputs, analysisNotes: uniqueNotes };
                },
                findCompatibleDieCutter(layout, availableDieCutters, gutter, sideMargins, topGripper, bottomGripper) {
                    const pieceForDrawingW = layout.pieceW;
                    const pieceForDrawingH = layout.pieceH;
                    const usedAreaW = (layout.cols * pieceForDrawingW) + (Math.max(0, layout.cols - 1) * gutter);
                    // FIX: Corregido 'rows' a 'layout.rows' (Error de alcance de variable)
                    const usedAreaH = (layout.rows * pieceForDrawingH) + (Math.max(0, layout.rows - 1) * gutter);
                    const suggestedSheetW = usedAreaW + (sideMargins * 2);
                    const suggestedSheetH = usedAreaH + topGripper + bottomGripper;
                    const compatibleDieCutters = availableDieCutters.filter(dc => (dc.maxWidth >= suggestedSheetW && dc.maxHeight >= suggestedSheetH) || (dc.maxWidth >= suggestedSheetH && dc.maxHeight >= suggestedSheetW));
                    if (compatibleDieCutters.length === 0) return { compatibleDieCutter: null };
                    compatibleDieCutters.sort((a, b) => (a.maxWidth * a.maxHeight) - (b.maxWidth * b.maxHeight));
                    return { compatibleDieCutter: compatibleDieCutters[0], suggestedSheetW, suggestedSheetH, usedAreaW, usedAreaH };
                },
                generateProcessRoute(bestOption, inputs) {
                    if (!bestOption) return [];
                    let route = [];
                    route.push({ process: 'Impresi√≥n', machine: bestOption.name });
                    if (inputs.material === 'microcorrugado') {
                        route.push({ process: 'Laminado', machine: PROCESS_MACHINES.LAMINATORS[0].name });
                    }
                    route.push({ process: 'Troquelado', machine: bestOption.associatedDieCutter || 'Ninguna compatible' });
                    if (inputs.gluing) {
                        route.push({ process: 'Pegado', machine: inputs.gluingMachine });
                    }
                    return route;
                },
                calculateLayout(sheetW, sheetH, pieceW, pieceH, gutter) {
                    const count = (s, p, g) => (p <= 0 || s < p) ? 0 : Math.floor((s + g) / (p + g));
                    return { cuts: count(sheetW, pieceW, gutter) * count(sheetH, pieceH, gutter), cols: count(sheetW, pieceW, gutter), rows: count(sheetH, pieceH, gutter) };
                },
                getValidatedInputs() {
                    const values = {};
                    let allValid = true;
                    for (const key in DOM.inputs) {
                        const inputEl = DOM.inputs[key];
                        if (!inputEl) continue;
                        // Skip validation for hidden elements if they are not checkboxes
                        if (inputEl.offsetParent === null && inputEl.type !== 'checkbox') continue;

                        if (inputEl.type === 'checkbox') {
                            values[key] = inputEl.checked;
                        } else if (inputEl.tagName.toLowerCase() === 'input' && inputEl.type === 'text') { // Updated to check text inputs for numbers
                            let value = parseFloat(inputEl.value);
                            if ((inputEl.required && (isNaN(value) || inputEl.value.trim() === '')) || value < 0) {
                                allValid = false;
                                inputEl.classList.add('invalid-input');
                            } else {
                                inputEl.classList.remove('invalid-input');
                            }
                            values[key] = value;
                        } else {
                            values[key] = inputEl.value;
                        }
                    }
                    return allValid ? values : null;
                },

                getPalletizeResults(resultsData, pattern = 'recto') {
                    if (!resultsData) return null;

                    const inputs = resultsData.userInputs;
                    const bestResult = resultsData.isCustom ? resultsData : (resultsData.rankedMachines?.[0] || null);
                    if (!bestResult) return null;

                    const bestBox = bestResult?.collectiveBoxData?.best;
                    const useCollectiveBoxLogic = inputs.gluing && inputs.useCollectiveBox && bestBox;

                    let palletPieceW, palletPieceH, itemHeight, itemsPerUnit, totalPieces;
                    let palletizingMode, itemsPerLayerLabel, bundleInfo = null;
                    let layersPerPallet;

                    const isBundledMicro = inputs.material === 'microcorrugado';

                    if (useCollectiveBoxLogic) {
                        palletizingMode = `Cajas (${bestBox.material})`;
                        itemsPerLayerLabel = 'Cajas / Cama';
                        palletPieceW = bestBox.largo;
                        palletPieceH = bestBox.ancho;
                        itemHeight = bestBox.alto;
                        itemsPerUnit = bestBox.capacity;
                    } else if (isBundledMicro) {
                        const pieceThickness = PALLETIZING_SETTINGS.MATERIAL_THICKNESS.FLUTES[inputs.flute] || 0;
                        palletPieceW = toMM(inputs.cutWidth, inputs.unit);
                        palletPieceH = toMM(inputs.cutHeight, inputs.unit);

                        let bundleSize;
                        if (inputs.gluing) { // Pegado = Atado Doble
                            const bundleSizes = { 'Flauta E': 100, 'Flauta B': 60, 'Flauta C': 50 };
                            bundleSize = bundleSizes[inputs.flute] || 2;
                            palletizingMode = 'Atados (Pegado)';
                        } else { // Sin Pegado = Atado Sencillo
                            const bundleSizes = { 'Flauta E': 50, 'Flauta B': 30, 'Flauta C': 25 };
                            bundleSize = bundleSizes[inputs.flute] || 1;
                            palletizingMode = 'Atados (Sin Pegar)';
                        }

                        itemsPerLayerLabel = 'Atados / Cama';
                        itemHeight = pieceThickness * bundleSize;
                        itemsPerUnit = bundleSize;
                        bundleInfo = `${bundleSize} pzs/atado`;

                    } else { // Plegadizo y otros casos sin atado
                        palletizingMode = 'Piezas Individuales';
                        itemsPerLayerLabel = 'Piezas / Cama';
                        const originalPieceW = toMM(inputs.cutWidth, inputs.unit);
                        const originalPieceH = toMM(inputs.cutHeight, inputs.unit);

                        palletPieceW = originalPieceW;
                        palletPieceH = originalPieceH;

                        let nominalThickness = 0;
                        const isAutomaticBottom = inputs.isAutomaticBottom;

                        if (inputs.material === 'microcorrugado') {
                            nominalThickness = PALLETIZING_SETTINGS.MATERIAL_THICKNESS.FLUTES[inputs.flute] || 0;
                        } else {
                            nominalThickness = (inputs.foldingCartonWeight || 0) * PALLETIZING_SETTINGS.MATERIAL_THICKNESS.POINTS_TO_MM;
                        }

                        if (inputs.gluing && inputs.glueFlapWidth > 0) {
                            const glueFlapW_mm = toMM(inputs.glueFlapWidth, inputs.unit);
                            if (originalPieceH >= originalPieceW) {
                                palletPieceH = (originalPieceH - glueFlapW_mm) / 2;
                            } else {
                                palletPieceW = (originalPieceW - glueFlapW_mm) / 2;
                            }

                            if (isAutomaticBottom) {
                                // Fondo Autom√°tico: 5 capas nominales + Compensaci√≥n Fija
                                const layers = 5;
                                const compensation = GENERAL_SETTINGS.automaticBottomCompensation || 0;
                                itemHeight = (nominalThickness * layers) + compensation;
                            } else {
                                // Pegado Lineal: 2 capas nominales + 50% de holgura
                                const layers = 2;
                                const holgura = nominalThickness * 0.5;
                                itemHeight = (nominalThickness * layers) + holgura;
                            }
                        } else {
                            itemHeight = nominalThickness; // Pieza individual sin doblar
                        }

                        itemsPerUnit = 1;
                    }

                    if (itemHeight <= 0) return null;

                    const pallet = PALLETIZING_SETTINGS.pallets[0];
                    const palletW = pallet.widthIn * 25.4;
                    const palletH = pallet.heightIn * 25.4;

                    const maxTotalHeightMm = PALLETIZING_SETTINGS.maxTotalHeightCm * 10;
                    const palletBaseHeightMm = PALLETIZING_SETTINGS.standardPalletHeightCm * 10;
                    const usableStackHeightMm = maxTotalHeightMm - palletBaseHeightMm;

                    if (usableStackHeightMm <= 0) return null;

                    let itemsPerLayer = 0;
                    if (pattern === 'recto') {
                        const layout1 = Math.floor(palletW / palletPieceW) * Math.floor(palletH / palletPieceH);
                        const layout2 = Math.floor(palletW / palletPieceH) * Math.floor(palletH / palletPieceW);
                        itemsPerLayer = Math.max(layout1, layout2);
                    } else { // columnar
                        itemsPerLayer = Math.max(
                            calculateColumnarFit(palletW, palletH, palletPieceW, palletPieceH),
                            calculateColumnarFit(palletH, palletW, palletPieceW, palletPieceH)
                        );
                    }

                    let materialHeightMm;

                    if (inputs.material === 'plegadizo' && inputs.usePlegadizoBundles && itemHeight > 0) {
                        palletizingMode = 'Atados (Plegadizo)';
                        itemsPerLayerLabel = 'Piezas / Cama';

                        const regularBundleHeight = 200; // 20cm
                        const minLastBundleHeight = 150; // 15cm
                        const minRecalcHeight = 180;     // 18cm

                        const numRegularBundles = Math.floor(usableStackHeightMm / regularBundleHeight);
                        const lastBundleHeight = usableStackHeightMm % regularBundleHeight;

                        if (lastBundleHeight > 0 && lastBundleHeight < minLastBundleHeight) {
                            let totalBundlesToCreate = numRegularBundles > 0 ? numRegularBundles : 1;
                            let newHeight = usableStackHeightMm / totalBundlesToCreate;
                            if (newHeight < minRecalcHeight && totalBundlesToCreate > 1) {
                                totalBundlesToCreate--;
                            }
                            bundleInfo = `${totalBundlesToCreate} atado(s) de ${(usableStackHeightMm / totalBundlesToCreate / 10).toFixed(1)} cm`;
                            layersPerPallet = totalBundlesToCreate;
                        } else {
                            layersPerPallet = numRegularBundles + (lastBundleHeight > 0 ? 1 : 0);
                            if (layersPerPallet === 0 && usableStackHeightMm > 0) layersPerPallet = 1;

                            if (numRegularBundles > 0 && lastBundleHeight > 0) {
                                bundleInfo = `${numRegularBundles} atado(s) de 20.0 cm y 1 atado de ${(lastBundleHeight / 10).toFixed(1)} cm`;
                            } else if (numRegularBundles > 0) {
                                bundleInfo = `${numRegularBundles} atado(s) de 20.0 cm`;
                            } else if (usableStackHeightMm > 0) {
                                bundleInfo = `1 atado de ${(usableStackHeightMm / 10).toFixed(1)} cm`;
                            }
                        }

                        const totalStackablePieces = Math.floor(usableStackHeightMm / itemHeight);
                        totalPieces = totalStackablePieces * itemsPerLayer;
                        materialHeightMm = usableStackHeightMm;

                    } else {
                        layersPerPallet = Math.floor(usableStackHeightMm / itemHeight);
                        totalPieces = (itemsPerLayer * layersPerPallet) * itemsPerUnit;
                        materialHeightMm = layersPerPallet * itemHeight;
                    }

                    if (itemsPerLayer === 0 || (layersPerPallet <= 0 && !(inputs.material === 'plegadizo' && inputs.usePlegadizoBundles))) return null;

                    return {
                        palletName: pallet.name,
                        piecesPerLayer: itemsPerLayer,
                        layersPerPallet,
                        totalPieces,
                        materialHeightCm: materialHeightMm / 10,
                        finalHeightCm: (materialHeightMm + palletBaseHeightMm) / 10,
                        mode: palletizingMode,
                        itemsPerLayerLabel,
                        palletW_mm: palletW,
                        palletH_mm: palletH,
                        itemW_mm: palletPieceW,
                        itemH_mm: palletPieceH,
                        bundleInfo: bundleInfo
                    };
                },
            };

            // --- M√ìDULO DE INTERFAZ DE USUARIO (UI) ---

            const UI = {
                updateResults(data) {
                    if (!data) return;
                    state.lastValidResults = data;

                    DOM.modal.folioInput.value = '';
                    DOM.modal.clienteInput.value = '';
                    DOM.modal.folioInput.classList.remove('invalid-input');

                    if (data.isCustom) {
                        this.updateCustomResults(data);
                        this.updateAnalysisNotes([]); // No notes for custom mode
                    } else {
                        this.updateOptimalResults(data);
                        this.updateAnalysisNotes(data.analysisNotes);
                    }
                    this.showModal();
                },

                updateOptimalResults(data) {
                    DOM.modal.resultsTitle.textContent = "Resultados de Optimizaci√≥n";
                    DOM.modal.rankingTitle.textContent = "Ranking de Impresoras";
                    this.updateRankingList(data.rankedMachines);
                    if (data.rankedMachines.length > 0) {
                        this.updatePreview(0);
                    } else {
                        this.updateProcessRoute([]);
                        this.clearPreview();
                    }
                },

                updateCustomResults(data) {
                    DOM.modal.resultsTitle.textContent = "Resultado en Pliego Manual";
                    DOM.modal.rankingTitle.textContent = "M√°quinas Compatibles";
                    DOM.modal.processRouteContainer.innerHTML = '';

                    if (data.cuts > 0) {
                        const sheetW = data.drawing.sheetW;
                        const sheetH = data.drawing.sheetH;
                        let rollWidthMm;
                        if (data.orientation === 'Hilo Vertical') {
                            rollWidthMm = sheetW;
                        } else { // Hilo Horizontal
                            rollWidthMm = sheetH;
                        }
                        const rollWidthIn = rollWidthMm / 25.4;

                        DOM.modal.rankingContainer.innerHTML = `
                    <div class="p-4 bg-white rounded-lg border-l-4 border-green-500">
                        <p class="text-3xl font-bold text-blue-600 text-center">${data.cuts} <span class="text-xl font-medium text-gray-700">cortes</span></p>
                        <p class="text-center text-sm text-gray-600 mt-1">En pliego de ${sheetW.toFixed(1)} x ${sheetH.toFixed(1)} ${data.drawing.unit}</p>
                        <p class="text-center text-sm text-gray-600 mt-1">Ancho de Rollo: <b>${rollWidthIn.toFixed(2)}"</b></p>
                    </div>
                    <div class="mt-4">
                        <p class="font-semibold text-gray-800 mb-1">Impresoras Compatibles:</p>
                        <p class="text-sm text-gray-600">${data.compatiblePrinters.length > 0 ? data.compatiblePrinters.join(', ') : 'Ninguna'}</p>
                    </div>
                     <div class="mt-2">
                        <p class="font-semibold text-gray-800 mb-1">Troqueladoras Compatibles:</p>
                        <p class="text-sm text-gray-600">${data.compatibleDieCutters.length > 0 ? data.compatibleDieCutters.join(', ') : 'Ninguna'}</p>
                    </div>
                `;
                        this.updatePreview(); // Llama sin √≠ndice para modo manual
                    } else {
                        DOM.modal.rankingContainer.innerHTML = `<div class="p-4 text-center text-gray-500 bg-white rounded-lg">No caben piezas en el pliego especificado.</div>`;
                        this.clearPreview();
                    }
                },

                updateAnalysisNotes(notes) {
                    const container = DOM.modal.analysisNotesContainer;
                    const content = DOM.modal.analysisNotesContent;

                    if (notes && notes.length > 0) {
                        content.innerHTML = notes.map(note => `<p class="leading-relaxed">- ${note}</p>`).join('');
                        container.classList.remove('hidden');
                    } else {
                        content.innerHTML = '';
                        container.classList.add('hidden');
                    }
                },

                clearPreview() {
                    DOM.canvas.ctx.clearRect(0, 0, DOM.canvas.el.width, DOM.canvas.el.height);
                    DOM.modal.previewTitle.textContent = 'Sin vista previa';
                    DOM.modal.previewDetails.innerHTML = '';
                    DOM.modal.previewLegend.innerHTML = '';
                },

                displaySavedCalculation(entry) {
                    if (!entry || !entry.results) return;
                    Object.keys(entry.results.userInputs).forEach(key => {
                        if (DOM.inputs[key]) {
                            const inputEl = DOM.inputs[key];
                            const savedValue = entry.results.userInputs[key];
                            if (inputEl.type === 'checkbox') inputEl.checked = savedValue;
                            else inputEl.value = savedValue;
                        }
                    });
                    handleMaterialChange();
                    DOM.inputs.calculationModeToggle.dispatchEvent(new Event('change'));
                    DOM.inputs.gluing.dispatchEvent(new Event('change'));
                    DOM.inputs.ectCheckbox.dispatchEvent(new Event('change'));
                    DOM.inputs.isAutomaticBottom.dispatchEvent(new Event('change')); // <-- NUEVO

                    this.updateResults(entry.results);

                    DOM.modal.folioInput.value = entry.folio;
                    DOM.modal.clienteInput.value = entry.cliente;
                    DOM.modal.folioInput.classList.remove('invalid-input');

                    this.hideHistoryModal();
                },
                updateRankingList(rankedMachines) {
                    if (rankedMachines.length === 0) { DOM.modal.rankingContainer.innerHTML = `<div class="p-4 text-center text-gray-500 bg-white rounded-lg">No hay combinaciones de impresora/troqueladora compatibles.</div>`; return; }
                    DOM.modal.rankingContainer.innerHTML = rankedMachines.map((machine, index) => {
                        const isBest = index === 0;
                        // Usa una clase dedicada para la mejor opci√≥n para estilos especiales
                        const extraClass = isBest ? 'recommended-machine' : '';
                        // Usa un √≠cono de estrella o el n√∫mero de ranking
                        const trophyIcon = isBest ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>` : `<span class="font-bold text-lg text-gray-400 w-6 text-center">${index + 1}.</span>`;

                        const sheetW = machine.drawing.suggestedSheetW;
                        const sheetH = machine.drawing.suggestedSheetH;
                        let rollWidthMm;
                        if (machine.orientation === 'Hilo Vertical') {
                            rollWidthMm = sheetW;
                        } else { // Hilo Horizontal
                            rollWidthMm = sheetH;
                        }
                        const rollWidthIn = rollWidthMm / 25.4;

                        // Se agrega la clase extra y el badge de "Recomendada"
                        return `<div data-machine-index="${index}" class="p-4 bg-white rounded-lg border-l-4 rank-${(index % 4) + 1} transition-all duration-200 hover:shadow-xl cursor-pointer ${extraClass}"><div class="flex items-center gap-4"><div class="flex-shrink-0">${trophyIcon}</div><div class="flex-grow"><p class="font-bold text-lg text-gray-800 flex items-center gap-2">${machine.name} ${isBest ? '<span class="text-xs font-semibold bg-green-500 text-white px-2 py-0.5 rounded-full uppercase tracking-wider">Recomendada</span>' : ''}</p><div class="text-xs text-gray-500 mt-1"><span>Troqueladora: ${machine.associatedDieCutter}</span></div></div><div class="text-right flex-shrink-0 ml-auto"><p class="font-extrabold text-3xl text-blue-600">${machine.cuts}</p><p class="text-sm font-medium text-gray-600 -mt-1">cortes</p></div></div><div class="mt-3 space-y-2"><div class="text-xs"><div class="flex justify-between items-center mb-1"><span class="font-semibold text-gray-600">Aprov. √Årea √ötil</span><span class="font-bold text-indigo-600">${machine.aprovechamiento.toFixed(1)}%</span></div><div class="w-full bg-gray-200 rounded-full h-1.5"><div class="bg-indigo-500 h-1.5 rounded-full" style="width: ${machine.aprovechamiento}%"></div></div></div><div class="text-xs text-gray-600 bg-indigo-50 p-2 rounded space-y-1"><div><span class="font-bold text-indigo-800">Pliego Sugerido:</span> ${sheetW.toFixed(1)} x ${sheetH.toFixed(1)} ${machine.drawing.unit}</div><div><span class="font-bold text-indigo-800">Ancho de Rollo:</span> ${rollWidthIn.toFixed(2)}"</div></div></div></div>`;
                    }).join('');
                },
                updateProcessRoute(route) {
                    if (!route || route.length === 0) {
                        DOM.modal.processRouteContainer.innerHTML = '<p class="text-sm text-center text-gray-500">No se pudo generar una ruta.</p>';
                        return;
                    }
                    DOM.modal.processRouteContainer.innerHTML = route.map((step, index) => `<div class="flex items-center text-sm"><span class="flex-shrink-0 h-6 w-6 bg-indigo-500 text-white font-bold rounded-full flex items-center justify-center text-xs">${index + 1}</span><span class="ml-3 font-semibold text-gray-600">${step.process}:</span><span class="ml-auto font-medium text-gray-800">${step.machine}</span></div>`).join('');
                },
                updatePreview(index) {
                    const selectedData = index !== undefined ? state.lastValidResults.rankedMachines[index] : state.lastValidResults;
                    if (!selectedData) return;

                    if (state.lastValidResults && !state.lastValidResults.isCustom) {
                        const newProcessRoute = Calculator.generateProcessRoute(selectedData, state.lastValidResults.userInputs);
                        this.updateProcessRoute(newProcessRoute);
                        DOM.modal.rankingContainer.querySelectorAll('[data-machine-index]').forEach(el => el.classList.remove('selected-machine'));
                        DOM.modal.rankingContainer.querySelector(`[data-machine-index="${index}"]`)?.classList.add('selected-machine');
                    }

                    const weightContainer = DOM.modal.weightResultsContainer;
                    if (selectedData.sheetAreaM2 && selectedData.sheetGrossWeightKg && selectedData.pieceGrossWeightKg) {
                        weightContainer.innerHTML = `
                    <h3 class="font-semibold text-gray-800 mb-2">Detalles de Peso y √Årea</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-center text-sm">
                        <div class="bg-gray-100 p-2 rounded-lg">
                            <p class="font-medium text-gray-600">√Årea Pliego</p>
                            <p class="font-bold text-gray-800">${selectedData.sheetAreaM2.toFixed(4)} m¬≤</p>
                        </div>
                        <div class="bg-gray-100 p-2 rounded-lg">
                            <p class="font-medium text-gray-600">Peso Pliego (Bruto)</p>
                            <p class="font-bold text-gray-800">${selectedData.sheetGrossWeightKg.toFixed(4)} kg</p>
                        </div>
                        <div class="bg-indigo-100 p-2 rounded-lg">
                            <p class="font-medium text-indigo-800">Peso Pieza (Bruto)</p>
                            <p class="font-bold text-indigo-600">${selectedData.pieceGrossWeightKg.toFixed(4)} kg</p>
                        </div>
                    </div>
                `;
                        weightContainer.classList.remove('hidden');
                    } else {
                        weightContainer.innerHTML = '';
                        weightContainer.classList.add('hidden');
                    }

                    const boxContainer = DOM.modal.collectiveBoxContainer;
                    if (selectedData.collectiveBoxData && selectedData.collectiveBoxData.best) {
                        const bestBox = selectedData.collectiveBoxData.best;

                        // Extraer los pesos
                        const { emptyBoxWeightKg, piecesNetWeightKg, totalGrossWeightKg } = bestBox.weightData;

                        boxContainer.innerHTML = `
                    <h3 class="font-semibold text-gray-800 mb-2">Caja Colectiva Sugerida</h3>
                    <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-green-800">${bestBox.material}</p>
                                <p class="text-xs text-gray-600">${bestBox.largo} x ${bestBox.ancho} x ${bestBox.alto} mm</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-green-600">${bestBox.capacity}</p>
                                <p class="text-xs text-gray-600 -mt-1">piezas/caja</p>
                            </div>
                        </div>
                        
                        <!-- DETALLES DE PESO DE LA CAJA COLECTIVA -->
                        <div class="grid grid-cols-3 gap-2 mt-3 text-center text-xs">
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <p class="font-medium text-gray-600">Peso Caja Vac√≠a</p>
                                <p class="font-bold text-gray-800">${emptyBoxWeightKg.toFixed(3)} kg</p>
                            </div>
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <p class="font-medium text-gray-600">Peso Piezas Neto</p>
                                <p class="font-bold text-gray-800">${piecesNetWeightKg.toFixed(3)} kg</p>
                            </div>
                            <div class="bg-indigo-100 p-2 rounded-lg border-indigo-200">
                                <p class="font-medium text-indigo-800">Peso Total Bruto</p>
                                <p class="font-bold text-indigo-600">${totalGrossWeightKg.toFixed(3)} kg</p>
                            </div>
                        </div>
                        <!-- FIN DETALLES -->

                        <div class="mt-2">
                            <canvas id="collectiveBoxCanvas" class="w-full h-auto bg-white border border-gray-200 rounded-md mx-auto" width="400" height="300"></canvas>
                        </div>
                        <button id="viewOtherBoxesBtn" class="text-sm text-indigo-600 hover:underline mt-2 w-full text-right">Ver otras opciones</button>
                    </div>
                `;
                        boxContainer.classList.remove('hidden');

                        const collectiveBoxCanvas = document.getElementById('collectiveBoxCanvas');
                        const collectiveBoxCtx = collectiveBoxCanvas.getContext('2d');
                        this.drawCollectiveBoxLayout(collectiveBoxCtx, bestBox, selectedData.collectiveBoxData.foldedPiece);

                        document.getElementById('viewOtherBoxesBtn').addEventListener('click', () => this.showBoxOptionsModal(selectedData.collectiveBoxData.all));
                    } else {
                        boxContainer.innerHTML = '';
                        boxContainer.classList.add('hidden');
                    }

                    DOM.modal.previewTitle.textContent = `Vista Previa (${selectedData.name || 'Pliego Manual'})`;
                    const drawingData = selectedData.drawing;
                    const inputs = state.lastValidResults.userInputs;
                    let materialDetailHtml = (inputs.material === 'microcorrugado')
                        ? `<div class="bg-gray-100 p-2 rounded"><p class="font-bold">Flauta</p><p>${inputs.flute}</p></div>`
                        : `<div class="bg-gray-100 p-2 rounded"><p class="font-bold">Gramaje</p><p>${inputs.foldingCartonWeight} Puntos</p></div>`;
                    DOM.modal.previewDetails.innerHTML = `<div class="grid grid-cols-2 gap-2 text-xs text-gray-700"><div class="bg-gray-100 p-2 rounded"><p class="font-bold">Pliego</p><p>${drawingData.suggestedSheetW.toFixed(1)} x ${drawingData.suggestedSheetH.toFixed(1)} ${drawingData.unit}</p></div>${materialDetailHtml}<div class="bg-gray-100 p-2 rounded"><p class="font-bold">Medianil</p><p>${inputs.gutter.toFixed(1)} ${drawingData.unit}</p></div><div class="bg-gray-100 p-2 rounded"><p class="font-bold">Pinzas (Sup/Inf)</p><p>${inputs.topGripper.toFixed(1)} / ${inputs.bottomGripper.toFixed(1)} ${drawingData.unit}</p></div></div>`;
                    DOM.modal.previewLegend.innerHTML = `<div class="flex justify-center items-center gap-4"><div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-sm bg-green-500/40"></div><span>√Årea de Corte</span></div><div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-sm bg-gray-500/30"></div><span>M√°rgenes / Pinzas</span></div></div>`;
                    this.drawCanvasLayout(DOM.canvas.ctx, selectedData.drawing);
                },
                showModal() {
                    DOM.modal.overlay.classList.remove('hidden');
                    void DOM.modal.container.offsetWidth;
                    DOM.modal.container.classList.remove('scale-95', 'opacity-0');
                },
                hideModal() {
                    DOM.modal.container.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => DOM.modal.overlay.classList.add('hidden'), 300);
                },
                reset() {
                    DOM.form.reset();
                    Object.values(DOM.inputs).forEach(input => {
                        if (input.tagName.toLowerCase() === 'input') input.classList.remove('invalid-input');
                    });
                    handleMaterialChange();
                    DOM.inputs.calculationModeToggle.checked = false;
                    DOM.inputs.calculationModeToggle.dispatchEvent(new Event('change'));
                    DOM.inputs.gluing.checked = false;
                    DOM.inputs.gluing.dispatchEvent(new Event('change'));
                    DOM.inputs.usePlegadizoBundles.checked = false;
                    DOM.inputs.isAutomaticBottom.checked = false; // <-- NUEVO
                    DOM.ectValueContainer.classList.add('hidden');
                    state.lastValidResults = null;
                    this.hideModal();
                },
                drawDimensionLine(ctx, x1, y1, x2, y2, text, isVertical) {
                    const tickSize = 6;
                    const textOffset = 18;
                    ctx.save();
                    ctx.beginPath();
                    ctx.strokeStyle = '#374151';
                    ctx.fillStyle = '#374151';
                    ctx.lineWidth = 1;
                    ctx.font = '14px Inter';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    if (isVertical) {
                        ctx.moveTo(x1 - tickSize, y1); ctx.lineTo(x1 + tickSize, y1);
                        ctx.moveTo(x2 - tickSize, y2); ctx.lineTo(x2 + tickSize, y2);
                        ctx.stroke();
                        const midX = x1 - textOffset;
                        const midY = (y1 + y2) / 2;
                        ctx.translate(midX, midY);
                        ctx.rotate(-Math.PI / 2);
                        ctx.fillText(text, 0, 0);
                    } else {
                        ctx.moveTo(x1, y1 - tickSize); ctx.lineTo(x1, y1 + tickSize);
                        ctx.moveTo(x2, y2 - tickSize); ctx.lineTo(x2, y2 + tickSize);
                        ctx.stroke();
                        const midX = (x1 + x2) / 2;
                        const midY = y1 - textOffset;
                        ctx.fillText(text, midX, midY);
                    }
                    ctx.restore();
                },
                drawCanvasLayout(ctx, data) {
                    const { el } = DOM.canvas;
                    ctx.clearRect(0, 0, el.width, el.height);
                    const p = 90;
                    const maxW = el.width - 2 * p;
                    const maxH = el.height - 2 * p;
                    const { sheetW, sheetH, sideMargins, topGripper, bottomGripper, cols, rows, gutter, pieceW, pieceH, usedAreaW, usedAreaH, unit } = data;
                    const r = sheetW / sheetH;
                    let dW, dH;
                    if (r > maxW / maxH) {
                        dW = maxW;
                        dH = maxW / r;
                    } else {
                        dH = maxH;
                        dW = maxH * r;
                    }
                    const sX = (el.width - dW) / 2;
                    const sY = (el.height - dH) / 2;
                    ctx.fillStyle = 'rgba(239, 246, 255, 1)';
                    ctx.fillRect(sX, sY, dW, dH);
                    ctx.strokeStyle = 'rgba(200, 200, 200, 0.8)';
                    ctx.strokeRect(sX, sY, dW, dH);
                    const tGDH = (topGripper / sheetH) * dH;
                    const bGDH = (bottomGripper / sheetH) * dH;
                    const sMDW = (sideMargins / sheetW) * dW;
                    ctx.fillStyle = 'rgba(107, 114, 128, 0.3)';
                    ctx.fillRect(sX, sY, dW, tGDH);
                    ctx.fillRect(sX, sY + dH - bGDH, dW, bGDH);
                    ctx.fillRect(sX, sY, sMDW, dH);
                    ctx.fillRect(sX + dW - sMDW, sY, sMDW, dH);
                    const cDX_b = sX + sMDW;
                    const cDW = dW - (sMDW * 2);
                    const cDY_b = sY + tGDH;
                    const cDH = dH - tGDH - bGDH;
                    if (cols > 0 && rows > 0 && cDW > 0 && cDH > 0) {
                        const tGW = (cols - 1) * gutter;
                        const tGH = (rows - 1) * gutter;
                        const tPW = cols * pieceW;
                        const tPH = rows * pieceH;
                        const sR = Math.min(cDW / (tPW + tGW), cDH / (tPH + tGH));
                        const pDW = pieceW * sR;
                        const pDH = pieceH * sR;
                        const gDW = gutter * sR;
                        const gDH = gutter * sR;
                        const uADW = (cols * pDW) + (Math.max(0, cols - 1) * gDW);
                        const uADH = (rows * pDH) + (Math.max(0, rows - 1) * gDH);
                        const oX = (cDW - uADW) / 2;
                        const oY = (cDH - uADH) / 2;
                        const cDX = cDX_b + oX;
                        const cDY = cDY_b + oY;
                        ctx.fillStyle = 'rgba(16, 185, 129, 0.4)';
                        ctx.strokeStyle = 'rgba(5, 150, 105, 0.6)';
                        ctx.lineWidth = 1;
                        for (let i = 0; i < cols; i++) {
                            for (let j = 0; j < rows; j++) {
                                const x = cDX + i * (pDW + gDW);
                                const y = cDY + j * (pDH + gDH);
                                ctx.fillRect(x, y, pDW, pDH);
                                if (pDW > 1 && pDH > 1) {
                                    ctx.strokeRect(x + 0.5, y + 0.5, pDW - 1, pDH - 1);
                                } else {
                                    ctx.strokeRect(x, y, pDW, pDH);
                                }
                            }
                        }
                        const iDO = 35;
                        const oDO = 65;
                        this.drawDimensionLine(ctx, cDX, cDY - iDO, cDX + uADW, cDY - iDO, `${usedAreaW.toFixed(1)} ${unit}`, !1);
                        this.drawDimensionLine(ctx, cDX - iDO, cDY, cDX - iDO, cDY + uADH, `${usedAreaH.toFixed(1)} ${unit}`, !0);
                        if (topGripper > 0) this.drawDimensionLine(ctx, sX + dW + oDO, sY, sX + dW + oDO, sY + tGDH, `${topGripper.toFixed(1)} ${unit}`, !0);
                        if (bottomGripper > 0) this.drawDimensionLine(ctx, sX + dW + oDO, sY + dH - bGDH, sX + dW + oDO, sY + dH, `${bottomGripper.toFixed(1)} ${unit}`, !0);
                        if (sideMargins > 0) {
                            this.drawDimensionLine(ctx, sX, sY + dH + oDO, sX + sMDW, sY + dH + oDO, `${sideMargins.toFixed(1)} ${unit}`, !1);
                            this.drawDimensionLine(ctx, sX + dW - sMDW, sY + dH + oDO, sX + dW, sY + dH + oDO, `${sideMargins.toFixed(1)} ${unit}`, !1);
                        }
                    }
                },
                drawPalletLayout(palletW, palletH, pieceW, pieceH, targetCanvas, targetCtx) {
                    const canvas = targetCanvas || DOM.palletize.palletCanvas;
                    const ctx = targetCtx || DOM.palletize.palletCtx;

                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    if (!palletW || !palletH) return;

                    let bestLayout = { count: 0 };
                    if (pieceW > 0 && pieceH > 0) {
                        const layout1 = {
                            cols: Math.floor(palletW / pieceW),
                            rows: Math.floor(palletH / pieceH),
                            pieceW: pieceW,
                            pieceH: pieceH
                        };
                        layout1.count = layout1.cols * layout1.rows;

                        const layout2 = {
                            cols: Math.floor(palletW / pieceH),
                            rows: Math.floor(palletH / pieceW),
                            pieceW: pieceH,
                            pieceH: pieceW
                        };
                        layout2.count = layout2.cols * layout2.rows;

                        bestLayout = layout1.count >= layout2.count ? layout1 : layout2;
                    }

                    const padding = 40;
                    const canvasW = canvas.width - 2 * padding;
                    const canvasH = canvas.height - 2 * padding;

                    const scale = Math.min(canvasW / palletW, canvasH / palletH);

                    const scaledPalletW = palletW * scale;
                    const scaledPalletH = palletH * scale;

                    const offsetX = (canvas.width - scaledPalletW) / 2;
                    const offsetY = (canvas.height - scaledPalletH) / 2;

                    // Draw Pallet
                    ctx.save();
                    ctx.strokeStyle = '#9ca3af';
                    ctx.fillStyle = '#f9fafb';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(offsetX, offsetY, scaledPalletW, scaledPalletH);
                    ctx.fillRect(offsetX, offsetY, scaledPalletW, scaledPalletH);
                    ctx.restore();

                    // Draw Pieces
                    if (bestLayout.count > 0) {
                        const scaledPieceW = bestLayout.pieceW * scale;
                        const scaledPieceH = bestLayout.pieceH * scale;

                        ctx.save();
                        ctx.strokeStyle = '#3b82f6';
                        ctx.fillStyle = 'rgba(59, 130, 246, 0.3)';
                        ctx.lineWidth = 1.5;

                        for (let r = 0; r < bestLayout.rows; r++) {
                            for (let c = 0; c < bestLayout.cols; c++) {
                                const x = offsetX + c * scaledPieceW;
                                const y = offsetY + r * scaledPieceH;
                                ctx.fillRect(x, y, scaledPieceW, scaledPieceH);
                                if (scaledPieceW > 1 && scaledPieceH > 1) {
                                    ctx.strokeRect(x + 0.5, y + 0.5, scaledPieceW - 1, scaledPieceH - 1);
                                } else {
                                    ctx.strokeRect(x, y, scaledPieceW, scaledPieceH);
                                }
                            }
                        }
                        ctx.restore();
                    }

                    // Draw Dimensions
                    this.drawDimensionLine(ctx, offsetX, offsetY + scaledPalletH + 5, offsetX + scaledPalletW, offsetY + scaledPalletH + 5, `${(palletW / 25.4).toFixed(1)}"`, false);
                    this.drawDimensionLine(ctx, offsetX - 5, offsetY, offsetX - 5, offsetY + scaledPalletH, `${(palletH / 25.4).toFixed(1)}"`, true);
                },
                drawCollectiveBoxLayout(ctx, box, foldedPiece) {
                    const canvas = ctx.canvas;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    const { largo: boxL, ancho: boxW, alto: boxH } = box;
                    const { foldedL: pieceL, foldedH: pieceH, pieceThickness } = foldedPiece;

                    if (!boxL || !boxW || !boxH || !pieceL || !pieceH || !pieceThickness) return;

                    // La dimensi√≥n de apilamiento es donde se divide por el espesor (pieceThickness)
                    const stackingDim = box.finalFitDim === 'largo' ? boxL : boxW;
                    const baseDim = box.finalFitDim === 'largo' ? boxW : boxL;

                    const capacity = Math.floor(stackingDim / pieceThickness);
                    if (capacity === 0) return;

                    const padding = 20;
                    const canvasW = canvas.width - 2 * padding;
                    const canvasH = canvas.height - 2 * padding;

                    // Se escala la base y la dimensi√≥n de apilamiento para el dibujo 2D (vista lateral)
                    const scale = Math.min(canvasW / baseDim, canvasH / stackingDim);
                    const scaledBoxBase = baseDim * scale;
                    const scaledBoxStack = stackingDim * scale;

                    const offsetX = (canvas.width - scaledBoxBase) / 2;
                    const offsetY = (canvas.height - scaledBoxStack) / 2;

                    ctx.save();
                    ctx.strokeStyle = '#9ca3af';
                    ctx.fillStyle = '#f9fafb';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(offsetX, offsetY, scaledBoxBase, scaledBoxStack);
                    ctx.fillRect(offsetX, offsetY, scaledBoxBase, scaledBoxStack);
                    ctx.restore();

                    const scaledPieceThickness = pieceThickness * scale;

                    ctx.save();
                    ctx.strokeStyle = '#2563eb';
                    ctx.fillStyle = 'rgba(59, 130, 246, 0.3)';
                    ctx.lineWidth = 1;
                    for (let i = 0; i < capacity; i++) {
                        const x = offsetX;
                        const y = offsetY + i * scaledPieceThickness;
                        if (y + scaledPieceThickness > offsetY + scaledBoxStack + 0.1) break;
                        ctx.fillRect(x, y, scaledBoxBase, scaledPieceThickness);
                        ctx.strokeRect(x + 0.5, y + 0.5, scaledBoxBase - 1, scaledPieceThickness - 1);
                    }
                    ctx.restore();

                    this.drawDimensionLine(ctx, offsetX, offsetY + scaledBoxStack + 5, offsetX + scaledBoxBase, offsetY + scaledBoxStack + 5, `${baseDim} mm (W/L)`, false);
                    this.drawDimensionLine(ctx, offsetX - 5, offsetY, offsetX - 5, offsetY + scaledBoxStack, `${stackingDim} mm (H)`, true);
                },
                showSettingsModal() {
                    this.populateSettingsForm();
                    DOM.settings.overlay.classList.remove('hidden');
                    void DOM.settings.container.offsetWidth;
                    DOM.settings.container.classList.remove('scale-95', 'opacity-0');
                },
                hideSettingsModal() {
                    DOM.settings.container.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => DOM.settings.overlay.classList.add('hidden'), 300);
                },
                populateSettingsForm() {
                    const createInputGroup = (machine) => `<div class="flex gap-2 mt-2"><div class="flex-1"><label class="block text-xs text-gray-500">Ancho M√°x.</label><input type="text" inputmode="decimal" value="${machine.maxWidth || ''}" class="w-full p-1 border rounded-md text-sm"></div><div class="flex-1"><label class="block text-xs text-gray-500">Alto M√°x.</label><input type="text" inputmode="decimal" value="${machine.maxHeight || ''}" class="w-full p-1 border rounded-md text-sm"></div><div class="flex-1"><label class="block text-xs text-gray-500">Ancho M√≠n.</label><input type="text" inputmode="decimal" value="${machine.minWidth || ''}" class="w-full p-1 border rounded-md text-sm"></div><div class="flex-1"><label class="block text-xs text-gray-500">Alto M√≠n.</label><input type="text" inputmode="decimal" value="${machine.minHeight || ''}" class="w-full p-1 border rounded-md text-sm"></div></div>`;
                    DOM.settings.dieCutterContainer.innerHTML = PROCESS_MACHINES.DIE_CUTTERS.map(m => `<div class="p-3 bg-gray-50 rounded-lg" data-machine-name="${m.name}" data-machine-type="DIE_CUTTERS"><p class="font-semibold">${m.name}</p>${createInputGroup(m)}</div>`).join('');
                    DOM.settings.printerContainer.innerHTML = PROCESS_MACHINES.PRINTERS.map(m => `<div class="p-3 bg-gray-50 rounded-lg" data-machine-name="${m.name}" data-machine-type="PRINTERS"><p class="font-semibold">${m.name}</p>${createInputGroup(m)}</div>`).join('');
                    DOM.settings.standardPalletHeightInput.value = PALLETIZING_SETTINGS.standardPalletHeightCm;
                    this.populatePalletList();
                    this.populateCollectiveBoxList();
                    this.populateFoldingCartonGrammageSettings();

                    DOM.settings.starchAdhesiveInput.value = GENERAL_SETTINGS.adhesives.starch;
                    DOM.settings.pvaAdhesiveInput.value = GENERAL_SETTINGS.adhesives.pva;
                    DOM.settings.mediumFactorE.value = GENERAL_SETTINGS.mediumFactors['Flauta E'];
                    DOM.settings.mediumFactorB.value = GENERAL_SETTINGS.mediumFactors['Flauta B'];
                    DOM.settings.mediumFactorC.value = GENERAL_SETTINGS.mediumFactors['Flauta C'];
                    DOM.settings.autoBottomCompInput.value = GENERAL_SETTINGS.automaticBottomCompensation; // <-- NUEVO
                },
                populateFoldingCartonGrammageSettings() {
                    const container = DOM.settings.foldingCartonGrammageContainer;
                    container.innerHTML = '';
                    for (const paperType in GENERAL_SETTINGS.foldingCartonGrammage) {
                        const paperData = GENERAL_SETTINGS.foldingCartonGrammage[paperType];
                        let inputsHTML = '<div class="grid grid-cols-2 sm:grid-cols-4 gap-x-4 gap-y-2">';

                        const sortedPoints = Object.keys(paperData).map(Number).sort((a, b) => a - b);

                        for (const points of sortedPoints) {
                            inputsHTML += `
                        <div class="flex items-center">
                            <label for="grammage-${paperType}-${points}" class="w-12 text-sm text-gray-600">${points} pts</label>
                            <input type="text" inputmode="decimal" id="grammage-${paperType}-${points}" 
                                   data-paper-type="${paperType}" data-points="${points}"
                                   value="${paperData[points] || 0}" 
                                   class="grammage-input w-full p-1 border rounded-md text-sm">
                        </div>
                    `;
                        }
                        inputsHTML += '</div>';

                        container.innerHTML += `
                    <div class="p-3 bg-white rounded-lg border">
                        <h4 class="font-medium text-gray-800">${paperType.replace('_', ' ')}</h4>
                        ${inputsHTML}
                    </div>
                `;
                    }
                },
                handleSaveSettings() {
                    DOM.settings.form.querySelectorAll('[data-machine-name]').forEach(d => {
                        const name = d.dataset.machineName;
                        const type = d.dataset.machineType;
                        const inputs = d.querySelectorAll('input');
                        const machine = PROCESS_MACHINES[type].find(m => m.name === name);
                        if (machine) {
                            machine.maxWidth = parseFloat(inputs[0].value) || machine.maxWidth;
                            machine.maxHeight = parseFloat(inputs[1].value) || machine.maxHeight;
                            machine.minWidth = parseFloat(inputs[2].value) || undefined;
                            machine.minHeight = parseFloat(inputs[3].value) || undefined;
                        }
                    });
                    PALLETIZING_SETTINGS.standardPalletHeightCm = parseFloat(DOM.settings.standardPalletHeightInput.value) || 15;

                    GENERAL_SETTINGS.adhesives.starch = parseFloat(DOM.settings.starchAdhesiveInput.value) || 18;
                    GENERAL_SETTINGS.adhesives.pva = parseFloat(DOM.settings.pvaAdhesiveInput.value) || 26;
                    GENERAL_SETTINGS.mediumFactors['Flauta E'] = parseFloat(DOM.settings.mediumFactorE.value) || 1.32;
                    GENERAL_SETTINGS.mediumFactors['Flauta B'] = parseFloat(DOM.settings.mediumFactorB.value) || 1.35;
                    GENERAL_SETTINGS.mediumFactors['Flauta C'] = parseFloat(DOM.settings.mediumFactorC.value) || 1.48;

                    GENERAL_SETTINGS.automaticBottomCompensation = parseFloat(DOM.settings.autoBottomCompInput.value) || 2.5; // <-- NUEVO

                    DOM.settings.foldingCartonGrammageContainer.querySelectorAll('.grammage-input').forEach(input => {
                        const paperType = input.dataset.paperType;
                        const points = input.dataset.points;
                        const value = parseFloat(input.value);
                        if (paperType && points && !isNaN(value)) {
                            if (!GENERAL_SETTINGS.foldingCartonGrammage[paperType]) {
                                GENERAL_SETTINGS.foldingCartonGrammage[paperType] = {};
                            }
                            GENERAL_SETTINGS.foldingCartonGrammage[paperType][points] = value;
                        }
                    });

                    saveSettingsToLocalStorage();
                    UI.showToast("Ajustes guardados.");
                    UI.hideSettingsModal();
                },
                showHistoryModal() {
                    this.populateHistoryList();
                    DOM.history.overlay.classList.remove('hidden');
                    void DOM.history.container.offsetWidth;
                    DOM.history.container.classList.remove('scale-95', 'opacity-0');
                },
                hideHistoryModal() {
                    DOM.history.container.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => DOM.history.overlay.classList.add('hidden'), 300);
                },
                populateHistoryList() {
                    DOM.history.listContainer.innerHTML = '';
                    if (state.history.length === 0) {
                        DOM.history.listContainer.innerHTML = `<p class="text-center text-gray-500 py-4">No hay c√°lculos guardados.</p>`;
                        return;
                    }
                    state.history.forEach(entry => {
                        const date = new Date(entry.timestamp).toLocaleString('es-MX', { dateStyle: 'short', timeStyle: 'short' });
                        const itemEl = document.createElement('div');
                        itemEl.className = 'p-3 bg-white rounded-lg border hover:bg-gray-50 cursor-pointer';
                        itemEl.dataset.folio = entry.folio;
                        itemEl.innerHTML = `<div class="flex justify-between items-center"><div><p class="font-bold text-blue-600">Folio: ${entry.folio}</p><p class="text-sm text-gray-700">${entry.cliente || 'Sin cliente'}</p></div><p class="text-xs text-gray-500">${date}</p></div>`;
                        DOM.history.listContainer.appendChild(itemEl);
                    });
                },
                showToast(message, isError = false) {
                    DOM.toast.message.textContent = message;
                    DOM.toast.el.classList.toggle('bg-red-600', isError);
                    DOM.toast.el.classList.toggle('bg-green-600', !isError);
                    DOM.toast.el.classList.remove('opacity-0', 'translate-y-2');
                    setTimeout(() => {
                        DOM.toast.el.classList.add('opacity-0', 'translate-y-2');
                    }, 3000);
                },
                showPalletizeModal() {
                    this.populatePalletDropdowns();
                    DOM.palletize.resultsContainer.classList.add('hidden');
                    DOM.palletize.overlay.classList.remove('hidden');
                    void DOM.palletize.container.offsetWidth;
                    DOM.palletize.container.classList.remove('scale-95', 'opacity-0');
                },
                hidePalletizeModal() {
                    DOM.palletize.container.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => {
                        DOM.palletize.overlay.classList.add('hidden');
                        DOM.palletize.palletCtx.clearRect(0, 0, DOM.palletize.palletCanvas.width, DOM.palletize.palletCanvas.height);
                    }, 300);
                },
                showBoxOptionsModal(boxes) {
                    const listEl = DOM.boxOptions.list;
                    listEl.innerHTML = '';
                    if (!boxes || boxes.length === 0) {
                        listEl.innerHTML = '<p class="text-center text-gray-500">No hay otras opciones compatibles.</p>';
                    } else {
                        const boxHtml = boxes.map(box => {
                            // Extraer pesos para la lista de opciones
                            const { emptyBoxWeightKg, piecesNetWeightKg, totalGrossWeightKg } = box.weightData;

                            return `
                        <div class="p-3 bg-white rounded-lg border hover:bg-gray-50">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-bold text-blue-600">${box.material}</p>
                                    <p class="text-sm text-gray-700">${box.largo} x ${box.ancho} x ${box.alto} mm</p>
                                    <p class="text-xs text-gray-500 mt-1">Desperdicio de √°rea: ${box.waste.toFixed(2)} mm¬≤</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-2xl font-bold text-blue-600">${box.capacity}</p>
                                    <p class="text-xs text-gray-600 -mt-1">piezas/caja</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2 mt-2 text-xs text-center border-t pt-2">
                                <div><p class="text-gray-600">Peso Caja Vac√≠a</p><p class="font-bold">${emptyBoxWeightKg.toFixed(3)} kg</p></div>
                                <div><p class="text-gray-600">Peso Piezas Neto</p><p class="font-bold">${piecesNetWeightKg.toFixed(3)} kg</p></div>
                                <div><p class="font-bold text-indigo-700">TOTAL</p><p class="font-extrabold text-indigo-600">${totalGrossWeightKg.toFixed(3)} kg</p></div>
                            </div>
                        </div>
                    `;
                        }).join('');
                        listEl.innerHTML = boxHtml;
                    }

                    DOM.boxOptions.overlay.classList.remove('hidden');
                    void DOM.boxOptions.container.offsetWidth; // Trigger reflow
                    DOM.boxOptions.container.classList.remove('scale-95', 'opacity-0');
                },
                hideBoxOptionsModal() {
                    DOM.boxOptions.container.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => DOM.boxOptions.overlay.classList.add('hidden'), 300);
                },
                populatePalletDropdowns() {
                    DOM.palletize.palletSize.innerHTML = PALLETIZING_SETTINGS.pallets.map(p => {
                        const value = `${p.widthIn * 25.4}x${p.heightIn * 25.4}`;
                        return `<option value="${value}">${p.name}</option>`;
                    }).join('');
                },
                populatePalletList() {
                    DOM.settings.palletListContainer.innerHTML = '<p class="font-semibold text-gray-700 mb-2">Tarimas Disponibles</p>';
                    PALLETIZING_SETTINGS.pallets.forEach(p => {
                        const palletEl = document.createElement('div');
                        palletEl.className = 'flex justify-between items-center text-sm p-2 bg-white rounded';
                        palletEl.innerHTML = `<span>${p.name} (${p.widthIn}" x ${p.heightIn}")</span><button data-id="${p.id}" class="text-red-500 hover:text-red-700 remove-pallet-btn">Eliminar</button>`;
                        DOM.settings.palletListContainer.appendChild(palletEl);
                    });
                },
                populateCollectiveBoxList() {
                    const container = DOM.settings.collectiveBoxListContainer;
                    container.innerHTML = '';
                    if (COLLECTIVE_BOXES.length === 0) {
                        container.innerHTML = '<p class="text-sm text-gray-500 p-2">No hay cajas definidas.</p>';
                        return;
                    }

                    COLLECTIVE_BOXES.sort((a, b) => a.material - b.material).forEach(box => {
                        const boxEl = document.createElement('div');
                        boxEl.className = 'flex justify-between items-center text-sm p-2 bg-white rounded shadow-sm';
                        boxEl.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-800">${box.material}</p>
                        <p class="text-xs text-gray-500">${box.largo}x${box.ancho}x${box.alto}mm | Flauta ${box.flauta} | ECT ${box.ect}</p>
                    </div>
                    <button data-material="${box.material}" class="remove-box-btn text-red-500 hover:text-red-700 font-medium text-xs bg-red-100 hover:bg-red-200 px-2 py-1 rounded">ELIMINAR</button>
                `;
                        container.appendChild(boxEl);
                    });
                }
            };

            // --- MANEJADORES DE EVENTOS Y L√ìGICA PRINCIPAL ---
            function runCalculation() {
                const button = DOM.submitBtn;
                button.disabled = true;
                button.innerHTML = `<div class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle><path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75" fill="currentColor"></path></svg>Calculando...</div>`;

                setTimeout(() => {
                    const resultsData = Calculator.getOptimizedResults();
                    if (resultsData) {
                        UI.updateResults(resultsData);
                    }
                    button.disabled = false;
                    button.innerHTML = 'Calcular';
                }, 50);
            }

            function handleMaterialChange() {
                const selectedMaterial = DOM.inputs.material.value;
                const isMicro = selectedMaterial === 'microcorrugado';
                const isPlegadizo = selectedMaterial === 'plegadizo';

                DOM.materialOptions.fluteContainer.classList.toggle('hidden', !isMicro);
                DOM.materialOptions.ectContainer.classList.toggle('hidden', !isMicro);
                DOM.materialOptions.foldingCartonTypeContainer.classList.toggle('hidden', !isPlegadizo);
                DOM.materialOptions.foldingCartonWeightContainer.classList.toggle('hidden', !isPlegadizo);
                DOM.plegadizoBundleContainer.classList.toggle('hidden', !isPlegadizo);

                if (!isMicro) {
                    DOM.inputs.ectCheckbox.checked = false;
                    DOM.ectValueContainer.classList.add('hidden');
                }
                if (!isPlegadizo) {
                    DOM.inputs.usePlegadizoBundles.checked = false;
                }
            }

            function updateFoldedPieceInfo() {
                const isGluing = DOM.inputs.gluing.checked;

                if (!isGluing) {
                    DOM.foldedPieceInfo.container.classList.add('hidden');
                    return;
                }

                const unit = DOM.inputs.unit.value;
                const cutWidth = parseFloat(DOM.inputs.cutWidth.value);
                const cutHeight = parseFloat(DOM.inputs.cutHeight.value);
                const glueFlapWidth = parseFloat(DOM.inputs.glueFlapWidth.value);

                if (isNaN(cutWidth) || isNaN(cutHeight) || isNaN(glueFlapWidth) || cutWidth <= 0 || cutHeight <= 0 || glueFlapWidth < 0) {
                    DOM.foldedPieceInfo.container.classList.add('hidden');
                    return;
                }

                const originalPieceW_mm = toMM(cutWidth, unit);
                const originalPieceH_mm = toMM(cutHeight, unit);
                const glueFlapW_mm = toMM(glueFlapWidth, unit);

                let foldedW, foldedH;

                // Dimensi√≥n del cuerpo doblado (Largo/2 o Ancho/2, seg√∫n la orientaci√≥n)
                if (originalPieceH_mm >= originalPieceW_mm) {
                    foldedH = (originalPieceH_mm - glueFlapW_mm) / 2;
                    foldedW = originalPieceW_mm;
                } else {
                    foldedW = (originalPieceW_mm - glueFlapW_mm) / 2;
                    foldedH = originalPieceH_mm;
                }

                let nominalThickness = 0;
                const material = DOM.inputs.material.value;
                const isAutomaticBottom = DOM.inputs.isAutomaticBottom.checked;

                if (material === 'microcorrugado') {
                    const flute = DOM.inputs.flute.value;
                    nominalThickness = PALLETIZING_SETTINGS.MATERIAL_THICKNESS.FLUTES[flute] || 0;
                } else {
                    const points = parseFloat(DOM.inputs.foldingCartonWeight.value);
                    if (!isNaN(points)) {
                        nominalThickness = points * PALLETIZING_SETTINGS.MATERIAL_THICKNESS.POINTS_TO_MM;
                    }
                }

                let finalThickness = 0;

                if (nominalThickness > 0) {
                    if (isAutomaticBottom) {
                        // Fondo Autom√°tico: 5 capas nominales + Compensaci√≥n Fija
                        const layers = 5;
                        const compensation = GENERAL_SETTINGS.automaticBottomCompensation || 0;
                        finalThickness = (nominalThickness * layers) + compensation;
                    } else {
                        // Pegado Lineal: 2 capas nominales + 50% de holgura
                        const layers = 2;
                        const holgura = nominalThickness * 0.5;
                        finalThickness = (nominalThickness * layers) + holgura;
                    }
                }

                if (foldedW > 0 && foldedH > 0 && finalThickness > 0) {
                    DOM.foldedPieceInfo.size.textContent = `${foldedW.toFixed(2)} mm x ${foldedH.toFixed(2)} mm`;
                    DOM.foldedPieceInfo.thickness.textContent = `${finalThickness.toFixed(2)} mm`;
                    DOM.foldedPieceInfo.container.classList.remove('hidden');
                } else {
                    DOM.foldedPieceInfo.container.classList.add('hidden');
                }
            }

            function updateLinerDefaults() {
                const ectValue = DOM.inputs.ectValue.value;
                let liners = { ext: '', med: '', int: '' };

                switch (ectValue) {
                    case '29':
                        liners = { ext: '240', med: '125', int: '135' };
                        break;
                    case '32':
                        liners = { ext: '240', med: '160', int: '180' };
                        break;
                    case '26':
                    case '40':
                    default:
                        break;
                }
                DOM.inputs.linerExt.value = liners.ext;
                DOM.inputs.medium.value = liners.med;
                DOM.inputs.linerInt.value = liners.int;
            }

            function handleSaveCalculation() {
                const folio = DOM.modal.folioInput.value.trim();
                const cliente = DOM.modal.clienteInput.value.trim();
                if (!folio) {
                    UI.showToast("El Folio es obligatorio.", true);
                    DOM.modal.folioInput.classList.add('invalid-input');
                    return;
                }
                DOM.modal.folioInput.classList.remove('invalid-input');
                if (!state.lastValidResults) {
                    UI.showToast("No hay resultados para guardar.", true);
                    return;
                }
                const existingIndex = state.history.findIndex(item => item.folio === folio);
                const newEntry = { folio, cliente, timestamp: new Date().toISOString(), results: state.lastValidResults };
                if (existingIndex > -1) {
                    state.history[existingIndex] = newEntry;
                    UI.showToast(`Folio "${folio}" actualizado.`);
                } else {
                    state.history.push(newEntry);
                    UI.showToast(`Folio "${folio}" guardado.`);
                }
                state.history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                saveHistoryToLocalStorage();
            }

            function handleLoadFromHistory(event) {
                const folioElement = event.target.closest('[data-folio]');
                if (!folioElement) return;
                const folio = folioElement.dataset.folio;
                const entry = state.history.find(item => item.folio === folio);
                UI.displaySavedCalculation(entry);
            }

            function handleClearHistory() {
                state.history = [];
                saveHistoryToLocalStorage();
                UI.populateHistoryList();
                UI.showToast("Historial borrado.");
            }

            function calculateColumnarFit(palletW, palletH, itemW, itemH) {
                if (itemW <= 0 || itemH <= 0) return 0;
                let maxCount = 0;

                // Try primary orientation
                for (let i = 0; i <= Math.floor(palletW / itemW); i++) {
                    let currentCount = i * Math.floor(palletH / itemH);
                    const remainingW = palletW - (i * itemW);
                    if (remainingW > 0) {
                        currentCount += Math.floor(remainingW / itemH) * Math.floor(palletH / itemW);
                    }
                    if (currentCount > maxCount) maxCount = currentCount;
                }
                // Try rotated orientation
                for (let i = 0; i <= Math.floor(palletW / itemH); i++) {
                    let currentCount = i * Math.floor(palletH / itemW);
                    const remainingW = palletW - (i * itemH);
                    if (remainingW > 0) {
                        currentCount += Math.floor(remainingW / itemW) * Math.floor(palletH / itemH);
                    }
                    if (currentCount > maxCount) maxCount = currentCount;
                }
                return maxCount;
            }

            function handlePalletizeCalculation() {
                if (!state.lastValidResults) return;
                const pattern = DOM.palletize.stackingPattern.value;
                const palletResult = Calculator.getPalletizeResults(state.lastValidResults, pattern);

                if (!palletResult) {
                    UI.showToast("No caben items en la tarima con la altura especificada.", true);
                    DOM.palletize.piecesPerLayerResult.textContent = 0;
                    DOM.palletize.layersPerPalletResult.textContent = 0;
                    DOM.palletize.totalPiecesResult.textContent = 0;
                    DOM.palletize.materialHeightResult.textContent = `0 cm`;
                    DOM.palletize.finalHeightResult.textContent = `${PALLETIZING_SETTINGS.standardPalletHeightCm.toFixed(1)} cm`;
                    DOM.palletize.resultsContainer.classList.remove('hidden');
                    const [palletW, palletH] = DOM.palletize.palletSize.value.split('x').map(Number);
                    UI.drawPalletLayout(palletW, palletH, 0, 0);
                    return;
                }

                DOM.palletize.palletizingModeTitle.textContent = `Acomodo de ${palletResult.mode}`;
                if (palletResult.bundleInfo) {
                    DOM.palletize.palletizingModeTitle.textContent += ` - ${palletResult.bundleInfo}`;
                }
                DOM.palletize.piecesPerLayerLabel.textContent = palletResult.itemsPerLayerLabel;
                DOM.palletize.piecesPerLayerResult.textContent = palletResult.piecesPerLayer.toLocaleString('es-MX');
                DOM.palletize.layersPerPalletResult.textContent = palletResult.layersPerPallet.toLocaleString('es-MX');
                DOM.palletize.totalPiecesResult.textContent = palletResult.totalPieces.toLocaleString('es-MX');
                DOM.palletize.materialHeightResult.textContent = `${palletResult.materialHeightCm.toFixed(1)} cm`;
                DOM.palletize.finalHeightResult.textContent = `${palletResult.finalHeightCm.toFixed(1)} cm`;

                DOM.palletize.resultsContainer.classList.remove('hidden');
                UI.drawPalletLayout(palletResult.palletW_mm, palletResult.palletH_mm, palletResult.itemW_mm, palletResult.itemH_mm);
            }

            function toMM(value, unit) {
                if (unit === 'cm') return value * 10;
                if (unit === 'in') return value * 25.4;
                return value;
            }

            function setupEventListeners() {
                DOM.form.addEventListener('submit', (e) => { e.preventDefault(); runCalculation(); });
                DOM.inputs.material.addEventListener('change', handleMaterialChange);
                DOM.inputs.calculationModeToggle.addEventListener('change', (e) => {
                    DOM.customSheetContainer.classList.toggle('hidden', !e.target.checked);
                });
                DOM.inputs.gluing.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    DOM.gluingOptionsContainer.classList.toggle('hidden', !isChecked);
                    if (isChecked) {
                        DOM.inputs.useCollectiveBox.checked = true;
                    } else {
                        DOM.inputs.isAutomaticBottom.checked = false;
                    }
                    updateFoldedPieceInfo();
                });

                // Listener para Fondo Autom√°tico: si se activa, se asegura que Pegado est√© activo.
                DOM.inputs.isAutomaticBottom.addEventListener('change', (e) => {
                    if (e.target.checked && !DOM.inputs.gluing.checked) {
                        DOM.inputs.gluing.checked = true;
                        DOM.inputs.gluing.dispatchEvent(new Event('change'));
                    }
                    updateFoldedPieceInfo();
                });

                DOM.inputs.ectCheckbox.addEventListener('change', (e) => {
                    DOM.ectValueContainer.classList.toggle('hidden', !e.target.checked);
                });
                DOM.inputs.ectValue.addEventListener('change', updateLinerDefaults);

                DOM.modal.rankingContainer.addEventListener('click', (e) => {
                    if (state.lastValidResults && state.lastValidResults.isCustom) return;
                    const item = e.target.closest('[data-machine-index]');
                    if (item) UI.updatePreview(parseInt(item.dataset.machineIndex, 10));
                });
                DOM.resetBtn.addEventListener('click', () => UI.reset());
                DOM.modal.printBtn.addEventListener('click', () => window.print());
                DOM.modal.emailBtn.addEventListener('click', () => {
                    if (!state.lastValidResults) {
                        UI.showToast("No hay resultados para enviar.", true);
                        return;
                    }
                    const folio = DOM.modal.folioInput.value.trim() || 'N/A';
                    const cliente = DOM.modal.clienteInput.value.trim() || 'N/A';
                    const selectedMachineIndex = parseInt(DOM.modal.rankingContainer.querySelector('.selected-machine')?.dataset.machineIndex || '0', 10);
                    const data = state.lastValidResults.isCustom ? state.lastValidResults : state.lastValidResults.rankedMachines[selectedMachineIndex];

                    if (!data) return;

                    const subject = `Resultados de Optimizaci√≥n - Folio: ${folio}`;
                    let body = `Resumen de C√°lculo para Cliente: ${cliente}\n`;
                    body += `Folio: ${folio}\n\n`;
                    body += `--- RESULTADOS CLAVE ---\n`;
                    if (state.lastValidResults.isCustom) {
                        body += `Modo: Pliego Manual\n`;
                        body += `Pliego: ${data.drawing.sheetW.toFixed(1)} x ${data.drawing.sheetH.toFixed(1)} ${data.drawing.unit}\n`;
                        body += `Cortes por Pliego: ${data.cuts}\n`;
                    } else {
                        body += `Modo: √ìptimo\n`;
                        body += `Impresora √ìptima: ${data.name}\n`;
                        body += `Pliego Sugerido: ${data.drawing.suggestedSheetW.toFixed(1)} x ${data.drawing.suggestedSheetH.toFixed(1)} ${data.drawing.unit}\n`;
                        body += `Cortes por Pliego: ${data.cuts}\n`;
                        body += `Aprovechamiento: ${data.aprovechamiento.toFixed(1)}%\n`;
                    }

                    body += `\n--- RUTA DE PROCESO ---\n`;
                    const route = Calculator.generateProcessRoute(data, state.lastValidResults.userInputs);
                    route.forEach((step, i) => {
                        body += `${i + 1}. ${step.process}: ${step.machine}\n`;
                    });

                    if (data.pieceGrossWeightKg) {
                        body += `\n--- DETALLES DE PESO ---\n`;
                        body += `Peso por Pieza: ${data.pieceGrossWeightKg.toFixed(4)} kg\n`;
                    }

                    if (data.collectiveBoxData?.best) {
                        const box = data.collectiveBoxData.best;
                        const totalWeight = box.weightData?.totalGrossWeightKg;
                        body += `\n--- CAJA COLECTIVA ---\n`;
                        body += `Material: ${box.material}\n`;
                        body += `Dimensiones: ${box.largo}x${box.ancho}x${box.alto} mm\n`;
                        body += `Capacidad: ${box.capacity} piezas/caja\n`;
                        if (totalWeight) {
                            body += `Peso Total Bruto: ${totalWeight.toFixed(3)} kg\n`;
                        }
                    }

                    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                });
                DOM.modal.closeBtn.addEventListener('click', () => UI.hideModal());
                DOM.modal.overlay.addEventListener('click', (e) => { if (e.target === e.currentTarget) UI.hideModal(); });
                DOM.modal.saveBtn.addEventListener('click', handleSaveCalculation);
                DOM.modal.exportPngBtn.addEventListener('click', exportResultsAsPNG);
                DOM.history.btn.addEventListener('click', () => UI.showHistoryModal());
                DOM.history.closeBtn.addEventListener('click', () => UI.hideHistoryModal());
                DOM.history.overlay.addEventListener('click', (e) => { if (e.target === e.currentTarget) UI.hideHistoryModal(); });
                DOM.history.listContainer.addEventListener('click', handleLoadFromHistory);
                DOM.history.clearBtn.addEventListener('click', handleClearHistory);
                DOM.settings.btn.addEventListener('click', () => UI.showSettingsModal());
                DOM.settings.cancelBtn.addEventListener('click', () => UI.hideSettingsModal());
                DOM.settings.overlay.addEventListener('click', (e) => { if (e.target === e.currentTarget) UI.hideSettingsModal(); });
                DOM.settings.form.addEventListener('submit', (e) => { e.preventDefault(); UI.handleSaveSettings(); });
                DOM.settings.restoreDefaultsBtn.addEventListener('click', () => {
                    PROCESS_MACHINES = JSON.parse(JSON.stringify(DEFAULT_PROCESS_MACHINES));
                    COLLECTIVE_BOXES = JSON.parse(JSON.stringify(DEFAULT_COLLECTIVE_BOXES));
                    PALLETIZING_SETTINGS.standardPalletHeightCm = 15;
                    PALLETIZING_SETTINGS.pallets = [
                        { name: '40" x 48"', widthIn: 40, heightIn: 48, id: 'p1' },
                        { name: '40" x 52"', widthIn: 40, heightIn: 52, id: 'p2' }
                    ];
                    GENERAL_SETTINGS = JSON.parse(JSON.stringify(DEFAULT_GENERAL_SETTINGS));

                    saveSettingsToLocalStorage();
                    UI.populateSettingsForm();
                    UI.showToast("Ajustes restaurados.");
                });

                // Palletize modal listeners
                DOM.modal.palletizeBtn.addEventListener('click', () => UI.showPalletizeModal());
                DOM.palletize.closeBtn.addEventListener('click', () => UI.hidePalletizeModal());
                DOM.palletize.overlay.addEventListener('click', (e) => { if (e.target === e.currentTarget) UI.hidePalletizeModal(); });
                DOM.palletize.calculateBtn.addEventListener('click', handlePalletizeCalculation);

                // Box Options modal listeners
                DOM.boxOptions.closeBtn.addEventListener('click', () => UI.hideBoxOptionsModal());
                DOM.boxOptions.overlay.addEventListener('click', (e) => { if (e.target === e.currentTarget) UI.hideBoxOptionsModal(); });

                // Pallet settings listeners
                DOM.settings.addPalletBtn.addEventListener('click', () => {
                    const name = DOM.settings.newPalletName.value.trim();
                    const width = parseFloat(DOM.settings.newPalletWidth.value);
                    const height = parseFloat(DOM.settings.newPalletHeight.value);
                    if (name && width > 0 && height > 0) {
                        PALLETIZING_SETTINGS.pallets.push({ name, widthIn: width, heightIn: height, id: `p${Date.now()}` });
                        UI.populatePalletList();
                        DOM.settings.newPalletName.value = '';
                        DOM.settings.newPalletWidth.value = '';
                        DOM.settings.newPalletHeight.value = '';
                    } else {
                        UI.showToast('Por favor, completa todos los campos de la nueva tarima.', true);
                    }
                });

                DOM.settings.palletListContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-pallet-btn')) {
                        const idToRemove = e.target.dataset.id;
                        PALLETIZING_SETTINGS.pallets = PALLETIZING_SETTINGS.pallets.filter(p => p.id !== idToRemove);
                        UI.populatePalletList();
                    }
                });

                // Collective Box settings listeners
                DOM.settings.addBoxBtn.addEventListener('click', () => {
                    const material = parseInt(DOM.settings.newBoxMaterial.value, 10);
                    const largo = parseFloat(DOM.settings.newBoxLargo.value);
                    const ancho = parseFloat(DOM.settings.newBoxAncho.value);
                    const alto = parseFloat(DOM.settings.newBoxAlto.value);
                    const flauta = DOM.settings.newBoxFlauta.value;
                    const ect = parseInt(DOM.settings.newBoxEct.value, 10);

                    if (!material || !largo || !ancho || !alto || !flauta || !ect) {
                        UI.showToast('Todos los campos son obligatorios para la caja.', true);
                        return;
                    }
                    if (COLLECTIVE_BOXES.some(b => b.material === material)) {
                        UI.showToast('El n√∫mero de material ya existe.', true);
                        return;
                    }

                    COLLECTIVE_BOXES.push({ material, largo, ancho, alto, flauta, ect });
                    saveSettingsToLocalStorage();
                    UI.populateCollectiveBoxList();
                    UI.showToast('Caja colectiva a√±adida.');

                    DOM.settings.newBoxMaterial.value = '';
                    DOM.settings.newBoxLargo.value = '';
                    DOM.settings.newBoxAncho.value = '';
                    DOM.settings.newBoxAlto.value = '';
                    DOM.settings.newBoxEct.value = '';
                });

                DOM.settings.collectiveBoxListContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-box-btn')) {
                        const materialToRemove = parseInt(e.target.dataset.material, 10);
                        COLLECTIVE_BOXES = COLLECTIVE_BOXES.filter(b => b.material !== materialToRemove);
                        saveSettingsToLocalStorage();
                        UI.showToast('Caja eliminada.');
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (!DOM.boxOptions.overlay.classList.contains('hidden')) UI.hideBoxOptionsModal();
                        else if (!DOM.palletize.overlay.classList.contains('hidden')) UI.hidePalletizeModal();
                        else if (!DOM.history.overlay.classList.contains('hidden')) UI.hideHistoryModal();
                        else if (!DOM.settings.overlay.classList.contains('hidden')) UI.hideSettingsModal();
                        else if (!DOM.modal.overlay.classList.contains('hidden')) UI.hideModal();
                    }
                });

                [
                    DOM.inputs.cutWidth, DOM.inputs.cutHeight, DOM.inputs.glueFlapWidth,
                    DOM.inputs.unit, DOM.inputs.material, DOM.inputs.flute,
                    DOM.inputs.foldingCartonWeight
                ].forEach(input => {
                    input.addEventListener('input', updateFoldedPieceInfo);
                    if (input.tagName === 'SELECT') {
                        input.addEventListener('change', updateFoldedPieceInfo);
                    }
                });

                // Agrega el listener de c√°lculo m√°gico a todos los campos de texto que funcionan como n√∫meros
                document.querySelectorAll('input[type="text"][inputmode="decimal"]').forEach(input => {
                    input.addEventListener('blur', handleMagicCalculation);
                    input.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter') {
                            // Previene que el formulario se env√≠e al presionar Enter
                            event.preventDefault();
                            // Dispara la funci√≥n de c√°lculo
                            handleMagicCalculation(event);
                            // Quita el foco del campo actual
                            input.blur();
                        }
                    });
                });
            }

            async function exportResultsAsPNG() {
                if (!state.lastValidResults) {
                    UI.showToast("No hay resultados para exportar.", true);
                    return;
                }

                const canvas = document.createElement('canvas');
                canvas.width = 1200;
                canvas.height = 1800;
                const ctx = canvas.getContext('2d');

                // --- Drawing Helpers ---
                const drawText = (text, x, y, options = {}) => {
                    ctx.fillStyle = options.color || '#1f2937';
                    ctx.font = options.font || '24px Inter';
                    ctx.textAlign = options.align || 'left';
                    ctx.textBaseline = 'top';
                    ctx.fillText(text, x, y);
                };
                const drawSectionTitle = (text, y) => {
                    ctx.fillStyle = '#1e3a8a';
                    ctx.font = 'bold 32px Inter';
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'top';
                    ctx.fillText(text, 50, y);
                    ctx.strokeStyle = '#dbeafe';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(50, y + 45);
                    ctx.lineTo(1150, y + 45);
                    ctx.stroke();
                    return y + 70;
                };

                // 1. Background
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // --- Data Prep ---
                const folio = DOM.modal.folioInput.value.trim() || 'N/A';
                const cliente = DOM.modal.clienteInput.value.trim() || 'N/A';
                const selectedMachineIndex = parseInt(DOM.modal.rankingContainer.querySelector('.selected-machine')?.dataset.machineIndex || '0', 10);
                const results = state.lastValidResults;
                const data = results.isCustom ? results : results.rankedMachines[selectedMachineIndex];
                const inputs = results.userInputs;
                const palletData = results.palletizingResult;
                const boxData = data.collectiveBoxData?.best;

                let y = 60; // Current Y position for drawing

                // 2. Header
                drawText('Reporte de Optimizaci√≥n de Producci√≥n', canvas.width / 2, y, { font: 'bold 44px Inter', color: '#111827', align: 'center' });
                y += 80;
                drawText(`Folio: ${folio}`, 50, y, { font: '28px Inter' });
                drawText(`Cliente: ${cliente}`, canvas.width / 2, y, { font: '28px Inter' });
                y += 60;

                // 3. Resumen
                y = drawSectionTitle('Resumen del Proceso', y);
                const resumenData = [
                    { label: 'M√°quina Optima:', value: data.name || 'N/A' },
                    { label: 'Troqueladora:', value: data.associatedDieCutter || 'N/A' },
                    { label: 'Pliego Sugerido:', value: `${data.drawing.suggestedSheetW.toFixed(1)} x ${data.drawing.suggestedSheetH.toFixed(1)} ${data.drawing.unit}` },
                    { label: 'Cortes por Pliego:', value: `${data.cuts} outs` }
                ];
                resumenData.forEach((item) => {
                    drawText(`${item.label}`, 80, y, { font: '24px Inter', color: '#4b5563' });
                    drawText(`${item.value}`, 400, y, { font: 'bold 24px Inter' });
                    y += 40;
                });
                y += 30;

                // 4. Ruta 
                y = drawSectionTitle('Ruta de Proceso', y);
                const route = Calculator.generateProcessRoute(data, inputs);
                route.forEach(step => {
                    drawText(`‚Ä¢ ${step.process}:`, 80, y, { font: '24px Inter' });
                    drawText(step.machine, 400, y, { font: 'bold 24px Inter' });
                    y += 40;
                });
                y += 30;

                // 5. Material y Pesos
                y = drawSectionTitle('Material y Pesos', y);
                let materialInfo = [
                    { label: 'Material:', value: inputs.material === 'microcorrugado' ? 'Microcorrugado' : 'Plegadizo' },
                ];
                if (inputs.material === 'microcorrugado') {
                    materialInfo.push({ label: 'Flauta:', value: inputs.flute });
                    if (inputs.ectCheckbox && inputs.linerExt && inputs.medium && inputs.linerInt) {
                        materialInfo.push({ label: 'Combinaci√≥n:', value: `${inputs.linerExt} / ${inputs.medium} / ${inputs.linerInt}` });
                    }
                } else {
                    materialInfo.push({ label: 'Gramaje:', value: `${inputs.foldingCartonWeight} pts` });
                }
                materialInfo.push({ label: 'Peso por Pieza (Bruto):', value: data.pieceGrossWeightKg ? `${data.pieceGrossWeightKg.toFixed(4)} kg` : 'N/A' });

                // A√±adir peso total de la caja si est√° disponible
                if (boxData && boxData.weightData) {
                    materialInfo.push({ label: 'Peso Total Caja Bruto:', value: `${boxData.weightData.totalGrossWeightKg.toFixed(3)} kg` });
                }

                materialInfo.forEach(item => {
                    drawText(`${item.label}`, 80, y, { font: '24px Inter', color: '#4b5563' });
                    drawText(item.value, 400, y, { font: 'bold 24px Inter' });
                    y += 40;
                });
                y += 30;

                // 6. Paletizado
                y = drawSectionTitle('Informaci√≥n de Paletizado', y);
                if (palletData) {
                    let palletInfo = [
                        { label: 'Tarima:', value: palletData.palletName },
                        { label: 'Modo:', value: palletData.mode },
                    ];

                    if (palletData.bundleInfo) {
                        palletInfo.push({ label: 'Atado por Flauta:', value: palletData.bundleInfo });
                    }

                    palletInfo.push(
                        { label: palletData.itemsPerLayerLabel, value: palletData.piecesPerLayer.toLocaleString('es-MX') },
                        { label: 'Camas / Tarima:', value: palletData.layersPerPallet.toLocaleString('es-MX') },
                        { label: 'Total Piezas:', value: palletData.totalPieces.toLocaleString('es-MX') },
                        { label: 'Altura Final Material:', value: `${palletData.materialHeightCm.toFixed(1)} cm` },
                        { label: 'Altura Final Total:', value: `${palletData.finalHeightCm.toFixed(1)} cm` }
                    );

                    const initialY = y;
                    let currentY = y;
                    palletInfo.forEach((item, i) => {
                        drawText(`${item.label}`, 80, currentY, { font: '24px Inter', color: '#4b5563' });
                        drawText(item.value, 400, currentY, { font: 'bold 24px Inter' });
                        currentY += 40;
                    });

                    // Draw pallet canvas on the right
                    const tempPalletCanvas = document.createElement('canvas');
                    tempPalletCanvas.width = 450;
                    tempPalletCanvas.height = 400;
                    // Se llama con el contexto y canvas temporales
                    UI.drawPalletLayout(palletData.palletW_mm, palletData.palletH_mm, palletData.itemW_mm, palletData.itemH_mm, tempPalletCanvas, tempPalletCanvas.getContext('2d'));

                    ctx.drawImage(tempPalletCanvas, 650, initialY - 20, 450, 400);

                } else {
                    drawText('No se pudo calcular el paletizado.', 80, y, { font: '24px Inter', color: '#9ca3af' });
                }

                // 7. Footer
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(50, canvas.height - 80);
                ctx.lineTo(1150, canvas.height - 80);
                ctx.stroke();
                const dateString = new Date().toLocaleString('es-MX', { dateStyle: 'long', timeStyle: 'short' });
                drawText(`Reporte generado el ${dateString}`, canvas.width / 2, canvas.height - 50, { font: '20px Inter', color: '#6b7280', align: 'center' });

                // 8. Download
                const link = document.createElement('a');
                link.download = `Reporte_Folio_${folio.replace(/[^a-z0-9]/gi, '_')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }

            // Inicializaci√≥n de la aplicaci√≥n
            loadSettingsFromLocalStorage();
            loadHistoryFromLocalStorage();
            handleMaterialChange();
            setupEventListeners();
            updateLinerDefaults();
        });
    </script>

    <script>
        function showCotizadorModal() {
            document.getElementById('cotizadorModalContainer').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        function hideCotizadorModal() {
            document.getElementById('cotizadorModalContainer').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    </script>

    <!-- === COTIZADOR MODAL === -->
    <div id="cotizadorModalContainer" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-[9999] hidden overflow-y-auto">
        <button onclick="hideCotizadorModal()"
            class="fixed top-4 right-4 z-[10001] bg-white text-gray-700 hover:bg-red-500 hover:text-white rounded-full p-3 shadow-lg transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        <div class="container mx-auto p-4 lg:p-8 flex items-center justify-center min-h-screen">
            <div class="w-full">
                <div class="text-center mb-8">
                    <h1
                        class="text-4xl font-extrabold text-gray-900 bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                        Hola, ¬øQu√© vamos a optimizar hoy?</h1>
                </div>

                <div id="formContainer"
                    class="w-full max-w-md bg-white p-6 rounded-lg shadow-xl mx-auto border-t-4 border-blue-500">
                    <div class="flex justify-between items-center mb-4 pb-4 border-b">
                        <h2 class="text-lg font-bold text-gray-800">Par√°metros de Corte</h2>
                        <div class="flex items-center gap-1">
                            <button id="historyBtn"
                                class="p-2 rounded-full hover:bg-gray-100 transition-colors print-hide"
                                title="Ver Historial">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>
                            <button id="settingsBtn"
                                class="p-2 rounded-full hover:bg-gray-100 transition-colors print-hide"
                                title="Ajustes de M√°quina">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <form id="cutForm" class="space-y-4">

                        <div class="flex items-center justify-center p-2 bg-gray-50 rounded-lg">
                            <span class="text-sm font-medium text-gray-900 mr-3">Modo √ìptimo</span>
                            <div
                                class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="calculationModeToggle"
                                    class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                                <label for="calculationModeToggle"
                                    class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                            <span class="text-sm font-medium text-gray-900">Modo Manual</span>
                        </div>

                        <div id="customSheetContainer"
                            class="hidden p-4 border-l-4 border-indigo-500 bg-indigo-50 rounded-lg">
                            <label class="block font-medium text-gray-700 mb-2">Tama√±o de Pliego Manual</label>
                            <div class="flex space-x-2">
                                <input type="text" inputmode="decimal" id="customSheetWidth" placeholder="Ancho"
                                    class="w-1/2 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 transition-shadow duration-200" />
                                <input type="text" inputmode="decimal" id="customSheetHeight" placeholder="Alto"
                                    class="w-1/2 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 transition-shadow duration-200" />
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="unit"
                                    class="block font-medium text-sm text-gray-700 mb-1 tracking-wide">Unidad</label>
                                <select id="unit"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200">
                                    <option value="mm" selected>Mil√≠metros (mm)</option>
                                    <option value="cm">Cent√≠metros (cm)</option>
                                    <option value="in">Pulgadas (in)</option>
                                </select>
                            </div>
                            <div>
                                <label for="material"
                                    class="block font-medium text-sm text-gray-700 mb-1 tracking-wide">Material</label>
                                <select id="material"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200">
                                    <option value="microcorrugado">Microcorrugado</option>
                                    <option value="plegadizo">Plegadizo</option>
                                </select>
                            </div>
                        </div>

                        <div id="materialOptionsContainer" class="space-y-4">
                            <div id="fluteContainer">
                                <label for="flute"
                                    class="block font-medium text-sm text-gray-700 mb-1 tracking-wide">Flauta</label>
                                <select id="flute"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200">
                                    <option>Flauta E</option>
                                    <option>Flauta B</option>
                                    <option>Flauta C</option>
                                </select>
                            </div>
                            <div id="ectContainer">
                                <div class="relative flex items-start mt-4">
                                    <div class="flex h-5 items-center">
                                        <input id="ectCheckbox" name="ectCheckbox" type="checkbox"
                                            class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="ectCheckbox" class="font-medium text-gray-700">Aplica ECT</label>
                                    </div>
                                </div>
                                <div id="ectValueContainer" class="hidden mt-2">
                                    <label for="ectValue"
                                        class="block font-medium text-sm text-gray-700 mb-1 tracking-wide">Valor ECT
                                        (lb/in)</label>
                                    <select id="ectValue"
                                        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200">
                                        <option>26</option>
                                        <option>29</option>
                                        <option selected>32</option>
                                        <option>40</option>
                                    </select>
                                    <div id="linerInputsContainer" class="grid grid-cols-3 gap-2 mt-4">
                                        <div>
                                            <label for="linerExt"
                                                class="block font-medium text-xs text-gray-600 mb-1">L.Ext</label>
                                            <input type="text" inputmode="decimal" id="linerExt"
                                                class="w-full p-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500" />
                                        </div>
                                        <div>
                                            <label for="medium"
                                                class="block font-medium text-xs text-gray-600 mb-1">M</label>
                                            <input type="text" inputmode="decimal" id="medium"
                                                class="w-full p-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500" />
                                        </div>
                                        <div>
                                            <label for="linerInt"
                                                class="block font-medium text-xs text-gray-600 mb-1">L.I</label>
                                            <input type="text" inputmode="decimal" id="linerInt"
                                                class="w-full p-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="foldingCartonTypeContainer" class="hidden">
                                <label for="foldingCartonType"
                                    class="block font-medium text-sm text-gray-700 mb-1 tracking-wide">Tipo de
                                    Papel</label>
                                <select id="foldingCartonType"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200">
                                    <option>EPL_Ponderosa</option>
                                    <option>CNK_WRK</option>
                                </select>
                            </div>
                            <div id="foldingCartonWeightContainer" class="hidden">
                                <label for="foldingCartonWeight"
                                    class="block font-medium text-sm text-gray-700 mb-1 tracking-wide">Gramaje
                                    (Puntos)</label>
                                <select id="foldingCartonWeight"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200">
                                    <option>8</option>
                                    <option>10</option>
                                    <option>11</option>
                                    <option>12</option>
                                    <option>14</option>
                                    <option>15</option>
                                    <option>16</option>
                                    <option>17</option>
                                    <option>18</option>
                                    <option>20</option>
                                    <option>22</option>
                                    <option>24</option>
                                    <option>26</option>
                                    <option>28</option>
                                    <option>30</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label for="acomodo"
                                class="block font-medium text-sm text-gray-700 mb-1 tracking-wide">Acomodo</label>
                            <select id="acomodo"
                                class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200">
                                <option value="optimo" selected>√ìptimo</option>
                                <option value="horizontal">Horizontal</option>
                                <option value="vertical">Vertical</option>
                            </select>
                        </div>

                        <div>
                            <label class="block font-medium text-gray-700 mb-1 tracking-wide">Tama√±o del corte
                                (final)</label>
                            <div class="flex space-x-2">
                                <div class="w-1/2">
                                    <input type="text" inputmode="decimal" id="cutWidth" placeholder="Ancho"
                                        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200"
                                        required />
                                    <p class="text-xs text-gray-500 mt-1">Colocar Hilo</p>
                                </div>
                                <div class="w-1/2">
                                    <input type="text" inputmode="decimal" id="cutHeight" placeholder="Alto"
                                        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200"
                                        required />
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-gray-50 rounded-lg space-y-3">
                            <p class="text-sm font-semibold text-gray-800">Ajustes de Impresi√≥n</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="gutter"
                                        class="block font-medium text-sm text-gray-700 mb-1">Medianil</label>
                                    <input type="text" inputmode="decimal" id="gutter" value="3"
                                        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200" />
                                </div>
                                <div>
                                    <label for="sideMargins"
                                        class="block font-medium text-sm text-gray-700 mb-1">Laterales</label>
                                    <input type="text" inputmode="decimal" id="sideMargins" value="10"
                                        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200" />
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="topGripper" class="block font-medium text-sm text-gray-700 mb-1">Pinza
                                        Superior</label>
                                    <input type="text" inputmode="decimal" id="topGripper" value="15"
                                        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200" />
                                </div>
                                <div>
                                    <label for="bottomGripper"
                                        class="block font-medium text-sm text-gray-700 mb-1">Pinza Inferior</label>
                                    <input type="text" inputmode="decimal" id="bottomGripper" value="20"
                                        class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200" />
                                </div>
                            </div>
                        </div>

                        <div class="relative flex items-start">
                            <div class="flex h-5 items-center">
                                <input id="gluing" aria-describedby="gluing-description" name="gluing" type="checkbox"
                                    class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="gluing" class="font-medium text-gray-700">Lleva Pegado</label>
                            </div>
                        </div>

                        <div id="plegadizoBundleContainer" class="hidden pl-8 relative flex items-start mt-2">
                            <div class="flex h-5 items-center">
                                <input id="usePlegadizoBundles" name="usePlegadizoBundles" type="checkbox"
                                    class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="usePlegadizoBundles" class="font-medium text-gray-700">Calcular Atados para
                                    Plegadizo</label>
                                <p class="text-gray-500 text-xs">Agrupa las piezas en atados por altura para paletizado.
                                </p>
                            </div>
                        </div>

                        <div id="gluingOptionsContainer"
                            class="hidden pl-8 space-y-4 border-l-4 border-indigo-200 pt-4 mt-2">
                            <!-- Nuevo checkbox para Fondo Autom√°tico -->
                            <div class="relative flex items-start">
                                <div class="flex h-5 items-center">
                                    <input id="isAutomaticBottom" name="isAutomaticBottom" type="checkbox"
                                        class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="isAutomaticBottom" class="font-medium text-gray-700">Fondo Autom√°tico (5
                                        Dobleces)</label>
                                    <p class="text-gray-500 text-xs">Aplica ajuste emp√≠rico de espesor para apilado.</p>
                                </div>
                            </div>
                            <!-- Fin de nuevo checkbox -->

                            <div class="relative flex items-start">
                                <div class="flex h-5 items-center">
                                    <input id="useCollectiveBox" name="useCollectiveBox" type="checkbox"
                                        class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                        checked>
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="useCollectiveBox" class="font-medium text-gray-700">Calcular Caja
                                        Colectiva</label>
                                    <p class="text-gray-500 text-xs">Busca una caja est√°ndar para empacar las piezas.
                                    </p>
                                </div>
                            </div>
                            <div>
                                <label for="gluingMachine" class="block font-medium text-sm text-gray-700 mb-1">M√°quina
                                    de Pegado</label>
                                <select id="gluingMachine"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200">
                                    <option>ExpertFold</option>
                                    <option>Diana</option>
                                    <option>Amazon</option>
                                </select>
                            </div>
                            <div>
                                <label for="glueFlapWidth" class="block font-medium text-sm text-gray-700 mb-1">Ancho de
                                    Pesta√±a</label>
                                <input type="text" inputmode="decimal" id="glueFlapWidth" value="15"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-shadow duration-200" />
                            </div>
                            <div id="foldedPieceInfoContainer" class="mt-4 p-3 bg-indigo-50 rounded-lg text-sm hidden">
                                <h4 class="font-semibold text-gray-800 mb-2">Dimensiones (Pieza Doblada)</h4>
                                <div class="space-y-1">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Tama√±o Final:</span>
                                        <span id="foldedPieceSize" class="font-bold text-indigo-700">-- mm x --
                                            mm</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Grosor Final:</span>
                                        <span id="foldedPieceThickness" class="font-bold text-indigo-700">-- mm</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="pt-2 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                            <button type="submit"
                                class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-all duration-300 font-semibold shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center justify-center">Calcular</button>
                            <button type="button" id="resetBtn"
                                class="w-full bg-gray-200 text-gray-700 py-3 px-4 rounded-md hover:bg-gray-300 transition-colors font-medium">Limpiar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="modalOverlay"
            class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start justify-center p-4 z-50 hidden transition-opacity duration-300 overflow-y-auto">
            <div id="resultsContainer"
                class="w-full max-w-4xl bg-white p-6 rounded-lg shadow-xl relative my-8 transform transition-all duration-300 scale-95 opacity-0">
                <button id="closeModalBtn"
                    class="absolute -top-2 -right-2 bg-white rounded-full p-1 shadow-md hover:bg-red-500 hover:text-white transition-colors print-hide">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>

                <h2 id="resultsTitle" class="text-xl font-semibold border-b border-gray-200 pb-2 mb-4">Resultados de
                    Optimizaci√≥n</h2>

                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-1 space-y-4">
                        <div>
                            <h3 id="rankingTitle" class="font-semibold text-gray-800 mb-2">Ranking de Impresoras</h3>
                            <div id="machineRanking" class="space-y-3 bg-gray-50 p-3 rounded-lg">
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-2">Ruta de Proceso Sugerida</h3>
                            <div id="processRouteContainer" class="space-y-2">
                            </div>
                        </div>
                        <div id="analysisNotesContainer" class="mt-4 hidden">
                            <details class="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                <summary class="font-semibold text-sm text-amber-800 cursor-pointer">Notas del An√°lisis
                                    de Optimizaci√≥n</summary>
                                <div id="analysisNotesContent"
                                    class="mt-2 text-xs text-amber-700 space-y-2 border-t border-amber-200 pt-2">
                                    <!-- Content will be injected here -->
                                </div>
                            </details>
                        </div>
                        <div id="weightResultsContainer" class="mt-4 hidden">
                        </div>
                        <div id="collectiveBoxContainer" class="mt-4 hidden">
                        </div>
                        <button id="palletizeBtn"
                            class="w-full mt-4 bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors font-medium print-hide flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M3 3a1 1 0 000 2v8a1 1 0 001 1h12a1 1 0 001-1V5a1 1 0 000-2H3zm3 2a1 1 0 011-1h2a1 1 0 110 2H7a1 1 0 01-1-1zm-1 4a1 1 0 100 2h2a1 1 0 100-2H5zm5-4a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1zm-1 4a1 1 0 100 2h2a1 1 0 100-2h-2z"
                                    clip-rule="evenodd" />
                            </svg>
                            Ver Paletizado
                        </button>
                    </div>

                    <div class="w-full md:w-1/2">
                        <p id="previewTitle" class="text-sm font-medium text-center mb-2">Vista Previa</p>
                        <canvas id="cutCanvas" width="675" height="450"
                            class="w-full h-auto bg-white border border-gray-200 rounded-md"></canvas>
                        <div id="previewDetails" class="mt-4 text-sm text-center">
                        </div>
                        <div id="previewLegend" class="mt-3 text-xs">
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="folioInput" class="block text-sm font-medium text-gray-700">Folio</label>
                            <input type="text" id="folioInput" placeholder="Ej: 12345"
                                class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="clienteInput" class="block text-sm font-medium text-gray-700">Nombre de
                                Cliente</label>
                            <input type="text" id="clienteInput" placeholder="Ej: Acme Inc."
                                class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500">
                        </div>
                        <button id="saveBtn"
                            class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition-colors font-medium flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path
                                    d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM5 4a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" />
                                <path fill-rule="evenodd" d="M3 13a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                                    clip-rule="evenodd" />
                            </svg>
                            Guardar
                        </button>
                    </div>
                </div>

                <div class="flex space-x-2 mt-4 print-hide">
                    <button id="printBtn"
                        class="flex-1 bg-green-600 text-white p-2 rounded-md hover:bg-green-700 transition-colors font-medium">Imprimir</button>
                    <button id="emailBtn"
                        class="flex-1 bg-amber-500 text-white p-2 rounded-md hover:bg-amber-600 transition-colors font-medium">Enviar</button>
                    <button id="exportPngBtn"
                        class="flex-1 bg-sky-600 text-white p-2 rounded-md hover:bg-sky-700 transition-colors font-medium">Exportar
                        PNG</button>
                </div>
            </div>
        </div>

        <div id="settingsModalOverlay"
            class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start justify-center p-4 z-50 hidden transition-opacity duration-300 overflow-y-auto">
            <div
                class="w-full max-w-2xl bg-white p-6 rounded-lg shadow-xl relative my-8 transform transition-all duration-300 scale-95 opacity-0">
                <h2 class="text-xl font-semibold border-b border-gray-200 pb-2 mb-4">Ajustes de M√°quina</h2>
                <form id="settingsForm">
                    <div class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                        <details open>
                            <summary class="font-semibold text-gray-800 cursor-pointer py-2 hover:bg-gray-50 rounded">
                                Troqueladoras</summary>
                            <div id="dieCutterSettingsContainer" class="space-y-3 pl-4 pt-2"></div>
                        </details>
                        <details>
                            <summary class="font-semibold text-gray-800 cursor-pointer py-2 hover:bg-gray-50 rounded">
                                Impresoras</summary>
                            <div id="printerSettingsContainer" class="space-y-3 pl-4 pt-2"></div>
                        </details>
                        <details>
                            <summary class="font-semibold text-gray-800 cursor-pointer py-2 hover:bg-gray-50 rounded">
                                Ajustes de Paletizado</summary>
                            <div class="space-y-3 pl-4 pt-2">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <label for="standardPalletHeightInput"
                                        class="block text-sm font-medium text-gray-700">Altura de Tarima Est√°ndar
                                        (cm)</label>
                                    <input type="text" inputmode="decimal" id="standardPalletHeightInput"
                                        class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-700">A√±adir Nueva Tarima</p>
                                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-2 mt-2 items-end">
                                        <input id="newPalletName" placeholder="Nombre (ej: 40x52)"
                                            class="p-2 border border-gray-300 rounded-md sm:col-span-2">
                                        <input id="newPalletWidth" type="text" inputmode="decimal"
                                            placeholder="Ancho (in)" class="p-2 border border-gray-300 rounded-md">
                                        <input id="newPalletHeight" type="text" inputmode="decimal"
                                            placeholder="Alto (in)" class="p-2 border border-gray-300 rounded-md">
                                        <button type="button" id="addPalletBtn"
                                            class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 sm:col-span-4">A√±adir</button>
                                    </div>
                                </div>
                                <div id="palletListContainer" class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-700 mb-2">Tarimas Disponibles</p>
                                </div>
                            </div>
                        </details>
                        <details>
                            <summary class="font-semibold text-gray-800 cursor-pointer py-2 hover:bg-gray-50 rounded">
                                Factores de Producci√≥n</summary>
                            <div class="space-y-3 pl-4 pt-2">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-700 mb-2">Adhesivos (Laminado)</p>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="starchAdhesiveInput"
                                                class="block text-sm font-medium text-gray-700">Almid√≥n (gr/m¬≤)</label>
                                            <input type="text" inputmode="decimal" id="starchAdhesiveInput"
                                                class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div>
                                            <label for="pvaAdhesiveInput"
                                                class="block text-sm font-medium text-gray-700">Adhesivo PVA
                                                (gr/m¬≤)</label>
                                            <input type="text" inputmode="decimal" id="pvaAdhesiveInput"
                                                class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                        </div>
                                    </div>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-700 mb-2">Compensaci√≥n por Pliegue (Espesor)</p>
                                    <div>
                                        <label for="autoBottomCompInput"
                                            class="block text-sm font-medium text-gray-700">Compensaci√≥n Fondo
                                            Autom√°tico (mm)</label>
                                        <input type="text" inputmode="decimal" id="autoBottomCompInput"
                                            class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">Este valor fijo se agrega al espesor de 5
                                        paredes (fondo autom√°tico).</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-700 mb-2">Factores de Conversi√≥n (Medium)</p>
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                        <div>
                                            <label for="mediumFactorE"
                                                class="block text-sm font-medium text-gray-700">Flauta E</label>
                                            <input type="text" inputmode="decimal" id="mediumFactorE"
                                                class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div>
                                            <label for="mediumFactorB"
                                                class="block text-sm font-medium text-gray-700">Flauta B</label>
                                            <input type="text" inputmode="decimal" id="mediumFactorB"
                                                class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div>
                                            <label for="mediumFactorC"
                                                class="block text-sm font-medium text-gray-700">Flauta C</label>
                                            <input type="text" inputmode="decimal" id="mediumFactorC"
                                                class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                        </div>
                                    </div>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <details>
                                        <summary class="font-semibold text-gray-700 cursor-pointer">Gramajes de
                                            Plegadizo (gr/m¬≤)</summary>
                                        <div id="foldingCartonGrammageContainer" class="mt-4 space-y-4">
                                        </div>
                                    </details>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-700 mb-2">F√≥rmula de C√°lculo de Peso Bruto</p>
                                    <div
                                        class="text-xs text-gray-600 bg-white p-3 rounded-md font-mono leading-relaxed">
                                        <p class="font-bold text-indigo-700">Microcorrugado:</p>
                                        <p><span class="font-bold">G<sub>Total</sub></span> = (L<sub>Ext</sub> + (M *
                                            F<sub>Flauta</sub>) + L<sub>Int</sub>) + A<sub>Almid√≥n</sub> +
                                            A<sub>PVA</sub></p>
                                        <hr class="my-2">
                                        <p class="font-bold text-indigo-700">Plegadizo:</p>
                                        <p><span class="font-bold">G<sub>Total</sub></span> = Valor de tabla (Tipo Papel
                                            + Puntos)</p>
                                        <hr class="my-2">
                                        <p><span class="font-bold">P<sub>Pliego (Bruto)</sub></span> = G<sub>Total</sub>
                                            * (Ancho<sub>Pliego</sub> * Alto<sub>Pliego</sub>)</p>
                                        <p><span class="font-bold">P<sub>Pieza (Bruto)</sub></span> = P<sub>Pliego
                                                (Bruto)</sub> / No. Cortes (Incluye el peso de todo el trim y
                                            desperdicio)</p>
                                        <p class="text-gray-500 mt-2">
                                            Donde: <b>G</b>: Gramaje (g/m¬≤), <b>L</b>: Liner, <b>M</b>: Medium,
                                            <b>F</b>: Factor, <b>A</b>: Adhesivo, <b>P</b>: Peso.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </details>
                        <details>
                            <summary class="font-semibold text-gray-800 cursor-pointer py-2 hover:bg-gray-50 rounded">
                                Cajas Colectivas</summary>
                            <div class="space-y-3 pl-4 pt-2">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-700">A√±adir Nueva Caja Colectiva</p>
                                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-2 items-end">
                                        <input id="newBoxMaterial" type="text" inputmode="decimal"
                                            placeholder="Material"
                                            class="p-2 border border-gray-300 rounded-md text-sm">
                                        <input id="newBoxLargo" type="text" inputmode="decimal" placeholder="Largo (mm)"
                                            class="p-2 border border-gray-300 rounded-md text-sm">
                                        <input id="newBoxAncho" type="text" inputmode="decimal" placeholder="Ancho (mm)"
                                            class="p-2 border border-gray-300 rounded-md text-sm">
                                        <input id="newBoxAlto" type="text" inputmode="decimal" placeholder="Alto (mm)"
                                            class="p-2 border border-gray-300 rounded-md text-sm">
                                        <select id="newBoxFlauta" class="p-2 border border-gray-300 rounded-md text-sm">
                                            <option>C</option>
                                            <option>BC</option>
                                            <option>B</option>
                                            <option>E</option>
                                        </select>
                                        <input id="newBoxEct" type="text" inputmode="decimal" placeholder="ECT"
                                            class="p-2 border border-gray-300 rounded-md text-sm">
                                        <button type="button" id="addBoxBtn"
                                            class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 sm:col-span-4 h-10">A√±adir
                                            Caja</button>
                                    </div>
                                </div>
                                <div id="collectiveBoxListContainer" class="p-3 bg-gray-50 rounded-lg">
                                    <details>
                                        <summary class="font-semibold text-gray-700 cursor-pointer">Ver Cajas
                                            Disponibles</summary>
                                        <div id="collectiveBoxListContainer"
                                            class="mt-2 space-y-2 max-h-48 overflow-y-auto pr-2">
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </details>
                    </div>
                    <div class="flex justify-between items-center mt-6 pt-4 border-t">
                        <button type="button" id="restoreDefaultsBtn"
                            class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors font-medium">Restaurar
                            Defecto</button>
                        <div class="flex space-x-4">
                            <button type="button" id="cancelSettingsBtn"
                                class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors font-medium">Cancelar</button>
                            <button type="submit"
                                class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors font-medium">Guardar
                                Cambios</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div id="historyModalOverlay"
            class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start justify-center p-4 z-[60] hidden transition-opacity duration-300 overflow-y-auto">
            <div
                class="w-full max-w-lg bg-white p-6 rounded-lg shadow-xl relative my-8 transform transition-all duration-300 scale-95 opacity-0">
                <button id="closeHistoryModalBtn"
                    class="absolute -top-2 -right-2 bg-white rounded-full p-1 shadow-md hover:bg-red-500 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
                <h2 class="text-xl font-semibold border-b border-gray-200 pb-2 mb-4">Historial de C√°lculos</h2>
                <div id="historyListContainer" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                </div>
                <div class="flex justify-end mt-6 pt-4 border-t">
                    <button type="button" id="clearHistoryBtn"
                        class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors font-medium">Limpiar
                        Historial</button>
                </div>
            </div>
        </div>

        <div id="palletizeModalOverlay"
            class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start justify-center p-4 z-[60] hidden transition-opacity duration-300 overflow-y-auto">
            <div
                class="w-full max-w-lg bg-white p-6 rounded-lg shadow-xl relative my-8 transform transition-all duration-300 scale-95 opacity-0">
                <button id="closePalletizeModalBtn"
                    class="absolute -top-2 -right-2 bg-white rounded-full p-1 shadow-md hover:bg-red-500 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
                <h2 class="text-xl font-semibold border-b border-gray-200 pb-2 mb-4">Calculadora de Paletizado</h2>
                <p id="palletizingModeTitle" class="text-sm text-gray-600 -mt-2 mb-4 text-center"></p>

                <div class="space-y-4">
                    <div>
                        <label for="palletSize" class="block font-medium text-sm text-gray-700 mb-1">Tama√±o de
                            Tarima</label>
                        <select id="palletSize" class="w-full p-2 border border-gray-300 rounded-md">
                        </select>
                    </div>
                    <div>
                        <label for="stackingPattern" class="block font-medium text-sm text-gray-700 mb-1">Tipo de
                            Acomodo</label>
                        <select id="stackingPattern" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="recto">Recto</option>
                            <option value="columnar">Columnar / Intercalado</option>
                        </select>
                    </div>
                    <button id="calculatePalletBtn"
                        class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Calcular
                        Paletizado</button>
                </div>

                <div id="palletizeResultsContainer" class="mt-6 pt-4 border-t border-gray-200 hidden">
                    <h3 class="font-semibold text-gray-800 mb-2">Resultados del Paletizado</h3>
                    <div class="space-y-3">
                        <div class="bg-indigo-100 p-3 rounded-lg text-center">
                            <p class="text-sm font-medium text-indigo-800">Total de Piezas por Tarima</p>
                            <p id="totalPiecesResult" class="text-3xl font-extrabold text-indigo-600">-</p>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <p id="piecesPerLayerLabel" class="text-xs font-medium text-gray-600">Piezas / Cama</p>
                                <p id="piecesPerLayerResult" class="text-lg font-bold text-indigo-600">-</p>
                            </div>
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <p class="text-xs font-medium text-gray-600">Camas / Tarima</p>
                                <p id="layersPerPalletResult" class="text-lg font-bold text-indigo-600">-</p>
                            </div>
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <p class="text-xs font-medium text-gray-600">Altura Material</p>
                                <p id="materialHeightResult" class="text-lg font-bold text-indigo-600">-</p>
                            </div>
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <p class="text-xs font-medium text-gray-600">Altura Final (c/ tarima)</p>
                                <p id="finalHeightResult" class="text-lg font-bold text-indigo-600">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h3 class="font-semibold text-gray-800 mb-2 text-center">Vista Previa del Acomodo en Cama</h3>
                        <canvas id="palletCanvas" width="450" height="400"
                            class="w-full h-auto bg-gray-50 border border-gray-200 rounded-md mx-auto"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="boxOptionsModalOverlay"
            class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start justify-center p-4 z-[70] hidden transition-opacity duration-300 overflow-y-auto">
            <div
                class="w-full max-w-2xl bg-white p-6 rounded-lg shadow-xl relative my-8 transform transition-all duration-300 scale-95 opacity-0">
                <button id="closeBoxOptionsModalBtn"
                    class="absolute -top-2 -right-2 bg-white rounded-full p-1 shadow-md hover:bg-red-500 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
                <h2 class="text-xl font-semibold border-b border-gray-200 pb-2 mb-4">Opciones de Cajas Colectivas
                    Compatibles</h2>
                <div id="boxOptionsList" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                </div>
            </div>
        </div>


        <div id="toast"
            class="fixed top-5 right-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-md opacity-0 transform translate-y-2 transition-all duration-300 z-[100]">
            <p id="toastMessage"></p>
        </div>

    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONFIGURACI√ìN INICIAL Y ESTADO ---

            const DEFAULT_PROCESS_MACHINES = {
                DIE_CUTTERS: [
                    { name: 'Vision-160', maxWidth: 1620, maxHeight: 1103 },
                    { name: 'SP-104', maxWidth: 1050, maxHeight: 735 },
                    { name: 'SP-162', maxWidth: 1650, maxHeight: 1133 },
                    { name: 'SPANTHERA', maxWidth: 1460, maxHeight: 1060 },
                ],
                PRINTERS: [
                    { name: 'KBA-164', maxWidth: 1640, maxHeight: 1205, minWidth: 800, minHeight: 600 },
                    { name: 'KBA-106', maxWidth: 1060, maxHeight: 740, minWidth: 480, minHeight: 340 },
                    { name: 'Landa', maxWidth: 1050, maxHeight: 750, minWidth: 360, minHeight: 297 }, // Opci√≥n Landa Agregada
                ],
                LAMINATORS: [{ name: 'Asitrade Olivini' }]
            };

            let PROCESS_MACHINES = JSON.parse(JSON.stringify(DEFAULT_PROCESS_MACHINES));
            // Cambiado a v3 para forzar la actualizaci√≥n de las m√°quinas por defecto y mostrar Landa
            const SETTINGS_STORAGE_KEY = 'printOptimizerSettings_v3';
            const HISTORY_STORAGE_KEY = 'printOptimizerHistory_v2';
            const PALLET_SETTINGS_STORAGE_KEY = 'printOptimizerPalletSettings_v1';
            const GENERAL_SETTINGS_STORAGE_KEY = 'printOptimizerGeneralSettings_v3'; // Versi√≥n actualizada
            const COLLECTIVE_BOXES_STORAGE_KEY = 'printOptimizerCollectiveBoxes_v1';

            let PALLETIZING_SETTINGS = {
                standardPalletHeightCm: 15,
                maxTotalHeightCm: 135, // <-- MODIFICADO DE 120 A 135
                pallets: [
                    { name: '40" x 48"', widthIn: 40, heightIn: 48, id: 'p1' },
                    { name: '40" x 52"', widthIn: 40, heightIn: 52, id: 'p2' }
                ],
                MATERIAL_THICKNESS: {
                    FLUTES: { 'Flauta E': 1.5, 'Flauta B': 3.0, 'Flauta C': 4.0, 'BC': 7.0 },
                    // CORRECCI√ìN: 1 punto de calibre = 0.001 pulgadas = 0.0254 mm
                    POINTS_TO_MM: 0.0254
                }
            };

            const DEFAULT_GENERAL_SETTINGS = {
                adhesives: { starch: 18, pva: 26 },
                mediumFactors: { 'Flauta E': 1.32, 'Flauta B': 1.35, 'Flauta C': 1.48 },
                foldingCartonGrammage: {
                    'EPL_Ponderosa': { '8': 0, '10': 0, '11': 220, '12': 240, '14': 280, '16': 320, '18': 360, '20': 395, '22': 430, '24': 465, '26': 500, '28': 515 },
                    'CNK_WRK': { '12': 264, '14': 293, '15': 317, '16': 332, '17': 347, '18': 361, '20': 391, '22': 420, '24': 454, '26': 488, '28': 522, '30': 557 }
                },
                automaticBottomCompensation: 2.5 // Compensaci√≥n en mm para fondo autom√°tico (5 capas)
            };

            let GENERAL_SETTINGS = JSON.parse(JSON.stringify(DEFAULT_GENERAL_SETTINGS));

            const DEFAULT_COLLECTIVE_BOXES = [
                { material: 8053159, largo: 450, ancho: 248, alto: 279, flauta: 'C', ect: 32 },
                { material: 8053947, largo: 450, ancho: 434, alto: 279, flauta: 'C', ect: 32 },
                { material: 8054224, largo: 495, ancho: 365, alto: 250, flauta: 'C', ect: 32 },
                { material: 8054351, largo: 498, ancho: 222, alto: 292, flauta: 'C', ect: 44 },
                { material: 8054352, largo: 455, ancho: 300, alto: 178, flauta: 'C', ect: 32 },
                { material: 8054353, largo: 570, ancho: 335, alto: 190, flauta: 'C', ect: 32 },
                { material: 8054648, largo: 505, ancho: 400, alto: 303, flauta: 'C', ect: 32 },
                { material: 8054891, largo: 416, ancho: 345, alto: 265, flauta: 'C', ect: 32 },
                { material: 8055149, largo: 490, ancho: 290, alto: 200, flauta: 'C', ect: 40 },
                { material: 8055543, largo: 398, ancho: 240, alto: 405, flauta: 'BC', ect: 42 },
                { material: 8055559, largo: 400, ancho: 322, alto: 366, flauta: 'C', ect: 32 },
                { material: 8057212, largo: 592, ancho: 272, alto: 200, flauta: 'BC', ect: 42 },
                { material: 8058340, largo: 517, ancho: 347, alto: 447, flauta: 'C', ect: 40 },
                { material: 8058707, largo: 481, ancho: 320, alto: 408, flauta: 'C', ect: 32 },
                { material: 8059293, largo: 390, ancho: 290, alto: 262, flauta: 'C', ect: 40 },
                { material: 8059445, largo: 561, ancho: 396, alto: 539, flauta: 'C', ect: 32 },
                { material: 8059446, largo: 392, ancho: 333, alto: 374, flauta: 'C', ect: 32 },
                { material: 8060100, largo: 498, ancho: 396, alto: 406, flauta: 'C', ect: 32 },
                { material: 8060103, largo: 594, ancho: 338, alto: 425, flauta: 'C', ect: 32 },
                { material: 8061381, largo: 423, ancho: 352, alto: 334, flauta: 'BC', ect: 51 },
                { material: 8063254, largo: 415, ancho: 255, alto: 402, flauta: 'C', ect: 40 },
                { material: 8063837, largo: 505, ancho: 400, alto: 356, flauta: 'C', ect: 40 },
                { material: 8064494, largo: 450, ancho: 388, alto: 352, flauta: 'C', ect: 40 },
                { material: 8064495, largo: 450, ancho: 395, alto: 310, flauta: 'C', ect: 32 },
                { material: 8066556, largo: 535, ancho: 395, alto: 415, flauta: 'C', ect: 40 },
                { material: 8067555, largo: 450, ancho: 320, alto: 370, flauta: 'C', ect: 32 },
                { material: 8067995, largo: 460, ancho: 381, alto: 206, flauta: 'C', ect: 32 },
                { material: 8070983, largo: 450, ancho: 250, alto: 410, flauta: 'C', ect: 32 },
                { material: 8072982, largo: 672, ancho: 420, alto: 518, flauta: 'C', ect: 40 },
                { material: 8073215, largo: 560, ancho: 330, alto: 267, flauta: 'C', ect: 40 },
                { material: 8073350, largo: 490, ancho: 306, alto: 237, flauta: 'C', ect: 32 },
                { material: 8073381, largo: 585, ancho: 300, alto: 178, flauta: 'C', ect: 32 },
                { material: 8055535, largo: 327, ancho: 255, alto: 374, flauta: 'C', ect: 32 }
            ];

            let COLLECTIVE_BOXES = [];


            const DOM = {
                form: document.getElementById('cutForm'),
                submitBtn: document.querySelector('#cutForm button[type="submit"]'),
                inputs: {
                    unit: document.getElementById('unit'),
                    material: document.getElementById('material'),
                    flute: document.getElementById('flute'),
                    foldingCartonWeight: document.getElementById('foldingCartonWeight'),
                    acomodo: document.getElementById('acomodo'),
                    cutWidth: document.getElementById('cutWidth'),
                    cutHeight: document.getElementById('cutHeight'),
                    gutter: document.getElementById('gutter'),
                    sideMargins: document.getElementById('sideMargins'),
                    topGripper: document.getElementById('topGripper'),
                    bottomGripper: document.getElementById('bottomGripper'),
                    gluing: document.getElementById('gluing'),
                    gluingMachine: document.getElementById('gluingMachine'),
                    glueFlapWidth: document.getElementById('glueFlapWidth'),
                    calculationModeToggle: document.getElementById('calculationModeToggle'),
                    customSheetWidth: document.getElementById('customSheetWidth'),
                    customSheetHeight: document.getElementById('customSheetHeight'),
                    ectCheckbox: document.getElementById('ectCheckbox'),
                    ectValue: document.getElementById('ectValue'),
                    linerExt: document.getElementById('linerExt'),
                    medium: document.getElementById('medium'),
                    linerInt: document.getElementById('linerInt'),
                    useCollectiveBox: document.getElementById('useCollectiveBox'),
                    foldingCartonType: document.getElementById('foldingCartonType'),
                    usePlegadizoBundles: document.getElementById('usePlegadizoBundles'),
                    isAutomaticBottom: document.getElementById('isAutomaticBottom'), // <-- NUEVO
                },
                customSheetContainer: document.getElementById('customSheetContainer'),
                plegadizoBundleContainer: document.getElementById('plegadizoBundleContainer'),
                gluingOptionsContainer: document.getElementById('gluingOptionsContainer'),
                ectValueContainer: document.getElementById('ectValueContainer'),
                materialOptions: {
                    fluteContainer: document.getElementById('fluteContainer'),
                    ectContainer: document.getElementById('ectContainer'),
                    foldingCartonTypeContainer: document.getElementById('foldingCartonTypeContainer'),
                    foldingCartonWeightContainer: document.getElementById('foldingCartonWeightContainer'),
                },
                resetBtn: document.getElementById('resetBtn'),
                modal: {
                    overlay: document.getElementById('modalOverlay'),
                    container: document.getElementById('resultsContainer'),
                    resultsTitle: document.getElementById('resultsTitle'),
                    rankingTitle: document.getElementById('rankingTitle'),
                    rankingContainer: document.getElementById('machineRanking'),
                    processRouteContainer: document.getElementById('processRouteContainer'),
                    analysisNotesContainer: document.getElementById('analysisNotesContainer'),
                    analysisNotesContent: document.getElementById('analysisNotesContent'),
                    weightResultsContainer: document.getElementById('weightResultsContainer'),
                    collectiveBoxContainer: document.getElementById('collectiveBoxContainer'),
                    palletizeBtn: document.getElementById('palletizeBtn'),
                    previewTitle: document.getElementById('previewTitle'),
                    previewDetails: document.getElementById('previewDetails'),
                    previewLegend: document.getElementById('previewLegend'),
                    closeBtn: document.getElementById('closeModalBtn'),
                    printBtn: document.getElementById('printBtn'),
                    emailBtn: document.getElementById('emailBtn'),
                    exportPngBtn: document.getElementById('exportPngBtn'),
                    folioInput: document.getElementById('folioInput'),
                    clienteInput: document.getElementById('clienteInput'),
                    saveBtn: document.getElementById('saveBtn'),
                },
                settings: {
                    btn: document.getElementById('settingsBtn'),
                    overlay: document.getElementById('settingsModalOverlay'),
                    container: document.getElementById('settingsModalOverlay').querySelector('.transform'),
                    form: document.getElementById('settingsForm'),
                    dieCutterContainer: document.getElementById('dieCutterSettingsContainer'),
                    printerContainer: document.getElementById('printerSettingsContainer'),
                    cancelBtn: document.getElementById('cancelSettingsBtn'),
                    restoreDefaultsBtn: document.getElementById('restoreDefaultsBtn'),
                    standardPalletHeightInput: document.getElementById('standardPalletHeightInput'),
                    newPalletName: document.getElementById('newPalletName'),
                    newPalletWidth: document.getElementById('newPalletWidth'),
                    newPalletHeight: document.getElementById('newPalletHeight'),
                    addPalletBtn: document.getElementById('addPalletBtn'),
                    palletListContainer: document.getElementById('palletListContainer'),
                    starchAdhesiveInput: document.getElementById('starchAdhesiveInput'),
                    pvaAdhesiveInput: document.getElementById('pvaAdhesiveInput'),
                    autoBottomCompInput: document.getElementById('autoBottomCompInput'), // <-- NUEVO
                    mediumFactorE: document.getElementById('mediumFactorE'),
                    mediumFactorB: document.getElementById('mediumFactorB'),
                    mediumFactorC: document.getElementById('mediumFactorC'),
                    foldingCartonGrammageContainer: document.getElementById('foldingCartonGrammageContainer'),
                    newBoxMaterial: document.getElementById('newBoxMaterial'),
                    newBoxLargo: document.getElementById('newBoxLargo'),
                    newBoxAncho: document.getElementById('newBoxAncho'),
                    newBoxAlto: document.getElementById('newBoxAlto'),
                    newBoxFlauta: document.getElementById('newBoxFlauta'),
                    newBoxEct: document.getElementById('newBoxEct'),
                    addBoxBtn: document.getElementById('addBoxBtn'),
                    collectiveBoxListContainer: document.getElementById('collectiveBoxListContainer'),
                },
                history: {
                    btn: document.getElementById('historyBtn'),
                    overlay: document.getElementById('historyModalOverlay'),
                    container: document.getElementById('historyModalOverlay').querySelector('.transform'),
                    listContainer: document.getElementById('historyListContainer'),
                    closeBtn: document.getElementById('closeHistoryModalBtn'),
                    clearBtn: document.getElementById('clearHistoryBtn'),
                },
                palletize: {
                    overlay: document.getElementById('palletizeModalOverlay'),
                    container: document.getElementById('palletizeModalOverlay').querySelector('.transform'),
                    closeBtn: document.getElementById('closePalletizeModalBtn'),
                    calculateBtn: document.getElementById('calculatePalletBtn'),
                    palletSize: document.getElementById('palletSize'),
                    stackingPattern: document.getElementById('stackingPattern'),
                    resultsContainer: document.getElementById('palletizeResultsContainer'),
                    piecesPerLayerResult: document.getElementById('piecesPerLayerResult'),
                    layersPerPalletResult: document.getElementById('layersPerPalletResult'),
                    totalPiecesResult: document.getElementById('totalPiecesResult'),
                    materialHeightResult: document.getElementById('materialHeightResult'),
                    finalHeightResult: document.getElementById('finalHeightResult'),
                    palletCanvas: document.getElementById('palletCanvas'),
                    palletCtx: document.getElementById('palletCanvas').getContext('2d'),
                    palletizingModeTitle: document.getElementById('palletizingModeTitle'),
                    piecesPerLayerLabel: document.getElementById('piecesPerLayerLabel'),
                },
                boxOptions: {
                    overlay: document.getElementById('boxOptionsModalOverlay'),
                    container: document.getElementById('boxOptionsModalOverlay').querySelector('.transform'),
                    list: document.getElementById('boxOptionsList'),
                    closeBtn: document.getElementById('closeBoxOptionsModalBtn'),
                },
                foldedPieceInfo: {
                    container: document.getElementById('foldedPieceInfoContainer'),
                    size: document.getElementById('foldedPieceSize'),
                    thickness: document.getElementById('foldedPieceThickness'),
                },
                canvas: {
                    el: document.getElementById('cutCanvas'),
                    ctx: document.getElementById('cutCanvas').getContext('2d'),
                },
                toast: {
                    el: document.getElementById('toast'),
                    message: document.getElementById('toastMessage'),
                }
            };

            let state = {
                lastValidResults: null,
                history: [],
            };

            /**
             * Eval√∫a de forma segura una expresi√≥n matem√°tica b√°sica de una cadena.
             * @param {string} expression La expresi√≥n matem√°tica a evaluar.
             * @returns {number|null} El resultado del c√°lculo o null si no es v√°lido.
             */
            function safeCalculate(expression) {
                // Solo permite n√∫meros, puntos decimales, operadores b√°sicos, par√©ntesis y espacios.
                const sanitizedExpression = expression.trim();
                const validCharsRegex = /^[0-9\.\+\-\*\/\(\)\s]+$/;

                if (!validCharsRegex.test(sanitizedExpression)) {
                    console.error("La expresi√≥n contiene caracteres no v√°lidos.");
                    return null; // Contiene caracteres no v√°lidos
                }

                try {
                    // Usamos el constructor de Function para una evaluaci√≥n m√°s segura que eval().
                    const result = new Function('return ' + sanitizedExpression)();
                    if (typeof result === 'number' && isFinite(result)) {
                        return result;
                    }
                    return null;
                } catch (error) {
                    console.error("Error al evaluar la expresi√≥n:", error);
                    return null; // Error de sintaxis en la expresi√≥n
                }
            }

            /**
             * Manejador de eventos para verificar y realizar c√°lculos en los campos de entrada.
             * @param {Event} event El evento blur o keydown.
             */
            function handleMagicCalculation(event) {
                const input = event.target;
                let value = input.value.trim();

                if (value.startsWith('=')) {
                    const expression = value.substring(1);
                    const result = safeCalculate(expression);

                    if (result !== null) {
                        // Actualiza el campo con el valor calculado, formateado a 4 decimales
                        // para ser consistente con el atributo step="0.0001" de varios campos.
                        input.value = parseFloat(result.toFixed(4));

                        // Disparamos manualmente un evento 'input' para que otros listeners 
                        // de la app (como el de la info de pieza doblada) puedan reaccionar al cambio.
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
            }

            // --- L√ìGICA DE PERSISTENCIA (LocalStorage) ---
            function saveSettingsToLocalStorage() {
                try {
                    localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(PROCESS_MACHINES));
                    localStorage.setItem(PALLET_SETTINGS_STORAGE_KEY, JSON.stringify(PALLETIZING_SETTINGS));
                    localStorage.setItem(GENERAL_SETTINGS_STORAGE_KEY, JSON.stringify(GENERAL_SETTINGS));
                    localStorage.setItem(COLLECTIVE_BOXES_STORAGE_KEY, JSON.stringify(COLLECTIVE_BOXES));
                } catch (e) {
                    console.error("Error al guardar ajustes en localStorage:", e);
                }
            }

            function loadSettingsFromLocalStorage() {
                try {
                    const savedMachineSettings = localStorage.getItem(SETTINGS_STORAGE_KEY);
                    if (savedMachineSettings) {
                        const parsedSettings = JSON.parse(savedMachineSettings);
                        if (parsedSettings.DIE_CUTTERS && parsedSettings.PRINTERS) {
                            PROCESS_MACHINES = parsedSettings;
                        }
                    }
                    const savedPalletSettings = localStorage.getItem(PALLET_SETTINGS_STORAGE_KEY);
                    if (savedPalletSettings) {
                        PALLETIZING_SETTINGS = JSON.parse(savedPalletSettings);
                    }
                    const savedGeneralSettings = localStorage.getItem(GENERAL_SETTINGS_STORAGE_KEY);
                    if (savedGeneralSettings) {
                        const parsed = JSON.parse(savedGeneralSettings);
                        if (parsed.adhesives) GENERAL_SETTINGS.adhesives = { ...GENERAL_SETTINGS.adhesives, ...parsed.adhesives };
                        if (parsed.mediumFactors) GENERAL_SETTINGS.mediumFactors = { ...GENERAL_SETTINGS.mediumFactors, ...parsed.mediumFactors };
                        if (parsed.automaticBottomCompensation !== undefined) GENERAL_SETTINGS.automaticBottomCompensation = parsed.automaticBottomCompensation; // <-- NUEVO
                        if (parsed.foldingCartonGrammage) {
                            for (const paperType in parsed.foldingCartonGrammage) {
                                if (GENERAL_SETTINGS.foldingCartonGrammage[paperType]) {
                                    GENERAL_SETTINGS.foldingCartonGrammage[paperType] = { ...GENERAL_SETTINGS.foldingCartonGrammage[paperType], ...parsed.foldingCartonGrammage[paperType] }
                                } else {
                                    GENERAL_SETTINGS.foldingCartonGrammage[paperType] = parsed.foldingCartonGrammage[paperType];
                                }
                            }
                        }
                    }
                    const savedBoxes = localStorage.getItem(COLLECTIVE_BOXES_STORAGE_KEY);
                    if (savedBoxes) {
                        const parsedBoxes = JSON.parse(savedBoxes);
                        if (Array.isArray(parsedBoxes)) {
                            COLLECTIVE_BOXES = parsedBoxes;
                        } else {
                            COLLECTIVE_BOXES = JSON.parse(JSON.stringify(DEFAULT_COLLECTIVE_BOXES));
                        }
                    } else {
                        COLLECTIVE_BOXES = JSON.parse(JSON.stringify(DEFAULT_COLLECTIVE_BOXES));
                    }
                } catch (e) {
                    console.error("Error al cargar o parsear ajustes de localStorage:", e);
                    PROCESS_MACHINES = JSON.parse(JSON.stringify(DEFAULT_PROCESS_MACHINES));
                    COLLECTIVE_BOXES = JSON.parse(JSON.stringify(DEFAULT_COLLECTIVE_BOXES));
                }
            }

            function saveHistoryToLocalStorage() {
                try {
                    localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(state.history));
                } catch (e) {
                    console.error("Error al guardar historial:", e);
                }
            }

            function loadHistoryFromLocalStorage() {
                try {
                    const savedHistory = localStorage.getItem(HISTORY_STORAGE_KEY);
                    if (savedHistory) {
                        state.history = JSON.parse(savedHistory);
                    }
                } catch (e) {
                    state.history = [];
                    console.error("Error al cargar historial:", e);
                }
            }

            // Funci√≥n auxiliar para obtener el gramaje de la caja colectiva
            function getCollectiveBoxGrammage(box) {
                // Asume un gramaje est√°ndar para liner y medium basado en ECT y Flauta.
                // Esto es una simplificaci√≥n, ya que el peso real de la caja deber√≠a ser un dato de dise√±o (SKU).
                // Usaremos ECT y Flauta para estimar el peso total de la composici√≥n (suministrado por el usuario en los ajustes).
                const FLUTE_FACTOR = GENERAL_SETTINGS.mediumFactors[box.flauta] || 1;

                // Dado que solo se tiene ECT y Flauta en el objeto box, se necesita una estimaci√≥n.
                // Simplificaci√≥n: usaremos ECT * 15 como un factor de conversi√≥n muy burdo (s√≥lo para fines de este ejercicio)
                if (box.flauta) {
                    return (box.ect * 15) * FLUTE_FACTOR;
                }

                return 500; // Gramaje de fallback (g/m¬≤)
            }


            // --- M√ìDULO DE C√ÅLCULO ---
            const Calculator = {
                getOptimizedResults() {
                    const inputs = this.getValidatedInputs();
                    if (!inputs) return null;

                    let results;
                    if (inputs.calculationModeToggle) {
                        results = this.calculateForCustomSheet(inputs);
                    } else {
                        results = this.calculateForOptimalSheet(inputs);
                    }

                    if (results) {
                        if (inputs.gluing && inputs.useCollectiveBox) {
                            const collectiveBoxData = this.findBestCollectiveBox(results, inputs);
                            if (results.rankedMachines) {
                                results.rankedMachines.forEach(machine => machine.collectiveBoxData = collectiveBoxData);
                            } else {
                                results.collectiveBoxData = collectiveBoxData;
                            }
                        }
                        results.palletizingResult = this.getPalletizeResults(results);
                    }

                    return results;
                },

                // **********************************************
                // FUNCI√ìN PARA CALCULAR EL PESO DE LA CAJA COLECTIVA
                // **********************************************
                calculateCollectiveBoxWeight(box, pieceGrossWeightKg, pieceCapacity) {
                    const largo = box.largo / 1000; // m
                    const ancho = box.ancho / 1000; // m
                    const alto = box.alto / 1000;   // m

                    // Estimaci√≥n del √°rea de cart√≥n de la caja (f√≥rmula RSC simplificada A=2(LW+LH+WH))
                    // Se asume un pliego plano para la caja colectiva (incluye desperdicio de fabricaci√≥n)
                    const boxAreaM2 = (2 * (largo * ancho + largo * alto + ancho * alto)) * 1.05; // +5% por pesta√±as y desperdicio

                    // Obtener el gramaje estimado de la caja (g/m¬≤)
                    const boxGrammageG_M2 = getCollectiveBoxGrammage(box);

                    // Peso de la caja vac√≠a (kg)
                    const emptyBoxWeightKg = (boxAreaM2 * boxGrammageG_M2) / 1000;

                    // Peso Neto de las piezas (kg)
                    const piecesNetWeightKg = pieceGrossWeightKg * pieceCapacity;

                    // Peso Bruto Total (kg)
                    const totalGrossWeightKg = emptyBoxWeightKg + piecesNetWeightKg;

                    return {
                        emptyBoxWeightKg: emptyBoxWeightKg,
                        piecesNetWeightKg: piecesNetWeightKg,
                        totalGrossWeightKg: totalGrossWeightKg
                    };
                },


                findBestCollectiveBox(result, inputs) {
                    const toMM = (value, unit) => (unit === 'cm' ? value * 10 : unit === 'in' ? value * 25.4 : value);

                    const flatDim1 = toMM(inputs.cutWidth, inputs.unit);
                    const flatDim2 = toMM(inputs.cutHeight, inputs.unit);
                    const flap = toMM(inputs.glueFlapWidth, inputs.unit);

                    const flatLong = Math.max(flatDim1, flatDim2);
                    const flatShort = Math.min(flatDim1, flatDim2);

                    const pieceH = (flatLong - flap) / 2;
                    const pieceL = flatShort;

                    let pieceThickness = 0;
                    const isAutomaticBottom = inputs.isAutomaticBottom;
                    let nominalThickness = 0;

                    if (inputs.material === 'microcorrugado') {
                        nominalThickness = PALLETIZING_SETTINGS.MATERIAL_THICKNESS.FLUTES[inputs.flute] || 0;
                    } else {
                        nominalThickness = (PALLETIZING_SETTINGS.MATERIAL_THICKNESS.POINTS_TO_MM * inputs.foldingCartonWeight);
                    }

                    if (nominalThickness > 0) {
                        if (isAutomaticBottom) {
                            // Fondo Autom√°tico: 5 capas nominales + Compensaci√≥n Fija
                            const layers = 5;
                            const compensation = GENERAL_SETTINGS.automaticBottomCompensation || 0;
                            pieceThickness = (nominalThickness * layers) + compensation;
                        } else {
                            // Pegado Lineal: 2 capas nominales + 50% de holgura
                            const layers = 2;
                            const holgura = nominalThickness * 0.5;
                            pieceThickness = (nominalThickness * layers) + holgura;
                        }
                    }

                    if (pieceL <= 0 || pieceH <= 0 || pieceThickness <= 0) return { best: null, all: [] };


                    let compatibleBoxes = COLLECTIVE_BOXES.map(box => {
                        // pieceH es el alto doblado (Largo de la pieza - Pesta√±a) / 2
                        // box.alto es la altura de la caja colectiva
                        if (pieceH > box.alto) {
                            return null;
                        }

                        let capacity = 0;
                        let waste = Infinity;
                        let finalFitDim;

                        // Acomodo 1: Ancho de la caja / Espesor
                        if (pieceL <= box.largo) {
                            capacity = Math.floor(box.ancho / pieceThickness);
                            waste = (box.largo * box.alto) - (pieceL * pieceH);
                            finalFitDim = 'ancho';
                        }

                        // Acomodo 2 (Rotado): Largo de la caja / Espesor
                        if (pieceL <= box.ancho) {
                            const capacityRotated = Math.floor(box.largo / pieceThickness);
                            const wasteRotated = (box.ancho * box.alto) - (pieceL * pieceH);

                            if (wasteRotated < waste) {
                                capacity = capacityRotated;
                                waste = wasteRotated;
                                finalFitDim = 'largo';
                            }
                        }

                        if (capacity > 0) {
                            const weightData = this.calculateCollectiveBoxWeight(box, result.pieceGrossWeightKg || 0, capacity);

                            return { ...box, capacity, waste, finalFitDim, weightData };
                        }
                        return null;
                    }).filter(Boolean);

                    compatibleBoxes.sort((a, b) => a.waste - b.waste);

                    return {
                        best: compatibleBoxes.length > 0 ? compatibleBoxes[0] : null,
                        all: compatibleBoxes,
                        foldedPiece: { foldedL: pieceL, foldedH: pieceH, pieceThickness }
                    };
                },

                calculateWeightAndArea(result, inputs) {
                    if (!result || !result.drawing || result.cuts === 0) {
                        return result;
                    }

                    // √Årea total del pliego sugerido (incluye m√°rgenes, pinzas y trim)
                    const sheetW_m = result.drawing.suggestedSheetW / 1000;
                    const sheetH_m = result.drawing.suggestedSheetH / 1000;
                    const sheetArea_m2 = sheetW_m * sheetH_m;
                    let totalGrammage_g_m2 = 0;

                    if (inputs.material === 'microcorrugado' && inputs.ectCheckbox) {
                        const linerExt_g = parseFloat(inputs.linerExt) || 0;
                        const medium_g = parseFloat(inputs.medium) || 0;
                        const linerInt_g = parseFloat(inputs.linerInt) || 0;

                        if (linerExt_g <= 0 || medium_g <= 0 || linerInt_g <= 0) {
                            return result; // Not enough data
                        }

                        const fluteFactor = GENERAL_SETTINGS.mediumFactors[inputs.flute] || 1;
                        const effectiveMedium_g = medium_g * fluteFactor;
                        const paperGrammage_g_m2 = linerExt_g + effectiveMedium_g + linerInt_g;
                        const adhesiveGrammage_g_m2 = GENERAL_SETTINGS.adhesives.starch + GENERAL_SETTINGS.adhesives.pva;
                        totalGrammage_g_m2 = paperGrammage_g_m2 + adhesiveGrammage_g_m2;

                    } else if (inputs.material === 'plegadizo') {
                        const paperType = inputs.foldingCartonType;
                        const points = inputs.foldingCartonWeight;
                        if (GENERAL_SETTINGS.foldingCartonGrammage[paperType] && GENERAL_SETTINGS.foldingCartonGrammage[paperType][points]) {
                            totalGrammage_g_m2 = GENERAL_SETTINGS.foldingCartonGrammage[paperType][points];
                        }
                    }

                    if (totalGrammage_g_m2 > 0 && sheetArea_m2 > 0) {
                        const sheetGrossWeight_g = totalGrammage_g_m2 * sheetArea_m2;
                        // El peso bruto de la pieza incluye el peso del trim por imposici√≥n:
                        // Peso_Total_Pliego / N√∫mero_de_Cortes
                        const pieceGrossWeight_g = sheetGrossWeight_g / result.cuts;

                        result.pieceGrossWeightKg = pieceGrossWeight_g / 1000;
                        result.sheetGrossWeightKg = sheetGrossWeight_g / 1000;
                        result.sheetAreaM2 = sheetArea_m2;
                    } else {
                        delete result.pieceGrossWeightKg;
                        delete result.sheetGrossWeightKg;
                        delete result.sheetAreaM2;
                    }

                    return result;
                },

                calculateForCustomSheet(inputs) {
                    const toMM = (value, unit) => (unit === 'cm' ? value * 10 : unit === 'in' ? value * 25.4 : value);

                    const pieceW_hilo = toMM(inputs.cutWidth, inputs.unit);
                    const pieceH_contrahilo = toMM(inputs.cutHeight, inputs.unit);
                    const gutter = toMM(inputs.gutter, inputs.unit);
                    const sideMargins = toMM(inputs.sideMargins, inputs.unit);
                    const topGripper = toMM(inputs.topGripper, inputs.unit);
                    const bottomGripper = toMM(inputs.bottomGripper, inputs.unit);

                    const sheetW = toMM(inputs.customSheetWidth, inputs.unit);
                    const sheetH = toMM(inputs.customSheetHeight, inputs.unit);

                    const usableSheetW = Math.max(0, sheetW - (sideMargins * 2));
                    const usableSheetH = Math.max(0, sheetH - topGripper - bottomGripper);

                    // Correctly assign piece dimensions for visual layout based on acomodo
                    const grainHorizontalLayoutCalc = this.calculateLayout(usableSheetW, usableSheetH, pieceW_hilo, pieceH_contrahilo, gutter);
                    const grainVerticalLayoutCalc = this.calculateLayout(usableSheetW, usableSheetH, pieceH_contrahilo, pieceW_hilo, gutter);

                    let bestLayout;
                    let finalOrientation;
                    switch (inputs.acomodo) {
                        case 'horizontal':
                            bestLayout = { ...grainHorizontalLayoutCalc, pieceW: pieceW_hilo, pieceH: pieceH_contrahilo };
                            finalOrientation = 'Hilo Horizontal';
                            break;
                        case 'vertical':
                            bestLayout = { ...grainVerticalLayoutCalc, pieceW: pieceH_contrahilo, pieceH: pieceW_hilo };
                            finalOrientation = 'Hilo Vertical';
                            break;
                        case 'optimo':
                        default:
                            if (grainHorizontalLayoutCalc.cuts >= grainVerticalLayoutCalc.cuts) {
                                bestLayout = { ...grainHorizontalLayoutCalc, pieceW: pieceW_hilo, pieceH: pieceH_contrahilo };
                                finalOrientation = 'Hilo Horizontal';
                            } else {
                                // FIX: Corregido el typo 'pieceW_ilo' a 'pieceW_hilo' (Error de ejecuci√≥n en versi√≥n anterior)
                                bestLayout = { ...grainVerticalLayoutCalc, pieceW: pieceH_contrahilo, pieceH: pieceW_hilo };
                                finalOrientation = 'Hilo Vertical';
                            }
                            break;
                    }


                    if (bestLayout.cuts === 0) {
                        return { isCustom: true, cuts: 0, compatiblePrinters: [], compatibleDieCutters: [], userInputs: inputs };
                    }

                    const compatiblePrinters = PROCESS_MACHINES.PRINTERS.filter(p => (p.maxWidth >= sheetW && p.maxHeight >= sheetH && p.minWidth <= sheetW && p.minHeight <= sheetH));

                    let availableDieCutters = [];
                    if (inputs.material === 'microcorrugado') {
                        availableDieCutters = PROCESS_MACHINES.DIE_CUTTERS.filter(m => m.name === 'Vision-160');
                    } else {
                        availableDieCutters = PROCESS_MACHINES.DIE_CUTTERS.filter(m => m.name !== 'Vision-160');
                    }
                    const compatibleDieCutters = availableDieCutters.filter(dc => (dc.maxWidth >= sheetW && dc.maxHeight >= sheetH));

                    const usedAreaW = (bestLayout.cols * bestLayout.pieceW) + (Math.max(0, bestLayout.cols - 1) * gutter);
                    const usedAreaH = (bestLayout.rows * bestLayout.pieceH) + (Math.max(0, bestLayout.rows - 1) * gutter);

                    let finalResult = {
                        isCustom: true,
                        cuts: bestLayout.cuts,
                        orientation: finalOrientation,
                        compatiblePrinters: compatiblePrinters.map(p => p.name),
                        compatibleDieCutters: compatibleDieCutters.map(dc => dc.name),
                        userInputs: inputs,
                        drawing: {
                            sheetW, sheetH, sideMargins, topGripper, bottomGripper,
                            cols: bestLayout.cols, rows: bestLayout.rows, gutter,
                            pieceW: bestLayout.pieceW, pieceH: bestLayout.pieceH,
                            usedAreaW, usedAreaH, suggestedSheetW: sheetW, suggestedSheetH: sheetH,
                            unit: inputs.unit,
                        }
                    };

                    finalResult = this.calculateWeightAndArea(finalResult, inputs);
                    return finalResult;
                },

                calculateForOptimalSheet(inputs) {
                    const toMM = (value, unit) => (unit === 'cm' ? value * 10 : unit === 'in' ? value * 25.4 : value);
                    const pieceW_hilo = toMM(inputs.cutWidth, inputs.unit);
                    const pieceH_contrahilo = toMM(inputs.cutHeight, inputs.unit);
                    const gutter = toMM(inputs.gutter, inputs.unit);
                    const sideMargins = toMM(inputs.sideMargins, inputs.unit);
                    const topGripper = toMM(inputs.topGripper, inputs.unit);
                    const bottomGripper = toMM(inputs.bottomGripper, inputs.unit);

                    let analysisNotes = [];

                    const allPrinterResults = PROCESS_MACHINES.PRINTERS.map(printer => {
                        const usableSheetW = Math.max(0, printer.maxWidth - (sideMargins * 2));
                        const usableSheetH = Math.max(0, printer.maxHeight - topGripper - bottomGripper);

                        const grainHorizontalLayoutCalc = this.calculateLayout(usableSheetW, usableSheetH, pieceW_hilo, pieceH_contrahilo, gutter);
                        const grainVerticalLayoutCalc = this.calculateLayout(usableSheetW, usableSheetH, pieceH_contrahilo, pieceW_hilo, gutter);

                        const grainHorizontalLayout = { ...grainHorizontalLayoutCalc, pieceW: pieceW_hilo, pieceH: pieceH_contrahilo, orientation: 'Hilo Horizontal' };
                        const grainVerticalLayout = { ...grainVerticalLayoutCalc, pieceW: pieceH_contrahilo, pieceH: pieceW_hilo, orientation: 'Hilo Vertical' };

                        let layoutsToTry = [];
                        switch (inputs.acomodo) {
                            case 'horizontal':
                                layoutsToTry.push(grainHorizontalLayout);
                                break;
                            case 'vertical':
                                layoutsToTry.push(grainVerticalLayout);
                                break;
                            case 'optimo':
                            default:
                                if (grainHorizontalLayout.cuts >= grainVerticalLayout.cuts) {
                                    layoutsToTry.push(grainHorizontalLayout);
                                    if (grainVerticalLayout.cuts === grainHorizontalLayout.cuts && grainVerticalLayout.cuts > 0) {
                                        layoutsToTry.push(grainVerticalLayout);
                                    }
                                } else {
                                    layoutsToTry.push(grainVerticalLayout);
                                }
                                break;
                        }

                        const bestInitialLayout = layoutsToTry[0];
                        if (!bestInitialLayout || bestInitialLayout.cuts === 0) return null;

                        let availableDieCutters = [];
                        if (inputs.material === 'microcorrugado') {
                            availableDieCutters = PROCESS_MACHINES.DIE_CUTTERS.filter(m => m.name === 'Vision-160');
                        } else {
                            availableDieCutters = PROCESS_MACHINES.DIE_CUTTERS.filter(m => m.name !== 'Vision-160');
                        }

                        let finalValidResult = null;
                        const isSheetValidForPrinter = (w, h, p) => (w >= (p.minWidth || 0) && w <= p.maxWidth && h >= (p.minHeight || 0) && h <= p.maxHeight);

                        outerLoop:
                        for (let cuts = bestInitialLayout.cuts; cuts > 0; cuts--) {
                            const factors = [];
                            for (let i = 1; i <= Math.sqrt(cuts); i++) {
                                if (cuts % i === 0) {
                                    factors.push([i, cuts / i]);
                                    if (i * i !== cuts) {
                                        factors.push([cuts / i, i]);
                                    }
                                }
                            }

                            for (const [cols, rows] of factors) {
                                for (const layoutTemplate of layoutsToTry) {
                                    const currentLayout = { ...layoutTemplate, cols, rows, cuts };
                                    const check = this.findCompatibleDieCutter(currentLayout, availableDieCutters, gutter, sideMargins, topGripper, bottomGripper);

                                    if (check.compatibleDieCutter && isSheetValidForPrinter(check.suggestedSheetW, check.suggestedSheetH, printer)) {
                                        const aprovechamiento = (check.suggestedSheetW * check.suggestedSheetH > 0) ? ((check.usedAreaW * check.usedAreaH) / (check.suggestedSheetW * check.suggestedSheetH)) * 100 : 0;

                                        let result = {
                                            name: printer.name,
                                            cuts: currentLayout.cuts,
                                            aprovechamiento,
                                            orientation: currentLayout.orientation,
                                            associatedDieCutter: check.compatibleDieCutter.name,
                                            drawing: {
                                                sheetW: printer.maxWidth, sheetH: printer.maxHeight, sideMargins, topGripper, bottomGripper,
                                                cols: currentLayout.cols, rows: currentLayout.rows, gutter,
                                                pieceW: currentLayout.pieceW, pieceH: currentLayout.pieceH,
                                                usedAreaW: check.usedAreaW, usedAreaH: check.usedAreaH,
                                                suggestedSheetW: check.suggestedSheetW, suggestedSheetH: check.suggestedSheetH,
                                                unit: inputs.unit
                                            }
                                        };
                                        finalValidResult = this.calculateWeightAndArea(result, inputs);

                                        if (finalValidResult.cuts < bestInitialLayout.cuts) {
                                            analysisNotes.push(`Para ${printer.name}, el acomodo ideal de ${bestInitialLayout.cuts} piezas era incompatible con las m√°quinas. El m√°ximo acomodo compatible es de ${finalValidResult.cuts} piezas.`);
                                        }

                                        break outerLoop;
                                    }
                                }
                            }
                        }
                        return finalValidResult;
                    }).filter(Boolean);

                    // Remove duplicate notes
                    const uniqueNotes = [...new Set(analysisNotes)];

                    allPrinterResults.sort((a, b) => b.cuts - a.cuts || a.drawing.suggestedSheetW * a.drawing.suggestedSheetH - b.drawing.suggestedSheetW * b.drawing.suggestedSheetH);
                    const bestOption = allPrinterResults.length > 0 ? allPrinterResults[0] : null;
                    const processRoute = this.generateProcessRoute(bestOption, inputs);
                    return { isCustom: false, rankedMachines: allPrinterResults, processRoute, userInputs: inputs, analysisNotes: uniqueNotes };
                },
                findCompatibleDieCutter(layout, availableDieCutters, gutter, sideMargins, topGripper, bottomGripper) {
                    const pieceForDrawingW = layout.pieceW;
                    const pieceForDrawingH = layout.pieceH;
                    const usedAreaW = (layout.cols * pieceForDrawingW) + (Math.max(0, layout.cols - 1) * gutter);
                    // FIX: Corregido 'rows' a 'layout.rows' (Error de alcance de variable)
                    const usedAreaH = (layout.rows * pieceForDrawingH) + (Math.max(0, layout.rows - 1) * gutter);
                    const suggestedSheetW = usedAreaW + (sideMargins * 2);
                    const suggestedSheetH = usedAreaH + topGripper + bottomGripper;
                    const compatibleDieCutters = availableDieCutters.filter(dc => (dc.maxWidth >= suggestedSheetW && dc.maxHeight >= suggestedSheetH) || (dc.maxWidth >= suggestedSheetH && dc.maxHeight >= suggestedSheetW));
                    if (compatibleDieCutters.length === 0) return { compatibleDieCutter: null };
                    compatibleDieCutters.sort((a, b) => (a.maxWidth * a.maxHeight) - (b.maxWidth * b.maxHeight));
                    return { compatibleDieCutter: compatibleDieCutters[0], suggestedSheetW, suggestedSheetH, usedAreaW, usedAreaH };
                },
                generateProcessRoute(bestOption, inputs) {
                    if (!bestOption) return [];
                    let route = [];
                    route.push({ process: 'Impresi√≥n', machine: bestOption.name });
                    if (inputs.material === 'microcorrugado') {
                        route.push({ process: 'Laminado', machine: PROCESS_MACHINES.LAMINATORS[0].name });
                    }
                    route.push({ process: 'Troquelado', machine: bestOption.associatedDieCutter || 'Ninguna compatible' });
                    if (inputs.gluing) {
                        route.push({ process: 'Pegado', machine: inputs.gluingMachine });
                    }
                    return route;
                },
                calculateLayout(sheetW, sheetH, pieceW, pieceH, gutter) {
                    const count = (s, p, g) => (p <= 0 || s < p) ? 0 : Math.floor((s + g) / (p + g));
                    return { cuts: count(sheetW, pieceW, gutter) * count(sheetH, pieceH, gutter), cols: count(sheetW, pieceW, gutter), rows: count(sheetH, pieceH, gutter) };
                },
                getValidatedInputs() {
                    const values = {};
                    let allValid = true;
                    for (const key in DOM.inputs) {
                        const inputEl = DOM.inputs[key];
                        if (!inputEl) continue;
                        // Skip validation for hidden elements if they are not checkboxes
                        if (inputEl.offsetParent === null && inputEl.type !== 'checkbox') continue;

                        if (inputEl.type === 'checkbox') {
                            values[key] = inputEl.checked;
                        } else if (inputEl.tagName.toLowerCase() === 'input' && inputEl.type === 'text') { // Updated to check text inputs for numbers
                            let value = parseFloat(inputEl.value);
                            if ((inputEl.required && (isNaN(value) || inputEl.value.trim() === '')) || value < 0) {
                                allValid = false;
                                inputEl.classList.add('invalid-input');
                            } else {
                                inputEl.classList.remove('invalid-input');
                            }
                            values[key] = value;
                        } else {
                            values[key] = inputEl.value;
                        }
                    }
                    return allValid ? values : null;
                },

                getPalletizeResults(resultsData, pattern = 'recto') {
                    if (!resultsData) return null;

                    const inputs = resultsData.userInputs;
                    const bestResult = resultsData.isCustom ? resultsData : (resultsData.rankedMachines?.[0] || null);
                    if (!bestResult) return null;

                    const bestBox = bestResult?.collectiveBoxData?.best;
                    const useCollectiveBoxLogic = inputs.gluing && inputs.useCollectiveBox && bestBox;

                    let palletPieceW, palletPieceH, itemHeight, itemsPerUnit, totalPieces;
                    let palletizingMode, itemsPerLayerLabel, bundleInfo = null;
                    let layersPerPallet;

                    const isBundledMicro = inputs.material === 'microcorrugado';

                    if (useCollectiveBoxLogic) {
                        palletizingMode = `Cajas (${bestBox.material})`;
                        itemsPerLayerLabel = 'Cajas / Cama';
                        palletPieceW = bestBox.largo;
                        palletPieceH = bestBox.ancho;
                        itemHeight = bestBox.alto;
                        itemsPerUnit = bestBox.capacity;
                    } else if (isBundledMicro) {
                        const pieceThickness = PALLETIZING_SETTINGS.MATERIAL_THICKNESS.FLUTES[inputs.flute] || 0;
                        palletPieceW = toMM(inputs.cutWidth, inputs.unit);
                        palletPieceH = toMM(inputs.cutHeight, inputs.unit);

                        let bundleSize;
                        if (inputs.gluing) { // Pegado = Atado Doble
                            const bundleSizes = { 'Flauta E': 100, 'Flauta B': 60, 'Flauta C': 50 };
                            bundleSize = bundleSizes[inputs.flute] || 2;
                            palletizingMode = 'Atados (Pegado)';
                        } else { // Sin Pegado = Atado Sencillo
                            const bundleSizes = { 'Flauta E': 50, 'Flauta B': 30, 'Flauta C': 25 };
                            bundleSize = bundleSizes[inputs.flute] || 1;
                            palletizingMode = 'Atados (Sin Pegar)';
                        }

                        itemsPerLayerLabel = 'Atados / Cama';
                        itemHeight = pieceThickness * bundleSize;
                        itemsPerUnit = bundleSize;
                        bundleInfo = `${bundleSize} pzs/atado`;

                    } else { // Plegadizo y otros casos sin atado
                        palletizingMode = 'Piezas Individuales';
                        itemsPerLayerLabel = 'Piezas / Cama';
                        const originalPieceW = toMM(inputs.cutWidth, inputs.unit);
                        const originalPieceH = toMM(inputs.cutHeight, inputs.unit);

                        palletPieceW = originalPieceW;
                        palletPieceH = originalPieceH;

                        let nominalThickness = 0;
                        const isAutomaticBottom = inputs.isAutomaticBottom;

                        if (inputs.material === 'microcorrugado') {
                            nominalThickness = PALLETIZING_SETTINGS.MATERIAL_THICKNESS.FLUTES[inputs.flute] || 0;
                        } else {
                            nominalThickness = (inputs.foldingCartonWeight || 0) * PALLETIZING_SETTINGS.MATERIAL_THICKNESS.POINTS_TO_MM;
                        }

                        if (inputs.gluing && inputs.glueFlapWidth > 0) {
                            const glueFlapW_mm = toMM(inputs.glueFlapWidth, inputs.unit);
                            if (originalPieceH >= originalPieceW) {
                                palletPieceH = (originalPieceH - glueFlapW_mm) / 2;
                            } else {
                                palletPieceW = (originalPieceW - glueFlapW_mm) / 2;
                            }

                            if (isAutomaticBottom) {
                                // Fondo Autom√°tico: 5 capas nominales + Compensaci√≥n Fija
                                const layers = 5;
                                const compensation = GENERAL_SETTINGS.automaticBottomCompensation || 0;
                                itemHeight = (nominalThickness * layers) + compensation;
                            } else {
                                // Pegado Lineal: 2 capas nominales + 50% de holgura
                                const layers = 2;
                                const holgura = nominalThickness * 0.5;
                                itemHeight = (nominalThickness * layers) + holgura;
                            }
                        } else {
                            itemHeight = nominalThickness; // Pieza individual sin doblar
                        }

                        itemsPerUnit = 1;
                    }

                    if (itemHeight <= 0) return null;

                    const pallet = PALLETIZING_SETTINGS.pallets[0];
                    const palletW = pallet.widthIn * 25.4;
                    const palletH = pallet.heightIn * 25.4;

                    const maxTotalHeightMm = PALLETIZING_SETTINGS.maxTotalHeightCm * 10;
                    const palletBaseHeightMm = PALLETIZING_SETTINGS.standardPalletHeightCm * 10;
                    const usableStackHeightMm = maxTotalHeightMm - palletBaseHeightMm;

                    if (usableStackHeightMm <= 0) return null;

                    let itemsPerLayer = 0;
                    if (pattern === 'recto') {
                        const layout1 = Math.floor(palletW / palletPieceW) * Math.floor(palletH / palletPieceH);
                        const layout2 = Math.floor(palletW / palletPieceH) * Math.floor(palletH / palletPieceW);
                        itemsPerLayer = Math.max(layout1, layout2);
                    } else { // columnar
                        itemsPerLayer = Math.max(
                            calculateColumnarFit(palletW, palletH, palletPieceW, palletPieceH),
                            calculateColumnarFit(palletH, palletW, palletPieceW, palletPieceH)
                        );
                    }

                    let materialHeightMm;

                    if (inputs.material === 'plegadizo' && inputs.usePlegadizoBundles && itemHeight > 0) {
                        palletizingMode = 'Atados (Plegadizo)';
                        itemsPerLayerLabel = 'Piezas / Cama';

                        const regularBundleHeight = 200; // 20cm
                        const minLastBundleHeight = 150; // 15cm
                        const minRecalcHeight = 180;     // 18cm

                        const numRegularBundles = Math.floor(usableStackHeightMm / regularBundleHeight);
                        const lastBundleHeight = usableStackHeightMm % regularBundleHeight;

                        if (lastBundleHeight > 0 && lastBundleHeight < minLastBundleHeight) {
                            let totalBundlesToCreate = numRegularBundles > 0 ? numRegularBundles : 1;
                            let newHeight = usableStackHeightMm / totalBundlesToCreate;
                            if (newHeight < minRecalcHeight && totalBundlesToCreate > 1) {
                                totalBundlesToCreate--;
                            }
                            bundleInfo = `${totalBundlesToCreate} atado(s) de ${(usableStackHeightMm / totalBundlesToCreate / 10).toFixed(1)} cm`;
                            layersPerPallet = totalBundlesToCreate;
                        } else {
                            layersPerPallet = numRegularBundles + (lastBundleHeight > 0 ? 1 : 0);
                            if (layersPerPallet === 0 && usableStackHeightMm > 0) layersPerPallet = 1;

                            if (numRegularBundles > 0 && lastBundleHeight > 0) {
                                bundleInfo = `${numRegularBundles} atado(s) de 20.0 cm y 1 atado de ${(lastBundleHeight / 10).toFixed(1)} cm`;
                            } else if (numRegularBundles > 0) {
                                bundleInfo = `${numRegularBundles} atado(s) de 20.0 cm`;
                            } else if (usableStackHeightMm > 0) {
                                bundleInfo = `1 atado de ${(usableStackHeightMm / 10).toFixed(1)} cm`;
                            }
                        }

                        const totalStackablePieces = Math.floor(usableStackHeightMm / itemHeight);
                        totalPieces = totalStackablePieces * itemsPerLayer;
                        materialHeightMm = usableStackHeightMm;

                    } else {
                        layersPerPallet = Math.floor(usableStackHeightMm / itemHeight);
                        totalPieces = (itemsPerLayer * layersPerPallet) * itemsPerUnit;
                        materialHeightMm = layersPerPallet * itemHeight;
                    }

                    if (itemsPerLayer === 0 || (layersPerPallet <= 0 && !(inputs.material === 'plegadizo' && inputs.usePlegadizoBundles))) return null;

                    return {
                        palletName: pallet.name,
                        piecesPerLayer: itemsPerLayer,
                        layersPerPallet,
                        totalPieces,
                        materialHeightCm: materialHeightMm / 10,
                        finalHeightCm: (materialHeightMm + palletBaseHeightMm) / 10,
                        mode: palletizingMode,
                        itemsPerLayerLabel,
                        palletW_mm: palletW,
                        palletH_mm: palletH,
                        itemW_mm: palletPieceW,
                        itemH_mm: palletPieceH,
                        bundleInfo: bundleInfo
                    };
                },
            };

            // --- M√ìDULO DE INTERFAZ DE USUARIO (UI) ---

            const UI = {
                updateResults(data) {
                    if (!data) return;
                    state.lastValidResults = data;

                    DOM.modal.folioInput.value = '';
                    DOM.modal.clienteInput.value = '';
                    DOM.modal.folioInput.classList.remove('invalid-input');

                    if (data.isCustom) {
                        this.updateCustomResults(data);
                        this.updateAnalysisNotes([]); // No notes for custom mode
                    } else {
                        this.updateOptimalResults(data);
                        this.updateAnalysisNotes(data.analysisNotes);
                    }
                    this.showModal();
                },

                updateOptimalResults(data) {
                    DOM.modal.resultsTitle.textContent = "Resultados de Optimizaci√≥n";
                    DOM.modal.rankingTitle.textContent = "Ranking de Impresoras";
                    this.updateRankingList(data.rankedMachines);
                    if (data.rankedMachines.length > 0) {
                        this.updatePreview(0);
                    } else {
                        this.updateProcessRoute([]);
                        this.clearPreview();
                    }
                },

                updateCustomResults(data) {
                    DOM.modal.resultsTitle.textContent = "Resultado en Pliego Manual";
                    DOM.modal.rankingTitle.textContent = "M√°quinas Compatibles";
                    DOM.modal.processRouteContainer.innerHTML = '';

                    if (data.cuts > 0) {
                        const sheetW = data.drawing.sheetW;
                        const sheetH = data.drawing.sheetH;
                        let rollWidthMm;
                        if (data.orientation === 'Hilo Vertical') {
                            rollWidthMm = sheetW;
                        } else { // Hilo Horizontal
                            rollWidthMm = sheetH;
                        }
                        const rollWidthIn = rollWidthMm / 25.4;

                        DOM.modal.rankingContainer.innerHTML = `
                    <div class="p-4 bg-white rounded-lg border-l-4 border-green-500">
                        <p class="text-3xl font-bold text-blue-600 text-center">${data.cuts} <span class="text-xl font-medium text-gray-700">cortes</span></p>
                        <p class="text-center text-sm text-gray-600 mt-1">En pliego de ${sheetW.toFixed(1)} x ${sheetH.toFixed(1)} ${data.drawing.unit}</p>
                        <p class="text-center text-sm text-gray-600 mt-1">Ancho de Rollo: <b>${rollWidthIn.toFixed(2)}"</b></p>
                    </div>
                    <div class="mt-4">
                        <p class="font-semibold text-gray-800 mb-1">Impresoras Compatibles:</p>
                        <p class="text-sm text-gray-600">${data.compatiblePrinters.length > 0 ? data.compatiblePrinters.join(', ') : 'Ninguna'}</p>
                    </div>
                     <div class="mt-2">
                        <p class="font-semibold text-gray-800 mb-1">Troqueladoras Compatibles:</p>
                        <p class="text-sm text-gray-600">${data.compatibleDieCutters.length > 0 ? data.compatibleDieCutters.join(', ') : 'Ninguna'}</p>
                    </div>
                `;
                        this.updatePreview(); // Llama sin √≠ndice para modo manual
                    } else {
                        DOM.modal.rankingContainer.innerHTML = `<div class="p-4 text-center text-gray-500 bg-white rounded-lg">No caben piezas en el pliego especificado.</div>`;
                        this.clearPreview();
                    }
                },

                updateAnalysisNotes(notes) {
                    const container = DOM.modal.analysisNotesContainer;
                    const content = DOM.modal.analysisNotesContent;

                    if (notes && notes.length > 0) {
                        content.innerHTML = notes.map(note => `<p class="leading-relaxed">- ${note}</p>`).join('');
                        container.classList.remove('hidden');
                    } else {
                        content.innerHTML = '';
                        container.classList.add('hidden');
                    }
                },

                clearPreview() {
                    DOM.canvas.ctx.clearRect(0, 0, DOM.canvas.el.width, DOM.canvas.el.height);
                    DOM.modal.previewTitle.textContent = 'Sin vista previa';
                    DOM.modal.previewDetails.innerHTML = '';
                    DOM.modal.previewLegend.innerHTML = '';
                },

                displaySavedCalculation(entry) {
                    if (!entry || !entry.results) return;
                    Object.keys(entry.results.userInputs).forEach(key => {
                        if (DOM.inputs[key]) {
                            const inputEl = DOM.inputs[key];
                            const savedValue = entry.results.userInputs[key];
                            if (inputEl.type === 'checkbox') inputEl.checked = savedValue;
                            else inputEl.value = savedValue;
                        }
                    });
                    handleMaterialChange();
                    DOM.inputs.calculationModeToggle.dispatchEvent(new Event('change'));
                    DOM.inputs.gluing.dispatchEvent(new Event('change'));
                    DOM.inputs.ectCheckbox.dispatchEvent(new Event('change'));
                    DOM.inputs.isAutomaticBottom.dispatchEvent(new Event('change')); // <-- NUEVO

                    this.updateResults(entry.results);

                    DOM.modal.folioInput.value = entry.folio;
                    DOM.modal.clienteInput.value = entry.cliente;
                    DOM.modal.folioInput.classList.remove('invalid-input');

                    this.hideHistoryModal();
                },
                updateRankingList(rankedMachines) {
                    if (rankedMachines.length === 0) { DOM.modal.rankingContainer.innerHTML = `<div class="p-4 text-center text-gray-500 bg-white rounded-lg">No hay combinaciones de impresora/troqueladora compatibles.</div>`; return; }
                    DOM.modal.rankingContainer.innerHTML = rankedMachines.map((machine, index) => {
                        const isBest = index === 0;
                        // Usa una clase dedicada para la mejor opci√≥n para estilos especiales
                        const extraClass = isBest ? 'recommended-machine' : '';
                        // Usa un √≠cono de estrella o el n√∫mero de ranking
                        const trophyIcon = isBest ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>` : `<span class="font-bold text-lg text-gray-400 w-6 text-center">${index + 1}.</span>`;

                        const sheetW = machine.drawing.suggestedSheetW;
                        const sheetH = machine.drawing.suggestedSheetH;
                        let rollWidthMm;
                        if (machine.orientation === 'Hilo Vertical') {
                            rollWidthMm = sheetW;
                        } else { // Hilo Horizontal
                            rollWidthMm = sheetH;
                        }
                        const rollWidthIn = rollWidthMm / 25.4;

                        // Se agrega la clase extra y el badge de "Recomendada"
                        return `<div data-machine-index="${index}" class="p-4 bg-white rounded-lg border-l-4 rank-${(index % 4) + 1} transition-all duration-200 hover:shadow-xl cursor-pointer ${extraClass}"><div class="flex items-center gap-4"><div class="flex-shrink-0">${trophyIcon}</div><div class="flex-grow"><p class="font-bold text-lg text-gray-800 flex items-center gap-2">${machine.name} ${isBest ? '<span class="text-xs font-semibold bg-green-500 text-white px-2 py-0.5 rounded-full uppercase tracking-wider">Recomendada</span>' : ''}</p><div class="text-xs text-gray-500 mt-1"><span>Troqueladora: ${machine.associatedDieCutter}</span></div></div><div class="text-right flex-shrink-0 ml-auto"><p class="font-extrabold text-3xl text-blue-600">${machine.cuts}</p><p class="text-sm font-medium text-gray-600 -mt-1">cortes</p></div></div><div class="mt-3 space-y-2"><div class="text-xs"><div class="flex justify-between items-center mb-1"><span class="font-semibold text-gray-600">Aprov. √Årea √ötil</span><span class="font-bold text-indigo-600">${machine.aprovechamiento.toFixed(1)}%</span></div><div class="w-full bg-gray-200 rounded-full h-1.5"><div class="bg-indigo-500 h-1.5 rounded-full" style="width: ${machine.aprovechamiento}%"></div></div></div><div class="text-xs text-gray-600 bg-indigo-50 p-2 rounded space-y-1"><div><span class="font-bold text-indigo-800">Pliego Sugerido:</span> ${sheetW.toFixed(1)} x ${sheetH.toFixed(1)} ${machine.drawing.unit}</div><div><span class="font-bold text-indigo-800">Ancho de Rollo:</span> ${rollWidthIn.toFixed(2)}"</div></div></div></div>`;
                    }).join('');
                },
                updateProcessRoute(route) {
                    if (!route || route.length === 0) {
                        DOM.modal.processRouteContainer.innerHTML = '<p class="text-sm text-center text-gray-500">No se pudo generar una ruta.</p>';
                        return;
                    }
                    DOM.modal.processRouteContainer.innerHTML = route.map((step, index) => `<div class="flex items-center text-sm"><span class="flex-shrink-0 h-6 w-6 bg-indigo-500 text-white font-bold rounded-full flex items-center justify-center text-xs">${index + 1}</span><span class="ml-3 font-semibold text-gray-600">${step.process}:</span><span class="ml-auto font-medium text-gray-800">${step.machine}</span></div>`).join('');
                },
                updatePreview(index) {
                    const selectedData = index !== undefined ? state.lastValidResults.rankedMachines[index] : state.lastValidResults;
                    if (!selectedData) return;

                    if (state.lastValidResults && !state.lastValidResults.isCustom) {
                        const newProcessRoute = Calculator.generateProcessRoute(selectedData, state.lastValidResults.userInputs);
                        this.updateProcessRoute(newProcessRoute);
                        DOM.modal.rankingContainer.querySelectorAll('[data-machine-index]').forEach(el => el.classList.remove('selected-machine'));
                        DOM.modal.rankingContainer.querySelector(`[data-machine-index="${index}"]`)?.classList.add('selected-machine');
                    }

                    const weightContainer = DOM.modal.weightResultsContainer;
                    if (selectedData.sheetAreaM2 && selectedData.sheetGrossWeightKg && selectedData.pieceGrossWeightKg) {
                        weightContainer.innerHTML = `
                    <h3 class="font-semibold text-gray-800 mb-2">Detalles de Peso y √Årea</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-center text-sm">
                        <div class="bg-gray-100 p-2 rounded-lg">
                            <p class="font-medium text-gray-600">√Årea Pliego</p>
                            <p class="font-bold text-gray-800">${selectedData.sheetAreaM2.toFixed(4)} m¬≤</p>
                        </div>
                        <div class="bg-gray-100 p-2 rounded-lg">
                            <p class="font-medium text-gray-600">Peso Pliego (Bruto)</p>
                            <p class="font-bold text-gray-800">${selectedData.sheetGrossWeightKg.toFixed(4)} kg</p>
                        </div>
                        <div class="bg-indigo-100 p-2 rounded-lg">
                            <p class="font-medium text-indigo-800">Peso Pieza (Bruto)</p>
                            <p class="font-bold text-indigo-600">${selectedData.pieceGrossWeightKg.toFixed(4)} kg</p>
                        </div>
                    </div>
                `;
                        weightContainer.classList.remove('hidden');
                    } else {
                        weightContainer.innerHTML = '';
                        weightContainer.classList.add('hidden');
                    }

                    const boxContainer = DOM.modal.collectiveBoxContainer;
                    if (selectedData.collectiveBoxData && selectedData.collectiveBoxData.best) {
                        const bestBox = selectedData.collectiveBoxData.best;

                        // Extraer los pesos
                        const { emptyBoxWeightKg, piecesNetWeightKg, totalGrossWeightKg } = bestBox.weightData;

                        boxContainer.innerHTML = `
                    <h3 class="font-semibold text-gray-800 mb-2">Caja Colectiva Sugerida</h3>
                    <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-green-800">${bestBox.material}</p>
                                <p class="text-xs text-gray-600">${bestBox.largo} x ${bestBox.ancho} x ${bestBox.alto} mm</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-green-600">${bestBox.capacity}</p>
                                <p class="text-xs text-gray-600 -mt-1">piezas/caja</p>
                            </div>
                        </div>
                        
                        <!-- DETALLES DE PESO DE LA CAJA COLECTIVA -->
                        <div class="grid grid-cols-3 gap-2 mt-3 text-center text-xs">
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <p class="font-medium text-gray-600">Peso Caja Vac√≠a</p>
                                <p class="font-bold text-gray-800">${emptyBoxWeightKg.toFixed(3)} kg</p>
                            </div>
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <p class="font-medium text-gray-600">Peso Piezas Neto</p>
                                <p class="font-bold text-gray-800">${piecesNetWeightKg.toFixed(3)} kg</p>
                            </div>
                            <div class="bg-indigo-100 p-2 rounded-lg border-indigo-200">
                                <p class="font-medium text-indigo-800">Peso Total Bruto</p>
                                <p class="font-bold text-indigo-600">${totalGrossWeightKg.toFixed(3)} kg</p>
                            </div>
                        </div>
                        <!-- FIN DETALLES -->

                        <div class="mt-2">
                            <canvas id="collectiveBoxCanvas" class="w-full h-auto bg-white border border-gray-200 rounded-md mx-auto" width="400" height="300"></canvas>
                        </div>
                        <button id="viewOtherBoxesBtn" class="text-sm text-indigo-600 hover:underline mt-2 w-full text-right">Ver otras opciones</button>
                    </div>
                `;
                        boxContainer.classList.remove('hidden');

                        const collectiveBoxCanvas = document.getElementById('collectiveBoxCanvas');
                        const collectiveBoxCtx = collectiveBoxCanvas.getContext('2d');
                        this.drawCollectiveBoxLayout(collectiveBoxCtx, bestBox, selectedData.collectiveBoxData.foldedPiece);

                        document.getElementById('viewOtherBoxesBtn').addEventListener('click', () => this.showBoxOptionsModal(selectedData.collectiveBoxData.all));
                    } else {
                        boxContainer.innerHTML = '';
                        boxContainer.classList.add('hidden');
                    }

                    DOM.modal.previewTitle.textContent = `Vista Previa (${selectedData.name || 'Pliego Manual'})`;
                    const drawingData = selectedData.drawing;
                    const inputs = state.lastValidResults.userInputs;
                    let materialDetailHtml = (inputs.material === 'microcorrugado')
                        ? `<div class="bg-gray-100 p-2 rounded"><p class="font-bold">Flauta</p><p>${inputs.flute}</p></div>`
                        : `<div class="bg-gray-100 p-2 rounded"><p class="font-bold">Gramaje</p><p>${inputs.foldingCartonWeight} Puntos</p></div>`;
                    DOM.modal.previewDetails.innerHTML = `<div class="grid grid-cols-2 gap-2 text-xs text-gray-700"><div class="bg-gray-100 p-2 rounded"><p class="font-bold">Pliego</p><p>${drawingData.suggestedSheetW.toFixed(1)} x ${drawingData.suggestedSheetH.toFixed(1)} ${drawingData.unit}</p></div>${materialDetailHtml}<div class="bg-gray-100 p-2 rounded"><p class="font-bold">Medianil</p><p>${inputs.gutter.toFixed(1)} ${drawingData.unit}</p></div><div class="bg-gray-100 p-2 rounded"><p class="font-bold">Pinzas (Sup/Inf)</p><p>${inputs.topGripper.toFixed(1)} / ${inputs.bottomGripper.toFixed(1)} ${drawingData.unit}</p></div></div>`;
                    DOM.modal.previewLegend.innerHTML = `<div class="flex justify-center items-center gap-4"><div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-sm bg-green-500/40"></div><span>√Årea de Corte</span></div><div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-sm bg-gray-500/30"></div><span>M√°rgenes / Pinzas</span></div></div>`;
                    this.drawCanvasLayout(DOM.canvas.ctx, selectedData.drawing);
                },
                showModal() {
                    DOM.modal.overlay.classList.remove('hidden');
                    void DOM.modal.container.offsetWidth;
                    DOM.modal.container.classList.remove('scale-95', 'opacity-0');
                },
                hideModal() {
                    DOM.modal.container.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => DOM.modal.overlay.classList.add('hidden'), 300);
                },
                reset() {
                    DOM.form.reset();
                    Object.values(DOM.inputs).forEach(input => {
                        if (input.tagName.toLowerCase() === 'input') input.classList.remove('invalid-input');
                    });
                    handleMaterialChange();
                    DOM.inputs.calculationModeToggle.checked = false;
                    DOM.inputs.calculationModeToggle.dispatchEvent(new Event('change'));
                    DOM.inputs.gluing.checked = false;
                    DOM.inputs.gluing.dispatchEvent(new Event('change'));
                    DOM.inputs.usePlegadizoBundles.checked = false;
                    DOM.inputs.isAutomaticBottom.checked = false; // <-- NUEVO
                    DOM.ectValueContainer.classList.add('hidden');
                    state.lastValidResults = null;
                    this.hideModal();
                },
                drawDimensionLine(ctx, x1, y1, x2, y2, text, isVertical) {
                    const tickSize = 6;
                    const textOffset = 18;
                    ctx.save();
                    ctx.beginPath();
                    ctx.strokeStyle = '#374151';
                    ctx.fillStyle = '#374151';
                    ctx.lineWidth = 1;
                    ctx.font = '14px Inter';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    if (isVertical) {
                        ctx.moveTo(x1 - tickSize, y1); ctx.lineTo(x1 + tickSize, y1);
                        ctx.moveTo(x2 - tickSize, y2); ctx.lineTo(x2 + tickSize, y2);
                        ctx.stroke();
                        const midX = x1 - textOffset;
                        const midY = (y1 + y2) / 2;
                        ctx.translate(midX, midY);
                        ctx.rotate(-Math.PI / 2);
                        ctx.fillText(text, 0, 0);
                    } else {
                        ctx.moveTo(x1, y1 - tickSize); ctx.lineTo(x1, y1 + tickSize);
                        ctx.moveTo(x2, y2 - tickSize); ctx.lineTo(x2, y2 + tickSize);
                        ctx.stroke();
                        const midX = (x1 + x2) / 2;
                        const midY = y1 - textOffset;
                        ctx.fillText(text, midX, midY);
                    }
                    ctx.restore();
                },
                drawCanvasLayout(ctx, data) {
                    const { el } = DOM.canvas;
                    ctx.clearRect(0, 0, el.width, el.height);
                    const p = 90;
                    const maxW = el.width - 2 * p;
                    const maxH = el.height - 2 * p;
                    const { sheetW, sheetH, sideMargins, topGripper, bottomGripper, cols, rows, gutter, pieceW, pieceH, usedAreaW, usedAreaH, unit } = data;
                    const r = sheetW / sheetH;
                    let dW, dH;
                    if (r > maxW / maxH) {
                        dW = maxW;
                        dH = maxW / r;
                    } else {
                        dH = maxH;
                        dW = maxH * r;
                    }
                    const sX = (el.width - dW) / 2;
                    const sY = (el.height - dH) / 2;
                    ctx.fillStyle = 'rgba(239, 246, 255, 1)';
                    ctx.fillRect(sX, sY, dW, dH);
                    ctx.strokeStyle = 'rgba(200, 200, 200, 0.8)';
                    ctx.strokeRect(sX, sY, dW, dH);
                    const tGDH = (topGripper / sheetH) * dH;
                    const bGDH = (bottomGripper / sheetH) * dH;
                    const sMDW = (sideMargins / sheetW) * dW;
                    ctx.fillStyle = 'rgba(107, 114, 128, 0.3)';
                    ctx.fillRect(sX, sY, dW, tGDH);
                    ctx.fillRect(sX, sY + dH - bGDH, dW, bGDH);
                    ctx.fillRect(sX, sY, sMDW, dH);
                    ctx.fillRect(sX + dW - sMDW, sY, sMDW, dH);
                    const cDX_b = sX + sMDW;
                    const cDW = dW - (sMDW * 2);
                    const cDY_b = sY + tGDH;
                    const cDH = dH - tGDH - bGDH;
                    if (cols > 0 && rows > 0 && cDW > 0 && cDH > 0) {
                        const tGW = (cols - 1) * gutter;
                        const tGH = (rows - 1) * gutter;
                        const tPW = cols * pieceW;
                        const tPH = rows * pieceH;
                        const sR = Math.min(cDW / (tPW + tGW), cDH / (tPH + tGH));
                        const pDW = pieceW * sR;
                        const pDH = pieceH * sR;
                        const gDW = gutter * sR;
                        const gDH = gutter * sR;
                        const uADW = (cols * pDW) + (Math.max(0, cols - 1) * gDW);
                        const uADH = (rows * pDH) + (Math.max(0, rows - 1) * gDH);
                        const oX = (cDW - uADW) / 2;
                        const oY = (cDH - uADH) / 2;
                        const cDX = cDX_b + oX;
                        const cDY = cDY_b + oY;
                        ctx.fillStyle = 'rgba(16, 185, 129, 0.4)';
                        ctx.strokeStyle = 'rgba(5, 150, 105, 0.6)';
                        ctx.lineWidth = 1;
                        for (let i = 0; i < cols; i++) {
                            for (let j = 0; j < rows; j++) {
                                const x = cDX + i * (pDW + gDW);
                                const y = cDY + j * (pDH + gDH);
                                ctx.fillRect(x, y, pDW, pDH);
                                if (pDW > 1 && pDH > 1) {
                                    ctx.strokeRect(x + 0.5, y + 0.5, pDW - 1, pDH - 1);
                                } else {
                                    ctx.strokeRect(x, y, pDW, pDH);
                                }
                            }
                        }
                        const iDO = 35;
                        const oDO = 65;
                        this.drawDimensionLine(ctx, cDX, cDY - iDO, cDX + uADW, cDY - iDO, `${usedAreaW.toFixed(1)} ${unit}`, !1);
                        this.drawDimensionLine(ctx, cDX - iDO, cDY, cDX - iDO, cDY + uADH, `${usedAreaH.toFixed(1)} ${unit}`, !0);
                        if (topGripper > 0) this.drawDimensionLine(ctx, sX + dW + oDO, sY, sX + dW + oDO, sY + tGDH, `${topGripper.toFixed(1)} ${unit}`, !0);
                        if (bottomGripper > 0) this.drawDimensionLine(ctx, sX + dW + oDO, sY + dH - bGDH, sX + dW + oDO, sY + dH, `${bottomGripper.toFixed(1)} ${unit}`, !0);
                        if (sideMargins > 0) {
                            this.drawDimensionLine(ctx, sX, sY + dH + oDO, sX + sMDW, sY + dH + oDO, `${sideMargins.toFixed(1)} ${unit}`, !1);
                            this.drawDimensionLine(ctx, sX + dW - sMDW, sY + dH + oDO, sX + dW, sY + dH + oDO, `${sideMargins.toFixed(1)} ${unit}`, !1);
                        }
                    }
                },
                drawPalletLayout(palletW, palletH, pieceW, pieceH, targetCanvas, targetCtx) {
                    const canvas = targetCanvas || DOM.palletize.palletCanvas;
                    const ctx = targetCtx || DOM.palletize.palletCtx;

                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    if (!palletW || !palletH) return;

                    let bestLayout = { count: 0 };
                    if (pieceW > 0 && pieceH > 0) {
                        const layout1 = {
                            cols: Math.floor(palletW / pieceW),
                            rows: Math.floor(palletH / pieceH),
                            pieceW: pieceW,
                            pieceH: pieceH
                        };
                        layout1.count = layout1.cols * layout1.rows;

                        const layout2 = {
                            cols: Math.floor(palletW / pieceH),
                            rows: Math.floor(palletH / pieceW),
                            pieceW: pieceH,
                            pieceH: pieceW
                        };
                        layout2.count = layout2.cols * layout2.rows;

                        bestLayout = layout1.count >= layout2.count ? layout1 : layout2;
                    }

                    const padding = 40;
                    const canvasW = canvas.width - 2 * padding;
                    const canvasH = canvas.height - 2 * padding;

                    const scale = Math.min(canvasW / palletW, canvasH / palletH);

                    const scaledPalletW = palletW * scale;
                    const scaledPalletH = palletH * scale;

                    const offsetX = (canvas.width - scaledPalletW) / 2;
                    const offsetY = (canvas.height - scaledPalletH) / 2;

                    // Draw Pallet
                    ctx.save();
                    ctx.strokeStyle = '#9ca3af';
                    ctx.fillStyle = '#f9fafb';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(offsetX, offsetY, scaledPalletW, scaledPalletH);
                    ctx.fillRect(offsetX, offsetY, scaledPalletW, scaledPalletH);
                    ctx.restore();

                    // Draw Pieces
                    if (bestLayout.count > 0) {
                        const scaledPieceW = bestLayout.pieceW * scale;
                        const scaledPieceH = bestLayout.pieceH * scale;

                        ctx.save();
                        ctx.strokeStyle = '#3b82f6';
                        ctx.fillStyle = 'rgba(59, 130, 246, 0.3)';
                        ctx.lineWidth = 1.5;

                        for (let r = 0; r < bestLayout.rows; r++) {
                            for (let c = 0; c < bestLayout.cols; c++) {
                                const x = offsetX + c * scaledPieceW;
                                const y = offsetY + r * scaledPieceH;
                                ctx.fillRect(x, y, scaledPieceW, scaledPieceH);
                                if (scaledPieceW > 1 && scaledPieceH > 1) {
                                    ctx.strokeRect(x + 0.5, y + 0.5, scaledPieceW - 1, scaledPieceH - 1);
                                } else {
                                    ctx.strokeRect(x, y, scaledPieceW, scaledPieceH);
                                }
                            }
                        }
                        ctx.restore();
                    }

                    // Draw Dimensions
                    this.drawDimensionLine(ctx, offsetX, offsetY + scaledPalletH + 5, offsetX + scaledPalletW, offsetY + scaledPalletH + 5, `${(palletW / 25.4).toFixed(1)}"`, false);
                    this.drawDimensionLine(ctx, offsetX - 5, offsetY, offsetX - 5, offsetY + scaledPalletH, `${(palletH / 25.4).toFixed(1)}"`, true);
                },
                drawCollectiveBoxLayout(ctx, box, foldedPiece) {
                    const canvas = ctx.canvas;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    const { largo: boxL, ancho: boxW, alto: boxH } = box;
                    const { foldedL: pieceL, foldedH: pieceH, pieceThickness } = foldedPiece;

                    if (!boxL || !boxW || !boxH || !pieceL || !pieceH || !pieceThickness) return;

                    // La dimensi√≥n de apilamiento es donde se divide por el espesor (pieceThickness)
                    const stackingDim = box.finalFitDim === 'largo' ? boxL : boxW;
                    const baseDim = box.finalFitDim === 'largo' ? boxW : boxL;

                    const capacity = Math.floor(stackingDim / pieceThickness);
                    if (capacity === 0) return;

                    const padding = 20;
                    const canvasW = canvas.width - 2 * padding;
                    const canvasH = canvas.height - 2 * padding;

                    // Se escala la base y la dimensi√≥n de apilamiento para el dibujo 2D (vista lateral)
                    const scale = Math.min(canvasW / baseDim, canvasH / stackingDim);
                    const scaledBoxBase = baseDim * scale;
                    const scaledBoxStack = stackingDim * scale;

                    const offsetX = (canvas.width - scaledBoxBase) / 2;
                    const offsetY = (canvas.height - scaledBoxStack) / 2;

                    ctx.save();
                    ctx.strokeStyle = '#9ca3af';
                    ctx.fillStyle = '#f9fafb';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(offsetX, offsetY, scaledBoxBase, scaledBoxStack);
                    ctx.fillRect(offsetX, offsetY, scaledBoxBase, scaledBoxStack);
                    ctx.restore();

                    const scaledPieceThickness = pieceThickness * scale;

                    ctx.save();
                    ctx.strokeStyle = '#2563eb';
                    ctx.fillStyle = 'rgba(59, 130, 246, 0.3)';
                    ctx.lineWidth = 1;
                    for (let i = 0; i < capacity; i++) {
                        const x = offsetX;
                        const y = offsetY + i * scaledPieceThickness;
                        if (y + scaledPieceThickness > offsetY + scaledBoxStack + 0.1) break;
                        ctx.fillRect(x, y, scaledBoxBase, scaledPieceThickness);
                        ctx.strokeRect(x + 0.5, y + 0.5, scaledBoxBase - 1, scaledPieceThickness - 1);
                    }
                    ctx.restore();

                    this.drawDimensionLine(ctx, offsetX, offsetY + scaledBoxStack + 5, offsetX + scaledBoxBase, offsetY + scaledBoxStack + 5, `${baseDim} mm (W/L)`, false);
                    this.drawDimensionLine(ctx, offsetX - 5, offsetY, offsetX - 5, offsetY + scaledBoxStack, `${stackingDim} mm (H)`, true);
                },
                showSettingsModal() {
                    this.populateSettingsForm();
                    DOM.settings.overlay.classList.remove('hidden');
                    void DOM.settings.container.offsetWidth;
                    DOM.settings.container.classList.remove('scale-95', 'opacity-0');
                },
                hideSettingsModal() {
                    DOM.settings.container.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => DOM.settings.overlay.classList.add('hidden'), 300);
                },
                populateSettingsForm() {
                    const createInputGroup = (machine) => `<div class="flex gap-2 mt-2"><div class="flex-1"><label class="block text-xs text-gray-500">Ancho M√°x.</label><input type="text" inputmode="decimal" value="${machine.maxWidth || ''}" class="w-full p-1 border rounded-md text-sm"></div><div class="flex-1"><label class="block text-xs text-gray-500">Alto M√°x.</label><input type="text" inputmode="decimal" value="${machine.maxHeight || ''}" class="w-full p-1 border rounded-md text-sm"></div><div class="flex-1"><label class="block text-xs text-gray-500">Ancho M√≠n.</label><input type="text" inputmode="decimal" value="${machine.minWidth || ''}" class="w-full p-1 border rounded-md text-sm"></div><div class="flex-1"><label class="block text-xs text-gray-500">Alto M√≠n.</label><input type="text" inputmode="decimal" value="${machine.minHeight || ''}" class="w-full p-1 border rounded-md text-sm"></div></div>`;
                    DOM.settings.dieCutterContainer.innerHTML = PROCESS_MACHINES.DIE_CUTTERS.map(m => `<div class="p-3 bg-gray-50 rounded-lg" data-machine-name="${m.name}" data-machine-type="DIE_CUTTERS"><p class="font-semibold">${m.name}</p>${createInputGroup(m)}</div>`).join('');
                    DOM.settings.printerContainer.innerHTML = PROCESS_MACHINES.PRINTERS.map(m => `<div class="p-3 bg-gray-50 rounded-lg" data-machine-name="${m.name}" data-machine-type="PRINTERS"><p class="font-semibold">${m.name}</p>${createInputGroup(m)}</div>`).join('');
                    DOM.settings.standardPalletHeightInput.value = PALLETIZING_SETTINGS.standardPalletHeightCm;
                    this.populatePalletList();
                    this.populateCollectiveBoxList();
                    this.populateFoldingCartonGrammageSettings();

                    DOM.settings.starchAdhesiveInput.value = GENERAL_SETTINGS.adhesives.starch;
                    DOM.settings.pvaAdhesiveInput.value = GENERAL_SETTINGS.adhesives.pva;
                    DOM.settings.mediumFactorE.value = GENERAL_SETTINGS.mediumFactors['Flauta E'];
                    DOM.settings.mediumFactorB.value = GENERAL_SETTINGS.mediumFactors['Flauta B'];
                    DOM.settings.mediumFactorC.value = GENERAL_SETTINGS.mediumFactors['Flauta C'];
                    DOM.settings.autoBottomCompInput.value = GENERAL_SETTINGS.automaticBottomCompensation; // <-- NUEVO
                },
                populateFoldingCartonGrammageSettings() {
                    const container = DOM.settings.foldingCartonGrammageContainer;
                    container.innerHTML = '';
                    for (const paperType in GENERAL_SETTINGS.foldingCartonGrammage) {
                        const paperData = GENERAL_SETTINGS.foldingCartonGrammage[paperType];
                        let inputsHTML = '<div class="grid grid-cols-2 sm:grid-cols-4 gap-x-4 gap-y-2">';

                        const sortedPoints = Object.keys(paperData).map(Number).sort((a, b) => a - b);

                        for (const points of sortedPoints) {
                            inputsHTML += `
                        <div class="flex items-center">
                            <label for="grammage-${paperType}-${points}" class="w-12 text-sm text-gray-600">${points} pts</label>
                            <input type="text" inputmode="decimal" id="grammage-${paperType}-${points}" 
                                   data-paper-type="${paperType}" data-points="${points}"
                                   value="${paperData[points] || 0}" 
                                   class="grammage-input w-full p-1 border rounded-md text-sm">
                        </div>
                    `;
                        }
                        inputsHTML += '</div>';

                        container.innerHTML += `
                    <div class="p-3 bg-white rounded-lg border">
                        <h4 class="font-medium text-gray-800">${paperType.replace('_', ' ')}</h4>
                        ${inputsHTML}
                    </div>
                `;
                    }
                },
                handleSaveSettings() {
                    DOM.settings.form.querySelectorAll('[data-machine-name]').forEach(d => {
                        const name = d.dataset.machineName;
                        const type = d.dataset.machineType;
                        const inputs = d.querySelectorAll('input');
                        const machine = PROCESS_MACHINES[type].find(m => m.name === name);
                        if (machine) {
                            machine.maxWidth = parseFloat(inputs[0].value) || machine.maxWidth;
                            machine.maxHeight = parseFloat(inputs[1].value) || machine.maxHeight;
                            machine.minWidth = parseFloat(inputs[2].value) || undefined;
                            machine.minHeight = parseFloat(inputs[3].value) || undefined;
                        }
                    });
                    PALLETIZING_SETTINGS.standardPalletHeightCm = parseFloat(DOM.settings.standardPalletHeightInput.value) || 15;

                    GENERAL_SETTINGS.adhesives.starch = parseFloat(DOM.settings.starchAdhesiveInput.value) || 18;
                    GENERAL_SETTINGS.adhesives.pva = parseFloat(DOM.settings.pvaAdhesiveInput.value) || 26;
                    GENERAL_SETTINGS.mediumFactors['Flauta E'] = parseFloat(DOM.settings.mediumFactorE.value) || 1.32;
                    GENERAL_SETTINGS.mediumFactors['Flauta B'] = parseFloat(DOM.settings.mediumFactorB.value) || 1.35;
                    GENERAL_SETTINGS.mediumFactors['Flauta C'] = parseFloat(DOM.settings.mediumFactorC.value) || 1.48;

                    GENERAL_SETTINGS.automaticBottomCompensation = parseFloat(DOM.settings.autoBottomCompInput.value) || 2.5; // <-- NUEVO

                    DOM.settings.foldingCartonGrammageContainer.querySelectorAll('.grammage-input').forEach(input => {
                        const paperType = input.dataset.paperType;
                        const points = input.dataset.points;
                        const value = parseFloat(input.value);
                        if (paperType && points && !isNaN(value)) {
                            if (!GENERAL_SETTINGS.foldingCartonGrammage[paperType]) {
                                GENERAL_SETTINGS.foldingCartonGrammage[paperType] = {};
                            }
                            GENERAL_SETTINGS.foldingCartonGrammage[paperType][points] = value;
                        }
                    });

                    saveSettingsToLocalStorage();
                    UI.showToast("Ajustes guardados.");
                    UI.hideSettingsModal();
                },
                showHistoryModal() {
                    this.populateHistoryList();
                    DOM.history.overlay.classList.remove('hidden');
                    void DOM.history.container.offsetWidth;
                    DOM.history.container.classList.remove('scale-95', 'opacity-0');
                },
                hideHistoryModal() {
                    DOM.history.container.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => DOM.history.overlay.classList.add('hidden'), 300);
                },
                populateHistoryList() {
                    DOM.history.listContainer.innerHTML = '';
                    if (state.history.length === 0) {
                        DOM.history.listContainer.innerHTML = `<p class="text-center text-gray-500 py-4">No hay c√°lculos guardados.</p>`;
                        return;
                    }
                    state.history.forEach(entry => {
                        const date = new Date(entry.timestamp).toLocaleString('es-MX', { dateStyle: 'short', timeStyle: 'short' });
                        const itemEl = document.createElement('div');
                        itemEl.className = 'p-3 bg-white rounded-lg border hover:bg-gray-50 cursor-pointer';
                        itemEl.dataset.folio = entry.folio;
                        itemEl.innerHTML = `<div class="flex justify-between items-center"><div><p class="font-bold text-blue-600">Folio: ${entry.folio}</p><p class="text-sm text-gray-700">${entry.cliente || 'Sin cliente'}</p></div><p class="text-xs text-gray-500">${date}</p></div>`;
                        DOM.history.listContainer.appendChild(itemEl);
                    });
                },
                showToast(message, isError = false) {
                    DOM.toast.message.textContent = message;
                    DOM.toast.el.classList.toggle('bg-red-600', isError);
                    DOM.toast.el.classList.toggle('bg-green-600', !isError);
                    DOM.toast.el.classList.remove('opacity-0', 'translate-y-2');
                    setTimeout(() => {
                        DOM.toast.el.classList.add('opacity-0', 'translate-y-2');
                    }, 3000);
                },
                showPalletizeModal() {
                    this.populatePalletDropdowns();
                    DOM.palletize.resultsContainer.classList.add('hidden');
                    DOM.palletize.overlay.classList.remove('hidden');
                    void DOM.palletize.container.offsetWidth;
                    DOM.palletize.container.classList.remove('scale-95', 'opacity-0');
                },
                hidePalletizeModal() {
                    DOM.palletize.container.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => {
                        DOM.palletize.overlay.classList.add('hidden');
                        DOM.palletize.palletCtx.clearRect(0, 0, DOM.palletize.palletCanvas.width, DOM.palletize.palletCanvas.height);
                    }, 300);
                },
                showBoxOptionsModal(boxes) {
                    const listEl = DOM.boxOptions.list;
                    listEl.innerHTML = '';
                    if (!boxes || boxes.length === 0) {
                        listEl.innerHTML = '<p class="text-center text-gray-500">No hay otras opciones compatibles.</p>';
                    } else {
                        const boxHtml = boxes.map(box => {
                            // Extraer pesos para la lista de opciones
                            const { emptyBoxWeightKg, piecesNetWeightKg, totalGrossWeightKg } = box.weightData;

                            return `
                        <div class="p-3 bg-white rounded-lg border hover:bg-gray-50">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-bold text-blue-600">${box.material}</p>
                                    <p class="text-sm text-gray-700">${box.largo} x ${box.ancho} x ${box.alto} mm</p>
                                    <p class="text-xs text-gray-500 mt-1">Desperdicio de √°rea: ${box.waste.toFixed(2)} mm¬≤</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-2xl font-bold text-blue-600">${box.capacity}</p>
                                    <p class="text-xs text-gray-600 -mt-1">piezas/caja</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2 mt-2 text-xs text-center border-t pt-2">
                                <div><p class="text-gray-600">Peso Caja Vac√≠a</p><p class="font-bold">${emptyBoxWeightKg.toFixed(3)} kg</p></div>
                                <div><p class="text-gray-600">Peso Piezas Neto</p><p class="font-bold">${piecesNetWeightKg.toFixed(3)} kg</p></div>
                                <div><p class="font-bold text-indigo-700">TOTAL</p><p class="font-extrabold text-indigo-600">${totalGrossWeightKg.toFixed(3)} kg</p></div>
                            </div>
                        </div>
                    `;
                        }).join('');
                        listEl.innerHTML = boxHtml;
                    }

                    DOM.boxOptions.overlay.classList.remove('hidden');
                    void DOM.boxOptions.container.offsetWidth; // Trigger reflow
                    DOM.boxOptions.container.classList.remove('scale-95', 'opacity-0');
                },
                hideBoxOptionsModal() {
                    DOM.boxOptions.container.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => DOM.boxOptions.overlay.classList.add('hidden'), 300);
                },
                populatePalletDropdowns() {
                    DOM.palletize.palletSize.innerHTML = PALLETIZING_SETTINGS.pallets.map(p => {
                        const value = `${p.widthIn * 25.4}x${p.heightIn * 25.4}`;
                        return `<option value="${value}">${p.name}</option>`;
                    }).join('');
                },
                populatePalletList() {
                    DOM.settings.palletListContainer.innerHTML = '<p class="font-semibold text-gray-700 mb-2">Tarimas Disponibles</p>';
                    PALLETIZING_SETTINGS.pallets.forEach(p => {
                        const palletEl = document.createElement('div');
                        palletEl.className = 'flex justify-between items-center text-sm p-2 bg-white rounded';
                        palletEl.innerHTML = `<span>${p.name} (${p.widthIn}" x ${p.heightIn}")</span><button data-id="${p.id}" class="text-red-500 hover:text-red-700 remove-pallet-btn">Eliminar</button>`;
                        DOM.settings.palletListContainer.appendChild(palletEl);
                    });
                },
                populateCollectiveBoxList() {
                    const container = DOM.settings.collectiveBoxListContainer;
                    container.innerHTML = '';
                    if (COLLECTIVE_BOXES.length === 0) {
                        container.innerHTML = '<p class="text-sm text-gray-500 p-2">No hay cajas definidas.</p>';
                        return;
                    }

                    COLLECTIVE_BOXES.sort((a, b) => a.material - b.material).forEach(box => {
                        const boxEl = document.createElement('div');
                        boxEl.className = 'flex justify-between items-center text-sm p-2 bg-white rounded shadow-sm';
                        boxEl.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-800">${box.material}</p>
                        <p class="text-xs text-gray-500">${box.largo}x${box.ancho}x${box.alto}mm | Flauta ${box.flauta} | ECT ${box.ect}</p>
                    </div>
                    <button data-material="${box.material}" class="remove-box-btn text-red-500 hover:text-red-700 font-medium text-xs bg-red-100 hover:bg-red-200 px-2 py-1 rounded">ELIMINAR</button>
                `;
                        container.appendChild(boxEl);
                    });
                }
            };

            // --- MANEJADORES DE EVENTOS Y L√ìGICA PRINCIPAL ---
            function runCalculation() {
                const button = DOM.submitBtn;
                button.disabled = true;
                button.innerHTML = `<div class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle><path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75" fill="currentColor"></path></svg>Calculando...</div>`;

                setTimeout(() => {
                    const resultsData = Calculator.getOptimizedResults();
                    if (resultsData) {
                        UI.updateResults(resultsData);
                    }
                    button.disabled = false;
                    button.innerHTML = 'Calcular';
                }, 50);
            }

            function handleMaterialChange() {
                const selectedMaterial = DOM.inputs.material.value;
                const isMicro = selectedMaterial === 'microcorrugado';
                const isPlegadizo = selectedMaterial === 'plegadizo';

                DOM.materialOptions.fluteContainer.classList.toggle('hidden', !isMicro);
                DOM.materialOptions.ectContainer.classList.toggle('hidden', !isMicro);
                DOM.materialOptions.foldingCartonTypeContainer.classList.toggle('hidden', !isPlegadizo);
                DOM.materialOptions.foldingCartonWeightContainer.classList.toggle('hidden', !isPlegadizo);
                DOM.plegadizoBundleContainer.classList.toggle('hidden', !isPlegadizo);

                if (!isMicro) {
                    DOM.inputs.ectCheckbox.checked = false;
                    DOM.ectValueContainer.classList.add('hidden');
                }
                if (!isPlegadizo) {
                    DOM.inputs.usePlegadizoBundles.checked = false;
                }
            }

            function updateFoldedPieceInfo() {
                const isGluing = DOM.inputs.gluing.checked;

                if (!isGluing) {
                    DOM.foldedPieceInfo.container.classList.add('hidden');
                    return;
                }

                const unit = DOM.inputs.unit.value;
                const cutWidth = parseFloat(DOM.inputs.cutWidth.value);
                const cutHeight = parseFloat(DOM.inputs.cutHeight.value);
                const glueFlapWidth = parseFloat(DOM.inputs.glueFlapWidth.value);

                if (isNaN(cutWidth) || isNaN(cutHeight) || isNaN(glueFlapWidth) || cutWidth <= 0 || cutHeight <= 0 || glueFlapWidth < 0) {
                    DOM.foldedPieceInfo.container.classList.add('hidden');
                    return;
                }

                const originalPieceW_mm = toMM(cutWidth, unit);
                const originalPieceH_mm = toMM(cutHeight, unit);
                const glueFlapW_mm = toMM(glueFlapWidth, unit);

                let foldedW, foldedH;

                // Dimensi√≥n del cuerpo doblado (Largo/2 o Ancho/2, seg√∫n la orientaci√≥n)
                if (originalPieceH_mm >= originalPieceW_mm) {
                    foldedH = (originalPieceH_mm - glueFlapW_mm) / 2;
                    foldedW = originalPieceW_mm;
                } else {
                    foldedW = (originalPieceW_mm - glueFlapW_mm) / 2;
                    foldedH = originalPieceH_mm;
                }

                let nominalThickness = 0;
                const material = DOM.inputs.material.value;
                const isAutomaticBottom = DOM.inputs.isAutomaticBottom.checked;

                if (material === 'microcorrugado') {
                    const flute = DOM.inputs.flute.value;
                    nominalThickness = PALLETIZING_SETTINGS.MATERIAL_THICKNESS.FLUTES[flute] || 0;
                } else {
                    const points = parseFloat(DOM.inputs.foldingCartonWeight.value);
                    if (!isNaN(points)) {
                        nominalThickness = points * PALLETIZING_SETTINGS.MATERIAL_THICKNESS.POINTS_TO_MM;
                    }
                }

                let finalThickness = 0;

                if (nominalThickness > 0) {
                    if (isAutomaticBottom) {
                        // Fondo Autom√°tico: 5 capas nominales + Compensaci√≥n Fija
                        const layers = 5;
                        const compensation = GENERAL_SETTINGS.automaticBottomCompensation || 0;
                        finalThickness = (nominalThickness * layers) + compensation;
                    } else {
                        // Pegado Lineal: 2 capas nominales + 50% de holgura
                        const layers = 2;
                        const holgura = nominalThickness * 0.5;
                        finalThickness = (nominalThickness * layers) + holgura;
                    }
                }

                if (foldedW > 0 && foldedH > 0 && finalThickness > 0) {
                    DOM.foldedPieceInfo.size.textContent = `${foldedW.toFixed(2)} mm x ${foldedH.toFixed(2)} mm`;
                    DOM.foldedPieceInfo.thickness.textContent = `${finalThickness.toFixed(2)} mm`;
                    DOM.foldedPieceInfo.container.classList.remove('hidden');
                } else {
                    DOM.foldedPieceInfo.container.classList.add('hidden');
                }
            }

            function updateLinerDefaults() {
                const ectValue = DOM.inputs.ectValue.value;
                let liners = { ext: '', med: '', int: '' };

                switch (ectValue) {
                    case '29':
                        liners = { ext: '240', med: '125', int: '135' };
                        break;
                    case '32':
                        liners = { ext: '240', med: '160', int: '180' };
                        break;
                    case '26':
                    case '40':
                    default:
                        break;
                }
                DOM.inputs.linerExt.value = liners.ext;
                DOM.inputs.medium.value = liners.med;
                DOM.inputs.linerInt.value = liners.int;
            }

            function handleSaveCalculation() {
                const folio = DOM.modal.folioInput.value.trim();
                const cliente = DOM.modal.clienteInput.value.trim();
                if (!folio) {
                    UI.showToast("El Folio es obligatorio.", true);
                    DOM.modal.folioInput.classList.add('invalid-input');
                    return;
                }
                DOM.modal.folioInput.classList.remove('invalid-input');
                if (!state.lastValidResults) {
                    UI.showToast("No hay resultados para guardar.", true);
                    return;
                }
                const existingIndex = state.history.findIndex(item => item.folio === folio);
                const newEntry = { folio, cliente, timestamp: new Date().toISOString(), results: state.lastValidResults };
                if (existingIndex > -1) {
                    state.history[existingIndex] = newEntry;
                    UI.showToast(`Folio "${folio}" actualizado.`);
                } else {
                    state.history.push(newEntry);
                    UI.showToast(`Folio "${folio}" guardado.`);
                }
                state.history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                saveHistoryToLocalStorage();
            }

            function handleLoadFromHistory(event) {
                const folioElement = event.target.closest('[data-folio]');
                if (!folioElement) return;
                const folio = folioElement.dataset.folio;
                const entry = state.history.find(item => item.folio === folio);
                UI.displaySavedCalculation(entry);
            }

            function handleClearHistory() {
                state.history = [];
                saveHistoryToLocalStorage();
                UI.populateHistoryList();
                UI.showToast("Historial borrado.");
            }

            function calculateColumnarFit(palletW, palletH, itemW, itemH) {
                if (itemW <= 0 || itemH <= 0) return 0;
                let maxCount = 0;

                // Try primary orientation
                for (let i = 0; i <= Math.floor(palletW / itemW); i++) {
                    let currentCount = i * Math.floor(palletH / itemH);
                    const remainingW = palletW - (i * itemW);
                    if (remainingW > 0) {
                        currentCount += Math.floor(remainingW / itemH) * Math.floor(palletH / itemW);
                    }
                    if (currentCount > maxCount) maxCount = currentCount;
                }
                // Try rotated orientation
                for (let i = 0; i <= Math.floor(palletW / itemH); i++) {
                    let currentCount = i * Math.floor(palletH / itemW);
                    const remainingW = palletW - (i * itemH);
                    if (remainingW > 0) {
                        currentCount += Math.floor(remainingW / itemW) * Math.floor(palletH / itemH);
                    }
                    if (currentCount > maxCount) maxCount = currentCount;
                }
                return maxCount;
            }

            function handlePalletizeCalculation() {
                if (!state.lastValidResults) return;
                const pattern = DOM.palletize.stackingPattern.value;
                const palletResult = Calculator.getPalletizeResults(state.lastValidResults, pattern);

                if (!palletResult) {
                    UI.showToast("No caben items en la tarima con la altura especificada.", true);
                    DOM.palletize.piecesPerLayerResult.textContent = 0;
                    DOM.palletize.layersPerPalletResult.textContent = 0;
                    DOM.palletize.totalPiecesResult.textContent = 0;
                    DOM.palletize.materialHeightResult.textContent = `0 cm`;
                    DOM.palletize.finalHeightResult.textContent = `${PALLETIZING_SETTINGS.standardPalletHeightCm.toFixed(1)} cm`;
                    DOM.palletize.resultsContainer.classList.remove('hidden');
                    const [palletW, palletH] = DOM.palletize.palletSize.value.split('x').map(Number);
                    UI.drawPalletLayout(palletW, palletH, 0, 0);
                    return;
                }

                DOM.palletize.palletizingModeTitle.textContent = `Acomodo de ${palletResult.mode}`;
                if (palletResult.bundleInfo) {
                    DOM.palletize.palletizingModeTitle.textContent += ` - ${palletResult.bundleInfo}`;
                }
                DOM.palletize.piecesPerLayerLabel.textContent = palletResult.itemsPerLayerLabel;
                DOM.palletize.piecesPerLayerResult.textContent = palletResult.piecesPerLayer.toLocaleString('es-MX');
                DOM.palletize.layersPerPalletResult.textContent = palletResult.layersPerPallet.toLocaleString('es-MX');
                DOM.palletize.totalPiecesResult.textContent = palletResult.totalPieces.toLocaleString('es-MX');
                DOM.palletize.materialHeightResult.textContent = `${palletResult.materialHeightCm.toFixed(1)} cm`;
                DOM.palletize.finalHeightResult.textContent = `${palletResult.finalHeightCm.toFixed(1)} cm`;

                DOM.palletize.resultsContainer.classList.remove('hidden');
                UI.drawPalletLayout(palletResult.palletW_mm, palletResult.palletH_mm, palletResult.itemW_mm, palletResult.itemH_mm);
            }

            function toMM(value, unit) {
                if (unit === 'cm') return value * 10;
                if (unit === 'in') return value * 25.4;
                return value;
            }

            function setupEventListeners() {
                DOM.form.addEventListener('submit', (e) => { e.preventDefault(); runCalculation(); });
                DOM.inputs.material.addEventListener('change', handleMaterialChange);
                DOM.inputs.calculationModeToggle.addEventListener('change', (e) => {
                    DOM.customSheetContainer.classList.toggle('hidden', !e.target.checked);
                });
                DOM.inputs.gluing.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    DOM.gluingOptionsContainer.classList.toggle('hidden', !isChecked);
                    if (isChecked) {
                        DOM.inputs.useCollectiveBox.checked = true;
                    } else {
                        DOM.inputs.isAutomaticBottom.checked = false;
                    }
                    updateFoldedPieceInfo();
                });

                // Listener para Fondo Autom√°tico: si se activa, se asegura que Pegado est√© activo.
                DOM.inputs.isAutomaticBottom.addEventListener('change', (e) => {
                    if (e.target.checked && !DOM.inputs.gluing.checked) {
                        DOM.inputs.gluing.checked = true;
                        DOM.inputs.gluing.dispatchEvent(new Event('change'));
                    }
                    updateFoldedPieceInfo();
                });

                DOM.inputs.ectCheckbox.addEventListener('change', (e) => {
                    DOM.ectValueContainer.classList.toggle('hidden', !e.target.checked);
                });
                DOM.inputs.ectValue.addEventListener('change', updateLinerDefaults);

                DOM.modal.rankingContainer.addEventListener('click', (e) => {
                    if (state.lastValidResults && state.lastValidResults.isCustom) return;
                    const item = e.target.closest('[data-machine-index]');
                    if (item) UI.updatePreview(parseInt(item.dataset.machineIndex, 10));
                });
                DOM.resetBtn.addEventListener('click', () => UI.reset());
                DOM.modal.printBtn.addEventListener('click', () => window.print());
                DOM.modal.emailBtn.addEventListener('click', () => {
                    if (!state.lastValidResults) {
                        UI.showToast("No hay resultados para enviar.", true);
                        return;
                    }
                    const folio = DOM.modal.folioInput.value.trim() || 'N/A';
                    const cliente = DOM.modal.clienteInput.value.trim() || 'N/A';
                    const selectedMachineIndex = parseInt(DOM.modal.rankingContainer.querySelector('.selected-machine')?.dataset.machineIndex || '0', 10);
                    const data = state.lastValidResults.isCustom ? state.lastValidResults : state.lastValidResults.rankedMachines[selectedMachineIndex];

                    if (!data) return;

                    const subject = `Resultados de Optimizaci√≥n - Folio: ${folio}`;
                    let body = `Resumen de C√°lculo para Cliente: ${cliente}\n`;
                    body += `Folio: ${folio}\n\n`;
                    body += `--- RESULTADOS CLAVE ---\n`;
                    if (state.lastValidResults.isCustom) {
                        body += `Modo: Pliego Manual\n`;
                        body += `Pliego: ${data.drawing.sheetW.toFixed(1)} x ${data.drawing.sheetH.toFixed(1)} ${data.drawing.unit}\n`;
                        body += `Cortes por Pliego: ${data.cuts}\n`;
                    } else {
                        body += `Modo: √ìptimo\n`;
                        body += `Impresora √ìptima: ${data.name}\n`;
                        body += `Pliego Sugerido: ${data.drawing.suggestedSheetW.toFixed(1)} x ${data.drawing.suggestedSheetH.toFixed(1)} ${data.drawing.unit}\n`;
                        body += `Cortes por Pliego: ${data.cuts}\n`;
                        body += `Aprovechamiento: ${data.aprovechamiento.toFixed(1)}%\n`;
                    }

                    body += `\n--- RUTA DE PROCESO ---\n`;
                    const route = Calculator.generateProcessRoute(data, state.lastValidResults.userInputs);
                    route.forEach((step, i) => {
                        body += `${i + 1}. ${step.process}: ${step.machine}\n`;
                    });

                    if (data.pieceGrossWeightKg) {
                        body += `\n--- DETALLES DE PESO ---\n`;
                        body += `Peso por Pieza: ${data.pieceGrossWeightKg.toFixed(4)} kg\n`;
                    }

                    if (data.collectiveBoxData?.best) {
                        const box = data.collectiveBoxData.best;
                        const totalWeight = box.weightData?.totalGrossWeightKg;
                        body += `\n--- CAJA COLECTIVA ---\n`;
                        body += `Material: ${box.material}\n`;
                        body += `Dimensiones: ${box.largo}x${box.ancho}x${box.alto} mm\n`;
                        body += `Capacidad: ${box.capacity} piezas/caja\n`;
                        if (totalWeight) {
                            body += `Peso Total Bruto: ${totalWeight.toFixed(3)} kg\n`;
                        }
                    }

                    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                });
                DOM.modal.closeBtn.addEventListener('click', () => UI.hideModal());
                DOM.modal.overlay.addEventListener('click', (e) => { if (e.target === e.currentTarget) UI.hideModal(); });
                DOM.modal.saveBtn.addEventListener('click', handleSaveCalculation);
                DOM.modal.exportPngBtn.addEventListener('click', exportResultsAsPNG);
                DOM.history.btn.addEventListener('click', () => UI.showHistoryModal());
                DOM.history.closeBtn.addEventListener('click', () => UI.hideHistoryModal());
                DOM.history.overlay.addEventListener('click', (e) => { if (e.target === e.currentTarget) UI.hideHistoryModal(); });
                DOM.history.listContainer.addEventListener('click', handleLoadFromHistory);
                DOM.history.clearBtn.addEventListener('click', handleClearHistory);
                DOM.settings.btn.addEventListener('click', () => UI.showSettingsModal());
                DOM.settings.cancelBtn.addEventListener('click', () => UI.hideSettingsModal());
                DOM.settings.overlay.addEventListener('click', (e) => { if (e.target === e.currentTarget) UI.hideSettingsModal(); });
                DOM.settings.form.addEventListener('submit', (e) => { e.preventDefault(); UI.handleSaveSettings(); });
                DOM.settings.restoreDefaultsBtn.addEventListener('click', () => {
                    PROCESS_MACHINES = JSON.parse(JSON.stringify(DEFAULT_PROCESS_MACHINES));
                    COLLECTIVE_BOXES = JSON.parse(JSON.stringify(DEFAULT_COLLECTIVE_BOXES));
                    PALLETIZING_SETTINGS.standardPalletHeightCm = 15;
                    PALLETIZING_SETTINGS.pallets = [
                        { name: '40" x 48"', widthIn: 40, heightIn: 48, id: 'p1' },
                        { name: '40" x 52"', widthIn: 40, heightIn: 52, id: 'p2' }
                    ];
                    GENERAL_SETTINGS = JSON.parse(JSON.stringify(DEFAULT_GENERAL_SETTINGS));

                    saveSettingsToLocalStorage();
                    UI.populateSettingsForm();
                    UI.showToast("Ajustes restaurados.");
                });

                // Palletize modal listeners
                DOM.modal.palletizeBtn.addEventListener('click', () => UI.showPalletizeModal());
                DOM.palletize.closeBtn.addEventListener('click', () => UI.hidePalletizeModal());
                DOM.palletize.overlay.addEventListener('click', (e) => { if (e.target === e.currentTarget) UI.hidePalletizeModal(); });
                DOM.palletize.calculateBtn.addEventListener('click', handlePalletizeCalculation);

                // Box Options modal listeners
                DOM.boxOptions.closeBtn.addEventListener('click', () => UI.hideBoxOptionsModal());
                DOM.boxOptions.overlay.addEventListener('click', (e) => { if (e.target === e.currentTarget) UI.hideBoxOptionsModal(); });

                // Pallet settings listeners
                DOM.settings.addPalletBtn.addEventListener('click', () => {
                    const name = DOM.settings.newPalletName.value.trim();
                    const width = parseFloat(DOM.settings.newPalletWidth.value);
                    const height = parseFloat(DOM.settings.newPalletHeight.value);
                    if (name && width > 0 && height > 0) {
                        PALLETIZING_SETTINGS.pallets.push({ name, widthIn: width, heightIn: height, id: `p${Date.now()}` });
                        UI.populatePalletList();
                        DOM.settings.newPalletName.value = '';
                        DOM.settings.newPalletWidth.value = '';
                        DOM.settings.newPalletHeight.value = '';
                    } else {
                        UI.showToast('Por favor, completa todos los campos de la nueva tarima.', true);
                    }
                });

                DOM.settings.palletListContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-pallet-btn')) {
                        const idToRemove = e.target.dataset.id;
                        PALLETIZING_SETTINGS.pallets = PALLETIZING_SETTINGS.pallets.filter(p => p.id !== idToRemove);
                        UI.populatePalletList();
                    }
                });

                // Collective Box settings listeners
                DOM.settings.addBoxBtn.addEventListener('click', () => {
                    const material = parseInt(DOM.settings.newBoxMaterial.value, 10);
                    const largo = parseFloat(DOM.settings.newBoxLargo.value);
                    const ancho = parseFloat(DOM.settings.newBoxAncho.value);
                    const alto = parseFloat(DOM.settings.newBoxAlto.value);
                    const flauta = DOM.settings.newBoxFlauta.value;
                    const ect = parseInt(DOM.settings.newBoxEct.value, 10);

                    if (!material || !largo || !ancho || !alto || !flauta || !ect) {
                        UI.showToast('Todos los campos son obligatorios para la caja.', true);
                        return;
                    }
                    if (COLLECTIVE_BOXES.some(b => b.material === material)) {
                        UI.showToast('El n√∫mero de material ya existe.', true);
                        return;
                    }

                    COLLECTIVE_BOXES.push({ material, largo, ancho, alto, flauta, ect });
                    saveSettingsToLocalStorage();
                    UI.populateCollectiveBoxList();
                    UI.showToast('Caja colectiva a√±adida.');

                    DOM.settings.newBoxMaterial.value = '';
                    DOM.settings.newBoxLargo.value = '';
                    DOM.settings.newBoxAncho.value = '';
                    DOM.settings.newBoxAlto.value = '';
                    DOM.settings.newBoxEct.value = '';
                });

                DOM.settings.collectiveBoxListContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-box-btn')) {
                        const materialToRemove = parseInt(e.target.dataset.material, 10);
                        COLLECTIVE_BOXES = COLLECTIVE_BOXES.filter(b => b.material !== materialToRemove);
                        saveSettingsToLocalStorage();
                        UI.showToast('Caja eliminada.');
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (!DOM.boxOptions.overlay.classList.contains('hidden')) UI.hideBoxOptionsModal();
                        else if (!DOM.palletize.overlay.classList.contains('hidden')) UI.hidePalletizeModal();
                        else if (!DOM.history.overlay.classList.contains('hidden')) UI.hideHistoryModal();
                        else if (!DOM.settings.overlay.classList.contains('hidden')) UI.hideSettingsModal();
                        else if (!DOM.modal.overlay.classList.contains('hidden')) UI.hideModal();
                    }
                });

                [
                    DOM.inputs.cutWidth, DOM.inputs.cutHeight, DOM.inputs.glueFlapWidth,
                    DOM.inputs.unit, DOM.inputs.material, DOM.inputs.flute,
                    DOM.inputs.foldingCartonWeight
                ].forEach(input => {
                    input.addEventListener('input', updateFoldedPieceInfo);
                    if (input.tagName === 'SELECT') {
                        input.addEventListener('change', updateFoldedPieceInfo);
                    }
                });

                // Agrega el listener de c√°lculo m√°gico a todos los campos de texto que funcionan como n√∫meros
                document.querySelectorAll('input[type="text"][inputmode="decimal"]').forEach(input => {
                    input.addEventListener('blur', handleMagicCalculation);
                    input.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter') {
                            // Previene que el formulario se env√≠e al presionar Enter
                            event.preventDefault();
                            // Dispara la funci√≥n de c√°lculo
                            handleMagicCalculation(event);
                            // Quita el foco del campo actual
                            input.blur();
                        }
                    });
                });
            }

            async function exportResultsAsPNG() {
                if (!state.lastValidResults) {
                    UI.showToast("No hay resultados para exportar.", true);
                    return;
                }

                const canvas = document.createElement('canvas');
                canvas.width = 1200;
                canvas.height = 1800;
                const ctx = canvas.getContext('2d');

                // --- Drawing Helpers ---
                const drawText = (text, x, y, options = {}) => {
                    ctx.fillStyle = options.color || '#1f2937';
                    ctx.font = options.font || '24px Inter';
                    ctx.textAlign = options.align || 'left';
                    ctx.textBaseline = 'top';
                    ctx.fillText(text, x, y);
                };
                const drawSectionTitle = (text, y) => {
                    ctx.fillStyle = '#1e3a8a';
                    ctx.font = 'bold 32px Inter';
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'top';
                    ctx.fillText(text, 50, y);
                    ctx.strokeStyle = '#dbeafe';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(50, y + 45);
                    ctx.lineTo(1150, y + 45);
                    ctx.stroke();
                    return y + 70;
                };

                // 1. Background
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // --- Data Prep ---
                const folio = DOM.modal.folioInput.value.trim() || 'N/A';
                const cliente = DOM.modal.clienteInput.value.trim() || 'N/A';
                const selectedMachineIndex = parseInt(DOM.modal.rankingContainer.querySelector('.selected-machine')?.dataset.machineIndex || '0', 10);
                const results = state.lastValidResults;
                const data = results.isCustom ? results : results.rankedMachines[selectedMachineIndex];
                const inputs = results.userInputs;
                const palletData = results.palletizingResult;
                const boxData = data.collectiveBoxData?.best;

                let y = 60; // Current Y position for drawing

                // 2. Header
                drawText('Reporte de Optimizaci√≥n de Producci√≥n', canvas.width / 2, y, { font: 'bold 44px Inter', color: '#111827', align: 'center' });
                y += 80;
                drawText(`Folio: ${folio}`, 50, y, { font: '28px Inter' });
                drawText(`Cliente: ${cliente}`, canvas.width / 2, y, { font: '28px Inter' });
                y += 60;

                // 3. Resumen
                y = drawSectionTitle('Resumen del Proceso', y);
                const resumenData = [
                    { label: 'M√°quina Optima:', value: data.name || 'N/A' },
                    { label: 'Troqueladora:', value: data.associatedDieCutter || 'N/A' },
                    { label: 'Pliego Sugerido:', value: `${data.drawing.suggestedSheetW.toFixed(1)} x ${data.drawing.suggestedSheetH.toFixed(1)} ${data.drawing.unit}` },
                    { label: 'Cortes por Pliego:', value: `${data.cuts} outs` }
                ];
                resumenData.forEach((item) => {
                    drawText(`${item.label}`, 80, y, { font: '24px Inter', color: '#4b5563' });
                    drawText(`${item.value}`, 400, y, { font: 'bold 24px Inter' });
                    y += 40;
                });
                y += 30;

                // 4. Ruta 
                y = drawSectionTitle('Ruta de Proceso', y);
                const route = Calculator.generateProcessRoute(data, inputs);
                route.forEach(step => {
                    drawText(`‚Ä¢ ${step.process}:`, 80, y, { font: '24px Inter' });
                    drawText(step.machine, 400, y, { font: 'bold 24px Inter' });
                    y += 40;
                });
                y += 30;

                // 5. Material y Pesos
                y = drawSectionTitle('Material y Pesos', y);
                let materialInfo = [
                    { label: 'Material:', value: inputs.material === 'microcorrugado' ? 'Microcorrugado' : 'Plegadizo' },
                ];
                if (inputs.material === 'microcorrugado') {
                    materialInfo.push({ label: 'Flauta:', value: inputs.flute });
                    if (inputs.ectCheckbox && inputs.linerExt && inputs.medium && inputs.linerInt) {
                        materialInfo.push({ label: 'Combinaci√≥n:', value: `${inputs.linerExt} / ${inputs.medium} / ${inputs.linerInt}` });
                    }
                } else {
                    materialInfo.push({ label: 'Gramaje:', value: `${inputs.foldingCartonWeight} pts` });
                }
                materialInfo.push({ label: 'Peso por Pieza (Bruto):', value: data.pieceGrossWeightKg ? `${data.pieceGrossWeightKg.toFixed(4)} kg` : 'N/A' });

                // A√±adir peso total de la caja si est√° disponible
                if (boxData && boxData.weightData) {
                    materialInfo.push({ label: 'Peso Total Caja Bruto:', value: `${boxData.weightData.totalGrossWeightKg.toFixed(3)} kg` });
                }

                materialInfo.forEach(item => {
                    drawText(`${item.label}`, 80, y, { font: '24px Inter', color: '#4b5563' });
                    drawText(item.value, 400, y, { font: 'bold 24px Inter' });
                    y += 40;
                });
                y += 30;

                // 6. Paletizado
                y = drawSectionTitle('Informaci√≥n de Paletizado', y);
                if (palletData) {
                    let palletInfo = [
                        { label: 'Tarima:', value: palletData.palletName },
                        { label: 'Modo:', value: palletData.mode },
                    ];

                    if (palletData.bundleInfo) {
                        palletInfo.push({ label: 'Atado por Flauta:', value: palletData.bundleInfo });
                    }

                    palletInfo.push(
                        { label: palletData.itemsPerLayerLabel, value: palletData.piecesPerLayer.toLocaleString('es-MX') },
                        { label: 'Camas / Tarima:', value: palletData.layersPerPallet.toLocaleString('es-MX') },
                        { label: 'Total Piezas:', value: palletData.totalPieces.toLocaleString('es-MX') },
                        { label: 'Altura Final Material:', value: `${palletData.materialHeightCm.toFixed(1)} cm` },
                        { label: 'Altura Final Total:', value: `${palletData.finalHeightCm.toFixed(1)} cm` }
                    );

                    const initialY = y;
                    let currentY = y;
                    palletInfo.forEach((item, i) => {
                        drawText(`${item.label}`, 80, currentY, { font: '24px Inter', color: '#4b5563' });
                        drawText(item.value, 400, currentY, { font: 'bold 24px Inter' });
                        currentY += 40;
                    });

                    // Draw pallet canvas on the right
                    const tempPalletCanvas = document.createElement('canvas');
                    tempPalletCanvas.width = 450;
                    tempPalletCanvas.height = 400;
                    // Se llama con el contexto y canvas temporales
                    UI.drawPalletLayout(palletData.palletW_mm, palletData.palletH_mm, palletData.itemW_mm, palletData.itemH_mm, tempPalletCanvas, tempPalletCanvas.getContext('2d'));

                    ctx.drawImage(tempPalletCanvas, 650, initialY - 20, 450, 400);

                } else {
                    drawText('No se pudo calcular el paletizado.', 80, y, { font: '24px Inter', color: '#9ca3af' });
                }

                // 7. Footer
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(50, canvas.height - 80);
                ctx.lineTo(1150, canvas.height - 80);
                ctx.stroke();
                const dateString = new Date().toLocaleString('es-MX', { dateStyle: 'long', timeStyle: 'short' });
                drawText(`Reporte generado el ${dateString}`, canvas.width / 2, canvas.height - 50, { font: '20px Inter', color: '#6b7280', align: 'center' });

                // 8. Download
                const link = document.createElement('a');
                link.download = `Reporte_Folio_${folio.replace(/[^a-z0-9]/gi, '_')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }

            // Inicializaci√≥n de la aplicaci√≥n
            loadSettingsFromLocalStorage();
            loadHistoryFromLocalStorage();
            handleMaterialChange();
            setupEventListeners();
            updateLinerDefaults();
        });
    </script>

    <script>
        function showCotizadorModal() {
            document.getElementById('cotizadorModalContainer').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        function hideCotizadorModal() {
            document.getElementById('cotizadorModalContainer').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    </script>
</body>

</html>
